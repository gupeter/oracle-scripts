/*$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*/
/*故障处理记录$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*/
/*$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*/

/***********************************************************************************************/
实时监控脚本
/***********************************************************************************************/
--查询数据库异常等待事件
select inst_id, event,count(*) 
from gv$session
--where status='ACTIVE' and wait_class#<> 6
group by inst_id, event
--having count(*)>9;

--查询某实例上异常等待事件
select event,count(*)
from v$session
--where status='ACTIVE' and wait_class#<> 6
group by event;

--根据等待事件查询进程信息
select username,program,sql_id from v$session where event='&s' order by 1,2,3;

--根据等待事件查询进程信息（汇总）
select username,program,sql_id,count(*) from v$session where event='&s' group by username,program,sql_id order by 4 desc;

--根据sid查询spid
select p.spid from v$session s,v$process p where s.paddr=p.addr and s.sid='&sid';

--根据sid查询spid
select spid from v$process where addr=(select paddr from v$session where sid=&sid);

--根据spid查询sid
select s.sid from v$session s,v$process p where s.paddr=p.addr and p.spid=&spid;

--根据sql_id查询sql语句
select sql_text from v$sqlarea where sql_id='&sqlid';

--根据sql_id查获寻执行计划
select plan_table_output 
from table(dbms_xplan.display_cursor('&sql_id',null));

--根据sql语句查询执行计划
explain plan for
sql语句;
select plan_table_output from table(dbms_xplan.display());+

--根据sql语句查询执行计划
@?/rdbms/admin/utlxplp

--重新编译执行计划
--▲▲XXX为<SQL语句访问的表>
grant select on XXX to system;
revoke select on XXX from system;

--查询并行会话
 select QCSID,count(*)-1  from  v$px_session group by QCSID;

--根据sid、spid、username查找会话信息
col sname for a5;
col pname for a5;
col machine for a25;
col sprogram for a30;
col pprogram for a30;
col event for a40;
set line 800 pagesize 200; 
select s.sid,s.serial#,s.STATUS,s.username sname,nvl(s.sql_id,s.prev_sql_id) sql_id,s.program sprogram,s.event,p.spid,p.username pname,p.program pprogram
from v$session s,v$process p 
where s.paddr=p.addr 
and s.sid=&sid;
--and s.username='&username';
--and p.spid='&spid';

--根据sid、spid、username查询会话信息(含语句)
set line 800 pagesize 200 long 99999; 
col sname for a10;
col pname for a10;
col machine for a15;
col sprogram for a20;
col pprogram for a20;
col event for a40;
select p.spid,p.username pname,p.program,s.username sname,s.status,s.machine,q.sql_text 
from v$process p,v$session s,v$sql q
where p.addr=s.paddr and s.sql_id=q.sql_id 
and s.sid=&sid;
--and s.username='&username';
--and p.spid='&spid';

--查询活动会话信息
set linesize 400 pagesize 200; 
col username for a10;
col machine for a15;
col program for a20;
col event for a40;
select inst_id,sid,serial#,username,status,nvl(sql_id,prev_sql_id),machine,program,event
from gv$session
where status='ACTIVE' and wait_class#<>6
order by inst_id,event asc,nvl(sql_id,prev_sql_id);

--常规终止会话方法
alter system kill session 'sid,serial#';

#杀用户进程(中止操作系统进程)
--▲▲需要确定进程LOCAL=NO（非本地），否则可能导致系统崩溃ps -ef|grep spid
kill -9 spid

--生成查杀僵死进程脚本
select 'kill -9 '||spid from v$process
where addr in
(select addr from v$process where pid<>1
 minus
 select paddr from v$session);

--查询活动实例
select * from v$active_instances;

--查询当前实例信息
col host_name for a12;
set line 400 pagesize 200;
select instance_num--查询当前数据库连接数(RAC)
col INST_ID for 7
col MACHINE for a25
col PROGRAM for a50
col USERNAME for a16
col INST_ID for 9999999
select inst_id,username,machine,program,count(*)  
from gv$session 
group by inst_id,username,machine,program
--having count(*) > 100
order by 4 ;

--查询当前数据库连接数
col MACHINE for a25
col PROGRAM for a50
col USERNAME for a16
select username,machine,program,count(*)  
from v$session 
group by username,machine,program
--having count(*) > 100
order by 4 ;

--查询各节点活动连接数(RAC)
col MACHINE for a25
col PROGRAM for a50
col USERNAME for a16
col INST_ID for 9999999
select inst_id,count(*) from gv$session
where status='ACTIVE'
group by inst_id;

--查询历史最大连接数
select INSTANCE_NUMBER,to_char(BEGIN_TIME,'yyyy-mm-dd hh24:mi') snap_time,round(AVERAGE,0) avg,MAXVAL 
from DBA_HIST_SYSMETRIC_SUMMARY 
where METRIC_NAME='Current Logons Count' and to_char(BEGIN_TIME,'yyyy-mm-dd') in ('2011-01-15','2011-01-16') 
order by 1,2;

--查询库缓存命中率
SELECT round(sum(pinhits) / sum(pins) * 100,6)||'|'||to_char(sysdate, 'YYYY-MM-DD HH24:MI:SS') from v$librarycache;

--查询当前实例信息
select instance_number,instance_name,host_name,version,status from v$instance;

--查询当前数据库信息
select name,created,log_mode,open_mode from v$database;

--查询当前数据库是否为集群
show parameters CLUSTER;

#当前数据库非缺省初始化参数配置
cd $ORACLE_HOME/dbs
more initszdb1.ora
more /dev/rsz_spfile

#Oracle集群服务运行及状态检查
crs_stat -t
lsnrctl status listener_s1

--将用户加入免kill列表 FILTER_TAB
insert into xj_exp_data.filter_program values (upper('用户名'),'2','相关描述信息');
commit;

--将程序加入免kill列表
insert into xj_exp_data.filter_program values (upper('程序名'),'1','相关描述信息');
commit;

--禁用用户或程序的免kill过滤
update xj_exp_data.filter_program set filter_type='0' where FILTER_STR=upper('用户名或者程序名');
commit;

--查询用户免杀状态
select FILTER_STR,filter_type from xj_exp_data.filter_program where FILTER_STR=upper('用户名或者程序名');

--长时间锁定进程（某时间段内）
alter session set nls_date_format='yyyy-mm-dd hh24:mi:ss';
set linesize 1400 pagesize 1000
select username||';'||PROGRAM||';'||SQL_TEXT||';'||object_name||';'||to_char(ctime)||';'||COLLECT_DATE from
(select username,PROGRAM,SQL_TEXT,nvl((select object_name from dba_objects where object_id=id1 and type='TM'),null) object_name,ctime,COLLECT_DATE
from xj_exp_data.session_lock_longops
where (collect_date between to_date('20100309 8','yyyymmdd hh24') and to_date('20100309 10','yyyymmdd hh24')) and kill_status='1')
order by username,PROGRAM;

--长时间锁定进程汇总（某时间段内）
set linesize 1400 pagesize 1000
select username||'^'||PROGRAM||'^'||SQL_TEXT||'^'||object_name||'^'||to_char(max(ctime)) ctime from
(select username,PROGRAM,SQL_TEXT,nvl((select object_name from dba_objects where object_id=id1 and type='TM'),null) object_name,ctime
from xj_exp_data.session_lock_longops
where collect_date between to_date('20100326 0','yyyymmdd hh24') and sysdate and kill_status='1' and SQL_TEXT is not null) 
group by username,PROGRAM,SQL_TEXT,object_name
order by username,PROGRAM;

--查询分区表记录数
select count(*) from YYDG.SP_WORKF_COMM_HIS partition(SP_WORKF_COMM_HIS_200912);

--查询某个表的统计分析情况
select table_name,tablespace_name,num_rows,LAST_ANALYZED from dba_tables where table_name='TAB_TEST';

--对某个表做统计收集
exec DBMS_STATS.GATHER_TABLE_STATS(ownname=>'T_TEST',tabname=>'TAB_TEST',ESTIMATE_PERCENT=>5,method_opt=>'for all columns size 1',cascade=>true,force=>true,degree=>8);
exec DBMS_STATS.GATHER_TABLE_STATS(ownname=>'HZYY',tabname=>'CS_REC_RECEPTION',ESTIMATE_PERCENT=>5,method_opt=>'for all columns size 1',cascade=>true,force=>true,degree=>8,no_invalidate=>FALSE);

--对某个用户做统计收集
exec DBMS_STATS.GATHER_SCHEMA_STATS(ownname=>'ZHZWHIS',ESTIMATE_PERCENT=>5,method_opt=>'for all columns size 1',cascade=>true,force=>true,degree=>12);

--查询是索引是否为本地索引
DBA_PART_INDEXES表的LOCALITY字段
select OWNER,INDEX_NAME,LOCALITY from DBA_PART_INDEXES where owner='T_TEST' and TABLE_NAME='TAB_TEST';

--查看某索引的状态
col owner for a10;
col index_name for a20;
col index_type for a10;
col table_owner for a10;
col table_name for a10;
col table_type for a10;
col table_spacename for a10;
set line 400 pagesize 200;
select owner,index_name,index_type,table_owner,table_name,table_type,tablespace_name,status,PARTITIONED
from dba_indexes
where owner||'.'||index_name='&owner.index_name';

--根据索引名查找其基于哪些列
col index_owner for a10;
col column_name for a20;
select index_owner,index_name,table_owner,table_name,column_name,COLUMN_POSITION from dba_ind_columns
where index_name='&indexname';

--强制不走索引
select 1 from dual where exists (select  /*+ NO_INDEX(a) */ * from ZHZWHIS.IB_DG_WOFFLOG;

--按小时查看归档日志个数
set linesize 300 pagesize 1000
col Date for a10
col Day for a10
col Total for 99999
col "h00" for a10
col "h01" for a10
col "h02" for a10
col "h03" for a10
col "h04" for a10
col "h05" for a10
col "h06" for a10
col "h07" for a10
col "h08" for a10
col "h09" for a10
col "h10" for a10
col "h11" for a10
col "h12" for a10
col "h13" for a10
col "h14" for a10
col "h15" for a10
col "h16" for a10
col "h17" for a10
col "h18" for a10
col "h19" for a10
col "h20" for a10
col "h21" for a10
col "h22" for a10
col "h23" for a10
SELECT  trunc(first_time) "Date",
to_char(first_time, 'Dy') "Day",
count(1) as "Total",
substr(SUM(decode(to_char(first_time, 'hh24'),'00',1,0)),1,3) as "h00",
substr(SUM(decode(to_char(first_time, 'hh24'),'01',1,0)),1,3) as "h01",
substr(SUM(decode(to_char(first_time, 'hh24'),'02',1,0)),1,3) as "h02",
substr(SUM(decode(to_char(first_time, 'hh24'),'03',1,0)),1,3) as "h03",
substr(SUM(decode(to_char(first_time, 'hh24'),'04',1,0)),1,3) as "h04",
substr(SUM(decode(to_char(first_time, 'hh24'),'05',1,0)),1,3) as "h05",
substr(SUM(decode(to_char(first_time, 'hh24'),'06',1,0)),1,3) as "h06",
substr(SUM(decode(to_char(first_time, 'hh24'),'07',1,0)),1,3) as "h07",
substr(SUM(decode(to_char(first_time, 'hh24'),'08',1,0)),1,3) as "h08",
substr(SUM(decode(to_char(first_time, 'hh24'),'09',1,0)),1,3) as "h09",
substr(SUM(decode(to_char(first_time, 'hh24'),'10',1,0)),1,3) as "h10",
substr(SUM(decode(to_char(first_time, 'hh24'),'11',1,0)),1,3) as "h11",
substr(SUM(decode(to_char(first_time, 'hh24'),'12',1,0)),1,3) as "h12",
substr(SUM(decode(to_char(first_time, 'hh24'),'13',1,0)),1,3) as "h13",
substr(SUM(decode(to_char(first_time, 'hh24'),'14',1,0)),1,3) as "h14",
substr(SUM(decode(to_char(first_time, 'hh24'),'15',1,0)),1,3) as "h15",
substr(SUM(decode(to_char(first_time, 'hh24'),'16',1,0)),1,3) as "h16",
substr(SUM(decode(to_char(first_time, 'hh24'),'17',1,0)),1,3) as "h17",
substr(SUM(decode(to_char(first_time, 'hh24'),'18',1,0)),1,3) as "h18",
substr(SUM(decode(to_char(first_time, 'hh24'),'19',1,0)),1,3) as "h19",
substr(SUM(decode(to_char(first_time, 'hh24'),'20',1,0)),1,3) as "h20",
substr(SUM(decode(to_char(first_time, 'hh24'),'21',1,0)),1,3) as "h21",
substr(SUM(decode(to_char(first_time, 'hh24'),'22',1,0)),1,3) as "h22",
substr(SUM(decode(to_char(first_time, 'hh24'),'23',1,0)),1,3) as "h23"
FROM    V$log_history
group by trunc(first_time), to_char(first_time, 'Dy')
Order by 1;

--查看日志情况
select * from v$log
Note:如果要估算每日产生的归档文件大小，可以归档的total*BYTES即可估算

--导数进程
select job_name,state from v$datapump_job;
select job_name,degree,state from DBA_DATAPUMP_JOBS;

--查询表空间的使用率(MB)
set lin 200 pagesize 1000
select b.tablespace_name,round(sum(b.bytes)/1024/1024,0) sum_MB, round(sum(nvl(a.bytes,0))/1024/1024,0) free_MB,
  round((sum(b.bytes)-sum(nvl(a.bytes,0)))/sum(b.bytes),4)*100 use_precent
from (select tablespace_name,file_id,sum(bytes) bytes from dba_free_space group by tablespace_name,file_id ) a,
	dba_data_files b
where a.file_id(+)=b.file_id and a.tablespace_name(+)=b.tablespace_name
--	and b.tablespace_name like '%%'
group by b.tablespace_name
order by 4;

--查询表空间的使用率(GB)
set lin 200 pagesize 1000
select b.tablespace_name,round(sum(b.bytes)/1024/1024/1024,0) sum_GB, round(sum(nvl(a.bytes,0))/1024/1024/1024,0) free_GB,
  round((sum(b.bytes)-sum(nvl(a.bytes,0)))/sum(b.bytes),4)*100 use_precent
from (select tablespace_name,file_id,sum(bytes) bytes from dba_free_space group by tablespace_name,file_id ) a,
	dba_data_files b
where a.file_id(+)=b.file_id and a.tablespace_name(+)=b.tablespace_name
--	and b.tablespace_name like '%%'
group by b.tablespace_name
order by 4;

--查询表空间使用率(MB,含临时表空间)
set linesize 140 pagesize 10000
col "Status"   for a10
col "Name"     for a25
col "Type"     for a10
col "Extent"   for a15
col "Size (M)" for a20
col "Used (M)" for a20
col "Used %"   for a20
SELECT d.status "Status", d.tablespace_name "Name", d.contents "Type", d.extent_management "Extent", 
TO_CHAR(NVL(a.bytes / 1024 / 1024, 0),'99,999,990') "Size (M)", 
TO_CHAR(NVL(a.bytes - NVL(f.bytes, 0), 0)/1024/1024,'999,999,999') "Used (M)", 
TO_CHAR(NVL((a.bytes - 	NVL(f.bytes, 0)) / a.bytes * 100, 0), '990.00') "Used %" 
FROM sys.dba_tablespaces d, 
(select 	tablespace_name, sum(bytes) bytes from dba_data_files
group by tablespace_name) a, (select 	tablespace_name, sum(bytes) bytes from dba_free_space group by tablespace_name) f WHERE 
d.tablespace_name = a.tablespace_name(+) AND d.tablespace_name = f.tablespace_name(+) AND NOT 
(d.extent_management like 'LOCAL' AND d.contents like 'TEMPORARY') 
UNION ALL 
SELECT d.status 	"Status", d.tablespace_name "Name", d.contents "Type", d.extent_management "Extent", 
TO_CHAR(NVL(a.bytes / 1024 / 1024, 0),'99,999,999') "Size (M)", 
TO_CHAR(NVL(t.bytes,0)/1024/1024,'999,999,999') "Used (M)", 
TO_CHAR(NVL(t.bytes / a.bytes * 100, 0), '990.00') "Used %" FROM sys.dba_tablespaces d, 
(select tablespace_name, sum(bytes) bytes from dba_temp_files group by tablespace_name) a, (select 
tablespace_name, sum(bytes_cached) bytes from v$temp_extent_pool group by tablespace_name) t WHERE 
d.tablespace_name = a.tablespace_name(+) AND d.tablespace_name = t.tablespace_name(+) AND 
d.extent_management like 'LOCAL' AND d.contents like 'TEMPORARY'
ORDER BY 7;

--查询临时表空间
SELECT d.status 	"Status", d.tablespace_name "Name", d.contents "Type", d.extent_management "Extent", 
TO_CHAR(NVL(a.bytes / 1024 / 1024, 0),'99,999,999') "Size (M)", 
TO_CHAR(NVL(t.bytes,0)/1024/1024,'999,999,999') "Used (M)", 
TO_CHAR(NVL(t.bytes / a.bytes * 100, 0), '990.00') "Used %" FROM sys.dba_tablespaces d, 
(select tablespace_name, sum(bytes) bytes from dba_temp_files group by tablespace_name) a, (select 
tablespace_name, sum(bytes_cached) bytes from v$temp_extent_pool group by tablespace_name) t WHERE 
d.tablespace_name = a.tablespace_name(+) AND d.tablespace_name = t.tablespace_name(+) AND d.contents like 'TEMPORARY';


--查询临时表空间占用情况？
select username,segtype,SQL_ID,sum(blocks) from V$TEMPSEG_USAGE where TABLESPACE='&tsn' group by username,segtype,SQL_ID order by 4 desc;


SELECT SQL_id ,sorts_delta from (select sql_id,sorts_delta from dba_hist_sqlstat where snap_id =43183 order by sorts_delta desc) where rownum<10;

SELECT SQL_ID,TEMPSEG_SIZE,TABLESPACE,OPERATION_TYPE FROM 
(select sql_id, TEMPSEG_SIZE,tablespace,operation_type from v$sql_workarea_active  ORDER BY TEMPSEG_SIZE DESC )
WHERE ROWNUM<10;

set lin 200 pagesize 600
col username for a15
col event for a50
select b.username,b.SID,b.SERIAL#,b.event,nvl(b.sql_id,b.prev_sql_id) sql_id,a.segtype,a.blocks*(select to_number(VALUE) from v$parameter where NAME='db_block_size')/1024/1024 MB,a.TABLESPACE
from  V$TEMPSEG_USAGE a,V$SESSION b
where a.SESSION_ADDR=b.SADDR
order by a.blocks desc;


--查询占用特定表空间最多的用户(Top10)
--▲▲不能用于查询临时表空间
set lin 200 pagesize 500
col owner for a16
col sum_MB for 999999.99
select * from (
  select owner,sum(bytes)/1024/1024 sum_MB
  from dba_segments
  where tablespace_name='&tablespace_name'
  group by owner
  order by 2 desc
)where rownum<11;

--查询占用特定表空间最多的段（Top20）
col owner for a16
col segment_type for a16
col segment_name for a32
col sum_MB for 999999.99
select * from (
  select owner,segment_name,segment_type,sum(bytes)/1024/1024 sum_MB
  from dba_segments
  where tablespace_name='&tablespace_name'
  group by owner,segment_type,segment_name
  order by 4 desc
)where rownum<=21;

--查询占用特定表空间最多的段及分区（Top20）
	col owner for a16
	col segment_type for a16
	col segment_name for a32
	col partition_name for a40
	col sum_MB for 999999.99
	select * from (
	  select owner,segment_name,segment_type,partition_name,bytes/1024/1024 sum_MB
	  from dba_segments
	  where tablespace_name='&tablespace_name'
	  order by 5 desc
	)where rownum<=21;

--查询某表空间上数据文件情况
set lin 200 pageszie 500
col TABLESPACE_NAME for a20        
col FILE_NAME for a45
col STATUS for a12
select d.tablespace_name,t.status TBS_STATUS,d.file_name,d.status FILE_STATUS,d.AUTOEXTENSIBLE,d.BYTES/1024/1024 MB
from dba_data_files d, dba_tablespaces t 
where t.tablespace_name=d.tablespace_name and d.tablespace_name='&tbs';

--查询某个系统视图拥有的列名及注释
set linesize 400 pagesize 400;
col comments for a100;
col table_name for a20;
col column_name for a30;
select column_name,comments from dict_columns where table_name=upper('&tablename');

--查询当前ORACLE所拥有的字典表
set linesize 400 pagesize 400;
col comments for a100;
select * from dict;

--查看数据库字符集
select * from  v$nls_parameters where PARAMETER='NLS_CHARACTERSET';

--为某表空间增加数据文件
alter tablespace MZ_MCM_DATA
add datafile '/oracle/products/sz_data/mz_cm_i02.dbf' size 16380m autoextend off;

--设置表空间为联机状态
alter tablespace EXAMPLE online;

--设置表空间为脱机状态
alter tablespace EXAMPLE offline;

--创建表空间
create tablespace OCETRANS_DATA
datafile '/oracle/products/sz_data/sz_ocetrans_01.dbf' size 16380m autoextend off;

--创建UNDO表空间
create undo tablespace UNDOTBS0
datafile '/oracle/products/dg_data/undo0_00.dbf' size 50m
autoextend off;

--查看系统默认临时表空间
select property_name,property_value from database_properTIES  WHERE PROPERTY_NAME='DEFAULT_TEMP_TABLESPACE';

--修改系统默认临时表空间
alter database DEFAULT TEMPORARY TABLESPACE TEMP0;

--修改undo表空间
alter system set undo_tablespace=UNDOTBS0 scope=both;

Note:永久生效则在initdgdb.ora中修改dgdb1.undo_tablespace='UNDOTBS1';

--创建TEMP表空间
CREATE TEMPORARY TABLESPACE TEMP0 TEMPFILE
  '/oracle/products/dg_data/temp0_00.dbf' size 50m
autoextend off;

--删除表空间
drop tablespace TEMP11 including contents and datafiles;

--移动分区表到另一个表空间
alter table sys.aud$ move partition AUD_MAX tablespace AUDIT_DATA;



alter user DGYYHIS quota unlimited on SZ_HIS_INDEX;



--truncate表
truncate table XJ_EXP_DATA.XJ_MONI_SESSION;

--truncate分区表
alter table sys.aud$ truncate partition AUD200911;
ALTER TABLE GZZWHIS.IB_WL_UPYXPLAN truncate PARTITION IB_WL_UPYXPLAN201004  UPDATE GLOBAL INDEXES PARALLEL 16;

--split分区表
alter table YYST.SP_WORKF_INDETAIL split partition PART_MAX
at ('ST201003010000000000') 
into ( PARTITION SP_WORKF_INDETAIL_201002 TABLESPACE ST_YY_DAT COMPRESS,partition part_max TABLESPACE ST_YY_DAT COMPRESS) parallel 4 ;

alter table YYST.CS_REC_RECEPTION split partition PART_MAX
at (TO_DATE(' 2010-02-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) 
into ( PARTITION CS_REC_RECEPTION_201001 TABLESPACE ST_YY_DAT COMPRESS,partition part_max TABLESPACE ST_YY_DAT COMPRESS) parallel 4 ;

--分区情况
col TAB_PARTITION for a50
col HIGH_VALUE for a100
select TABLE_OWNER||'.'||TABLE_NAME||'.'||PARTITION_NAME TAB_PARTITION,HIGH_VALUE
from dba_tab_partitions
where TABLE_OWNER='YYST' and  TABLE_NAME='CS_REC_RECEPTION'
order by 1;

--查询分区表详情
col OWNER for a10
col SEGMENT_NAME for a25
col PARTITION_NAME for a30
set lin 200 pagesize 500
select OWNER,SEGMENT_NAME,PARTITION_NAME,BYTES/1024/1024 MB from dba_segments where OWNER in ('YYHZ','HZYY','STYYHIS') and SEGMENT_NAME in ('CS_REC_RECEPTION')
order by 2,3;

col OWNER for a10
col SEGMENT_NAME for a25
col PARTITION_NAME for a30
set lin 200 pagesize 500
select case when a.mb>=b.mb then a.owner else b.owner end owner,
  case when a.mb>=b.mb then a.SEGMENT_NAME else b.SEGMENT_NAME end SEGMENT_NAME,
  case when a.mb>=b.mb then a.PARTITION_NAME else b.PARTITION_NAME end PARTITION_NAME,
  case when a.mb>=b.mb then a.MB else b.MB end MB
from 
  (select OWNER,SEGMENT_NAME,PARTITION_NAME,BYTES/1024/1024 MB
  from dba_segments
  where OWNER ='HZYY' and SEGMENT_NAME ='CS_REC_RECEPTION'
  order by 2,3) a,
  (select OWNER,SEGMENT_NAME,PARTITION_NAME,BYTES/1024/1024 MB
  from dba_segments
  where OWNER ='HZYYHIS' and SEGMENT_NAME ='CS_REC_RECEPTION'
  order by 2,3) b
where a.SEGMENT_NAME=b.SEGMENT_NAME and a.PARTITION_NAME=b.PARTITION_NAME
--  and (a.MB>10 or b.MB>10)
order by 2,3;

--增加分区表
alter table ZWFS.SP_SMS_FINREQ add PARTITION SP_SMS_FINREQ200912  VALUES LESS THAN (TO_DATE(' 2010-01-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN'))
  PCTFREE 5 PCTUSED 60 INITRANS 100 MAXTRANS 255
  STORAGE(INITIAL 1048576 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT)
  TABLESPACE "FS_ZW_DAT" COMPRESS

--更改数据文件大小
alter database datafile '/dev/rlv_dat071' resize 2040M;


--删除表(同时释放空间)
drop table ZHYY.CM_INT_SUBS_CHANGE_HIS_02 purge;

--普通建表
create table tmp_lvcheck(str01 varchar2(100));

--将值插入某个表
insert into tmp_lvcheck values('dg_cz_mib_i07');

--删除某表重复记录
--▲▲例子中，CUSTID,INTEGRALCYC为表szzw.IB_CU_CUSTINTEGRAL唯一值
delete from szzw.IB_CU_CUSTINTEGRAL a                     
where rowid<>(
	select /*+parallel(a,8)*/ max(rowid)
	from szzw.IB_CU_CUSTINTEGRAL b
	where a.custid=b.custid and a.INTEGRALCYC=b.INTEGRALCYC);
commit;

--创建索引
CREATE INDEX MMYY.IDX_SUBS_SERVICE_APPLYOID ON MMYY.CM_SUBS_SERVICE ("APPLYOID") TABLESPACE "MM_HIS_IND" parallel 32;
alter index MMYY.IDX_SUBS_SERVICE_APPLYOID parallel 1;

--生成重建索引脚本生成
set linesize 150 pagesize 1000
select 'alter index '||owner||'.'||index_name||' rebuild  parallel 16;' from dba_indexes where status='UNUSABLE'
union
select 'alter index '||index_owner||'.'||index_name||' rebuild partition '||partition_name||' parallel 16;' from dba_ind_partitions where status='UNUSABLE'
union
select 'alter index '||index_owner||'.'||index_name||' rebuild subpartition '||subpartition_name||' parallel 16;' from dba_ind_subpartitions where status='UNUSABLE';

select 'alter index '||owner||'.'||index_name||' parallel 1;' from dba_indexes where status='UNUSABLE';

--重建索引
alter index DGZW.PK_IB_MW_INFOFEE rebuild tablespace DG_his_data parallel 32;
alter index DGZW.PK_IB_MW_INFOFEE parallel 1;

--建DBLink
create database link REPORT1
connect to xj_exp_data
identified by "fred-2009"
using 'REPORT1';

--删除DBLink
drop database link tydb;

--设置日期格式
alter session set nls_date_format='yyyy-mm-dd hh24:mi:ss';

--截断日期
select trunc(to_date('2010-05-10 02:20:24', 'yyyy-mm-dd hh24:mi:ss')) from dual;

--显示行，数字1-n 
select rownum from dual connect by level < &n+1;

--获取对象定义
set lin 200 pagesize 500
set long 99999
set longc 99999
select dbms_metadata.get_ddl(upper('&object_type'),upper('&object_name'),upper('&username')) from dual;

--获取同义词定义
select dbms_metadata.get_ddl('SYNONYM',upper('&object_name'),upper('&username')) from dual;

--获取存储过程定义
select dbms_metadata.get_ddl('PROCEDURE',upper('&object_name'),upper('&username')) from dual;

--开启对用户审计
audit table by XXX by access;
audit update table,delete table,insert table by XXX by access;

--取消对某用户审计
noaudit table,update table,delete table,insert table by hw_wpf_dba;

--审计赋权操作
audit SYSTEM GRANT by aiuap by access;

--查询审计策略
set lin 200 pagesize 500
col USER_NAME for a16
col PRIVILEGE for a30
col AUDIT_OPTION for a30
select USER_NAME,PRIVILEGE from DBA_PRIV_AUDIT_OPTS where USER_NAME='HW_WPF_DBA';
select USER_NAME,AUDIT_OPTION from DBA_STMT_AUDIT_OPTS where USER_NAME='HW_WPF_DBA';

--查看基于对象的审计策略
select OWNER,OBJECT_NAME,DEL,INS,UPD,AUD from DBA_OBJ_AUDIT_OPTS;

--通过对象名查询审计
col username format a15
col timestamp format a20
col sqltext format a60
select /*+parallel(a,16)*/ username,timestamp,sql_text from DBA_AUDIT_TRAIL a where owner='&owner' and obj_name='&obj_name';


select /*+parallel(a,16)*/ userid, NTIMESTAMP#, to_nchar(substr(sqltext,1,2000)) from XJ_EXP_DATA.AUD201103 a where   obj$name='CS_REC_BRANDCHANGE'
and obj$creator='JMYY';


注：对于视图、同义词等对象，应当找出其对应的表，然后再查询相应审计

--当前审计段情况
set lin 200 pagesize 500
col SEGMENT_NAME for a20
col PARTITION_NAME for a25
col TABLESPACE_NAME for a20
select owner,segment_name,partition_name,TABLESPACE_NAME,sum(bytes)/1024/1024 mb from dba_segments
    where segment_name='AUD$' or(owner='XJ_EXP_DATA' and segment_name like '%AUD%')
    group by owner,segment_name,partition_name,TABLESPACE_NAME
    order by 1,3;

--创建账号
create user STZHANGHAIPENG_M
identified by gmcc123
default tablespace users
temporary tablespace TEMP12
quota 2G on users;

--账号赋权
declare
v_sql varchar2(1000);
begin
  for v_cursor in (select owner,table_name from dba_tables where owner in ('SZYYHIS','SZZWHIS')) loop
    v_sql := 'grant select,delete,update,insert on "'||v_cursor.owner||'"."'||v_cursor.table_name||'" to Szliaochengyi_m';
    execute immediate v_sql;
  end loop;
end;
/

--赋权脚本
set serveroutput on
declare
v_sql varchar2(1000);
begin
  for v_cursor in (select OWNER,VIEW_NAME NAME from dba_views where owner in('COMMON','GZPB') union select owner,table_name name from dba_tables where owner in('COMMON','GZPB')) loop
    begin
    v_sql := 'grant select on '||v_cursor.owner||'.'||v_cursor.name||' to LINYUSHOU';
      execute immediate v_sql;
      dbms_output.put_line('Sucess: '||v_sql);
    exception
      when others then
      dbms_output.put_line('Fail: '||v_sql);
    end;
  end loop;
end;
/
set serveroutput off

--根据暗文修改用户密码
alter user CXQUERY identified by values'A9AF8A4AF5233CF3';

--赋予数据库维护账号包执行权限？
 grant execute on DBMS_LOCK to mmduansh_m;

--更改账号状态为密码过期
alter user XXX passwd expire;

--查询账号所拥有的角色
select granted_role from dba_role_privs
where grantee=upper('&grantee');

--查询账号的系统权限
select grantee,privilege from dba_sys_privs
where grantee=upper('&grantee');

--查询某个用户拥有的表对象
set linesize 400 pagesize 10000;
col grantee for a20;
col owner for a15;
col table_name for a20;
col grantro for a20;
select grantee,owner,table_name,grantor,privilege from dba_tab_privs where grantee=upper('&username');

--查询某个用户拥有的列对象
set linesize 400 pagesize 10000;
col grantee for a20;
col owner for a15;
col table_name for a20;
col grantro for a20;
col column_name for a20;
select grantee,owner,table_name,column_name,grantor,privilege from dba_col_privs where grantee=upper('&username');

--创建系统快照
exec dbms_workload_repository.create_snapshot();

--查询最近10次系统快照
col snap_id for 999999
col begin_interval_time for a30
col end_interval_time for a30
select * from(
	select snap_id,INSTANCE_NUMBER,begin_interval_time,end_interval_time
	from dba_hist_snapshot
	order by snap_id desc
)where rownum<31;

--查询AWR采样频率
col SNAP_INTERVAL format a20 
col RETENTION format a20 
select * from dba_hist_wr_control; 

--生成awr报告
@$ORACLE_HOME/rdbms/admin/awrrpt.sql 

--生成ash报告
@$ORACLE_HOME/rdbms/admin/ashrpt.sql

--9i生成报告
conn perfstat/perfstat 
@?/rdbms/admin/spreport.sql

--更改终端类型(AIX)
export TERM=vt100

--以指定的pfile启动数据库
startup pfile='/ora_restore/db/dbs/initdgdb.ora'

--根据pfile创建spfile
create spfile from pfile ='/ora_restore/db/dbs/initdgdb.ora';

--删除重做日志文件
alter database drop logfile group 15;

--增加重做日志文件
alter database add logfile THREAD 2 group 4  ('/oracle/products/dg_data/redo04_1') size 50M;

--切换日志
alter system switch logfile;

--切换为单实例
alter database disable thread 2;

--创建目录
create DIRECTORY JYDUMP as '/datadump/jy';

--格式化输出?
--计时
set timing on  
--显示时间
set time on
--设置网页格式
SET MARKUP HTML ON ENTMAP ON SPOOL ON PRE OFF
set markup HTML ON BODY "" TABLE "border='1' width='800%' align='center' summary='Script output'" SPOOL ON ENTMAP ON PRE OFF

#重置主机密码
lsuser -f appuser
chuser histsize=0 appuser
pwdadm appuser
chuser histsize=5 minalpha=1 minother=1 minlen=6  appuser

chuser histsize=0 minalpha=0 minother=0 minlen=0 mindiff=0 maxrepeats=0 cxbak
pwdadm cxbak
chsec -f /etc/security/lastlog -s oracle -a unsuccessful_login_count=0
chuser histsize=5 minalpha=1 minother=1 minlen=6 oracle

#重置失败登录次数为0
chsec -f /etc/security/lastlog -s oracle -a unsuccessful_login_count=0

#B SHELL切换
% sqlplus '/ as sysdba'
sqlplus: Command not found.
% /usr/bin/sh
$ 
$ cd 
$ . ./.profile
$ sqlplus '/ as sysdba'
Note:上述为佛山客服无法使用sqlplus的处理记录

#查询SYS审计，最好是基于所涉及的对象名字等查询
ls -ltr|awk '{if($6=="May"&&$7=="18") {print "echo \""$9"\"\n grep -i tivoliorts.dbf "$9}}'|cat>get.sh


#grid control重启agent
cd /oracle/products/OracleHomes/agent10g/bin
./emctl start agent
./emctl stop agent

#AIX传输文件
$ cat > txt
ctrl+c终止
NOTE: 在AIX环境中，如果需要将行数较多的文本传输到操作系统中，用vi命令会出现丢行的情况，而使用上述命令则可避免。

#查看主机信息(sun)
/usr/sbin/prtdiag

#检查共享内存段
ipcs -a

#查看被删但未释放文件
lsof|grep /oracle|grep deleted

#踢终端
mstsc -v 10.243.177.91 /console

#查看AIX系统配置
prtconf

#主机负荷检查
vmstat 2 10
vmstat -s

#查看系统初始化参数
strings /dev/rdg_spfile

#确认lv有没有做条带化
以lslv查看，如果出现下述两行则表示有做
STRIPE WIDTH:       64                                     
STRIPE SIZE:        1m  

#小数计算
echo "scale=3; 1.1/3" | bc
Note:scale指明精确度

#查询历史命令
more .sh_history

#去除空行
 sed '/^$/d' /tmp/topsql.txt>/tmp/topsql.txt2

/***********************************************************************************************/

--<-<-<@ -<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@

/*$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*/
/*常用模板$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*/
/*$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*/

/***********************************************************************************************/
后台ftp模板
/***********************************************************************************************/
HOST_IP=10.244.148.210
USRNM=oracle
PWD=oracle
ftp -inv $HOST_IP  <<! 
user $USRNM $PWD
bin
prompt off
mput czyy/exp_CZYYHIS_20091214*
mput dgyy/exp_DGYYHIS_20091214*
mput hyyy/exp_HYYYHIS_20091214*
mput swyy/exp_SWYYHIS_20091214*
close
bye
!
exit
/***********************************************************************************************/

/***********************************************************************************************/
后台跑SQL脚本
/***********************************************************************************************/
. ~/.profile
sqlplus / as sysdba <<EOF
set echo on
set verify on
spool create_tab.log
@sz/sz/sz_yy_dat.TXT
spool off
exit
EOF

. ~/.profile
export ORACLE_SID=cqdb1
sqlplus / as sysdba <<EOF
set lin 200 pagesize 500
set long 99999 longc 99999
set echo on
set verify on
set serveroutput on
set trimspool OFF
set termout ON
set timing OFF
set trimout ON
set showmode OFF
set sqlblanklines OFF
set embedded on
set escape on
set timing on

alter session set CURRENT_SCHEMA =JMYY;

spool yy_tuomin.log

spool off
exit
EOF


. ~/.profile
sqlplus / as sysdba <<EOF
set lin 200 pagesize 500 long 99999 longc 99999
set timing on  time on 
spool test.log

spool off
exit
EOF

nohup sh create_table.sh > create_table.sh.out &
/***********************************************************************************************/


/*$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*/
/*常规操作$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*/
/*$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*/

/***********************************************************************************************/
表空间扩容(AIX,裸设备)
/***********************************************************************************************/
0、前期准备
--▲▲应当检查主机、当前实例，以免跑错库，这点十分重要
--▲▲此外一定要确认需求，如该增加哪些LV，需不需要做条带化等等
#查看用户
id
#查看主机名
hostname
#确认实例
env|grep ORACLE_SID
--▲▲假如需要自行查找LV情况则使用如下命令
#列出所有VG
lsvg -o
#查看某VG下的lv状态为closed的LV
lsvg -l data01|grep closed
--▲▲需要确定某VG上能否划分LV，除了看剩余大小外，还要留意lv数()
#查看某VG状态
lsvg data01
1、查询该表空间的大小
set lin 200 pagesize 1000
select b.tablespace_name,round(sum(b.bytes)/1024/1024,0) sum_MB, round(sum(nvl(a.bytes,0))/1024/1024,0) free_MB,
  round((sum(b.bytes)-sum(nvl(a.bytes,0)))/sum(b.bytes),4)*100 use_precent
from (select tablespace_name,file_id,sum(bytes) bytes from dba_free_space group by tablespace_name,file_id ) a,
	dba_data_files b
where a.file_id(+)=b.file_id and a.tablespace_name(+)=b.tablespace_name
	and b.tablespace_name = '&tbs'
group by b.tablespace_name
order by 4;
2、查询该表空间的数据文件
--▲▲为了便于管理，新增数据文件的命名规范应当遵循旧有规范
--▲▲    例如，之前是建软连接的，新增的也需要建立，且命名规则一致
set lin 200 pageszie 500
col TABLESPACE_NAME for a20        
col FILE_NAME for a45
col STATUS for a12
select d.tablespace_name,t.status TBS_STATUS,d.file_name,d.status FILE_STATUS,d.AUTOEXTENSIBLE,d.BYTES/1024/1024 MB
from dba_data_files d, dba_tablespaces t 
where t.tablespace_name=d.tablespace_name and d.tablespace_name='&tbs';
3、检查LV状态
#LV检查
--▲▲需要所在大小(LPs*PP SIZE)、权限(PERMISSION为read/write)、状态(LV STATE为closed)、VG(VOLUME GROUP)


lsvg -o|xargs lsvg -l |grep closed

--▲▲条带化(有则包含STRIPE WIDTH及STRIPE SIZE两项)
--▲▲其中大小、权限、状态是必须确认的,此外对于RAC来说，必须检查各个结点上的情况！
lslv sz_mz_cm_i02
#检查对应文件
--▲▲LV会有对应的操作系统文件，如sz_mz_cm_i02对应/dev/rsz_mz_cm_i02，一定要确认其存在
ls -l /dev/rsz_mz_cm_i02
4、建软连接(如有必要)
#建软连接
--▲▲对于RAC来说，一定要在各个结点上建！
ln -s  /dev/rsz_mz_cm_i02 /oracle/products/sz_data/mz_cm_i02.dbf 
#检查软连接
--▲▲对于RAC来说，一定要在各个结点上检查，其属主/组为oracle/oinstall，权限777
ls -l /oracle/products/sz_data/mz_cm_i02.dbf
5、增加数据文件
--▲▲对于重要的数据库，要打开多个窗口，tail -f实时查看各个实例的alertlog
--▲▲所增加的数据文件大小必须稍微小于比LV实际大小，如建4M。
--▲▲注意，例子中的'/oracle/products/sz_data/mz_cm_i02.dbf'不能含空格，否则会报错
--增加数据文件
--▲▲倘若加的是临时表空间，datafile应当换成tempfile
alter tablespace MZ_MCM_DATA
add datafile '/oracle/products/sz_data/mz_cm_i02.dbf' size 16380m autoextend off;
6、结果检查
--检查文件是否已添加
set lin 200 pageszie 500
col TABLESPACE_NAME for a20
col FILE_NAME for a45
col STATUS for a12
select d.tablespace_name,t.status TBS_STATUS,d.file_name,d.status FILE_STATUS,d.AUTOEXTENSIBLE,d.BYTES/1024/1024 MB from dba_data_files d, dba_tablespaces t 
where t.tablespace_name=d.tablespace_name and d.tablespace_name='&tbs';
--检查当前表空间的大小
col TABLESPACE_NAME for a20        
col FILE_NAME for a45
col STATUS for a12
select d.tablespace_name,t.status TBS_STATUS,d.file_name,d.status FILE_STATUS,d.AUTOEXTENSIBLE,d.BYTES/1024/1024 MB
from dba_data_files d, dba_tablespaces t 
where t.tablespace_name=d.tablespace_name and d.tablespace_name='&tbs';
#报警日志检查
***********************************************************************************************/

--<-<-<@ -<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@

/***********************************************************************************************/
月度SYS审计查询
/***********************************************************************************************/
    内容为查询上月份SYS账号的审计内容，预计本脚本可以继续优化
/***********************************************************************************************/
1、编辑并后台跑脚本
nohup sh audit20100105.sh > audit20100105.sh.out &
脚本如下：
cat /dev/null > result.out
  cat /dev/null > list.lst
  ls -ltr /oracle/audit_gz2 |grep -i -E 'Dec'|awk '{printf "/oracle/audit_gz2/" }{print $9}' > list.lst 
  while read line
      do
       file_name=`echo "$line" | awk  '{print $1}'`
    grep $file_name list.lst > /dev/null
    if [ $? -eq 0 ]
    then 
      grep -i -E 'grant|revoke|create user' $file_name >> result.out
      #grep -i  'drop' $file_name >> result.out
      if [ $? -eq 0 ]
      then
        echo ================$file_name======================= >> result.out
        tail +14 $file_name >> result.out
        echo ================$file_name end==================  >> result.out
        echo >> result.out
      fi
    fi
done < list.lst
2、脚本后续处理
cat result.out|grep -v 'LENGTH' > result2.out
awk '{if(index($0,2011)>0) {printf"%s ",$0} else {print $0}}' result2.out|grep '2011'|grep -i -E 'revoke|create user|grant|drop user'|grep -i -E 'Jan'|awk '{if( ($1="") || ($6="") || ($7="^") || (1==1) ) {print $0}}'
其中第二句脚本之前是下面的写法
awk '{if(index($0,2010)>0) {printf"%s ",$0} else {print $0}}' result2.out|grep '2010' >tmp.log
grep -i -E 'revoke|create user|grant' tmp.log|grep -i -E 'Apr' > audit20100505.log
cat  audit20100505.log|awk '{if( ($1="") || ($6="") || ($7="^") || (1==1) ) {print $0}}'

set lin 200 pagesize 500
set long 99999 longc 9999
col SQL for a150
select /*+parallel(a,16)*/ to_char(timestamp,' Mon dd hh24:mi:ss yyyy ')||' ^ '''||sql_text||'''' SQL from dba_audit_trail a where username='XJ_USER_MGR' and (timestamp between to_date('20110101','yyyymmdd') and  to_date('20110201','yyyymmdd'));


/***********************************************************************************************/

--<-<-<@ -<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@

/***********************************************************************************************/
备份审计表
/***********************************************************************************************/
    内容为每月将已分区的审计表导出
/***********************************************************************************************/
1、创建新表
create table xj_exp_data.AUD200911 nologging tablespace YJ_HIS_DATA
as select /*+ parallel(a 16) */ * from sys.aud$ partition (AUD200911) a;
2、truncate分区表
alter table sys.aud$ truncate partition AUD200911;
3、创建视图
CREATE OR REPLACE FORCE VIEW "SYS"."AUDIT_TRAIL_200910_02" ("OS_USERNAME", "USERNAME", "USERHOST", "TERMINAL", "TIMESTAMP",
 "OWNER", "OBJ_NAME", "ACTION", "ACTION_NAME", "NEW_OWNER", "NEW_NAME", "OBJ_PRIVILEGE", "SYS_PRIVILEGE", "ADMIN_OPTION",
  "GRANTEE", "AUDIT_OPTION", "SES_ACTIONS", "LOGOFF_TIME", "LOGOFF_LREAD", "LOGOFF_PREAD", "LOGOFF_LWRITE", "LOGOFF_DLOCK", 
  "COMMENT_TEXT", "SESSIONID", "ENTRYID", "STATEMENTID", "RETURNCODE", "PRIV_USED", "CLIENT_ID", "ECONTEXT_ID", "SESSION_CPU", "EXTENDED_TIMESTAMP", "PROXY_SESSIONID", "GLOBAL_UID", "INSTANCE_NUMBER", "OS_PROCESS", "TRANSACTIONID", "SCN",
 "SQL_BIND", "SQL_TEXT") AS
  select spare1           /* OS_USERNAME */,
       userid           /* USERNAME */,
       userhost         /* USERHOST */,
       terminal         /* TERMINAL */,
       cast (           /* TIMESTAMP */
           (from_tz(ntimestamp#,'00:00') at local) as date),
       obj$creator      /* OWNER */,
       obj$name         /* OBJECT_NAME */,
       aud.action#      /* ACTION */,
       act.name         /* ACTION_NAME */,
       new$owner        /* NEW_OWNER */,
       new$name         /* NEW_NAME */,
       decode(aud.action#,
              108 /* grant  sys_priv */, null,
              109 /* revoke sys_priv */, null,
              114 /* grant  role */, null,
              115 /* revoke role */, null,
              auth$privileges)
                        /* OBJ_PRIVILEGE */,
       decode(aud.action#,
              108 /* grant  sys_priv */, spm.name,
              109 /* revoke sys_priv */, spm.name,
              null)
                        /* SYS_PRIVILEGE */,
       decode(aud.action#,
              108 /* grant  sys_priv */, substr(auth$privileges,1,1),
              109 /* revoke sys_priv */, substr(auth$privileges,1,1),
              114 /* grant  role */, substr(auth$privileges,1,1),
              115 /* revoke role */, substr(auth$privileges,1,1),
              null)
                        /* ADMIN_OPTION */,
       auth$grantee     /* GRANTEE */,
       decode(aud.action#,
              104 /* audit   */, aom.name,
              105 /* noaudit */, aom.name,
              null)
                        /* AUDIT_OPTION  */,
       ses$actions      /* SES_ACTIONS   */,
       logoff$time      /* LOGOFF_TIME   */,
       logoff$lread     /* LOGOFF_LREAD  */,
       logoff$pread     /* LOGOFF_PREAD  */,
       logoff$lwrite    /* LOGOFF_LWRITE */,
       decode(aud.action#,
              104 /* audit   */, null,
              105 /* noaudit */, null,
              108 /* grant  sys_priv */, null,
              109 /* revoke sys_priv */, null,
              114 /* grant  role */, null,
              115 /* revoke role */, null,
              aud.logoff$dead)
                         /* LOGOFF_DLOCK */,
       comment$text      /* COMMENT_TEXT */,
       sessionid         /* SESSIONID */,
       entryid           /* ENTRYID */,
       statement         /* STATEMENTID */,
       returncode        /* RETURNCODE */,
       spx.name          /* PRIVILEGE */,
       clientid          /* CLIENT_ID */,
       auditid           /* ECONTEXT_ID */,
       sessioncpu        /* SESSION_CPU */,
       from_tz(ntimestamp#,'00:00') at local,
                                   /* EXTENDED_TIMESTAMP */
       proxy$sid                      /* PROXY_SESSIONID */,
       user$guid                           /* GLOBAL_UID */,
       instance#                      /* INSTANCE_NUMBER */,
       process#                            /* OS_PROCESS */,
       xid                              /* TRANSACTIONID */,
       scn                                        /* SCN */,
       to_nchar(substr(sqlbind,1,2000))      /* SQL_BIND */,
       to_nchar(substr(sqltext,1,2000))      /* SQL_TEXT */
from xj_exp_data.AUD200910_02 aud, system_privilege_map spm, system_privilege_map spx,
     STMT_AUDIT_OPTION_MAP aom, audit_actions act
where   aud.action#     = act.action    (+)
  and - aud.logoff$dead = spm.privilege (+)
  and   aud.logoff$dead = aom.option#   (+)
  and - aud.priv$used   = spx.privilege (+);
4、赋权
grant select on sys.AUDIT_TRAIL_200910_02	 to public;


--另一个可参考的方案为：
create table xj_exp_data.AUD201012 nologging tablespace JM_HIS_DATA
  as select  * from sys.aud$ where 1=2 ;
alter session enable parallel dml;
insert /*+ append parallel(a 8)*/ into xj_exp_data.AUD201012  a select /*+ parallel(b 8)*/* from sys.aud$ partition (AUD201012) b;


/***********************************************************************************************/

--<-<-<@ -<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@



/*$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*/
/*故障处理记录$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*/
/*$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*/

/***********************************************************************************************/
广州集市归档目录满
/***********************************************************************************************/
    本次故障时间约为2010年6月26日 0:00，记录于2010年6月26日 18:38:23。
/***********************************************************************************************/
故障描述
    开发商报程序无法登录故障，在检查报错信息后发现是归档目录已达100%所致
/***********************************************************************************************/
处理步骤
    咨询负责此系统的同事，得知此系统此时间点正在用数据泵工具导出并备份到带库中，估计是由于带库备份速度赶不上，导致目录满了。
    当时杀掉导数进程后，删除最新生成的dmp文件释放空间后，故障排除。利用普通账号测试无误，开发商却再度报障，经确认为误报，系统已正常。
    过了一段时间后查询，目录已经自动释放（估计后台有自动备份并清理脚本），故障再次发生风险已排除。
/***********************************************************************************************/
总结
    1、DBA要很清楚自己所维护的系统有哪些后台脚本、何时执行、在什么位置，并告知一线同事（更理想的情况是有系统备忘录）。
    2、用户报障不一定可信，一定要自己测试，才能有底气。
    3、此次故障虽然排除了，但删除了部分备份文件，且没有再度发起备份（不熟悉此系统，不知道如何发起）。这样的做法还是有风险的！（●n●当时居然连mv操作都想不起直接rm了!）
    4、曾经试过另一次目录满的情况，当时在此目录下用du -sg *查看，结果发现所有目录均大于原始目录大小（想到挂载，没想到挂成这样），一时没反应过来，直接向上报障……
/***********************************************************************************************/

--<-<-<@ -<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@



/*$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*/
/*工程实施记录$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*/
/*$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*/

/***********************************************************************************************/
订购关系清理
/***********************************************************************************************/
    本次项目实施时间约为2010年6月26日 3:30~4:15，记录于2010年6月26日 18:04:53。
/***********************************************************************************************/
工程内容
    清理MM及SG的YY及YYHIS非分区表CM_SUBS_PRODUCT、CM_SUBS_SERVICE、CM_SUBS_PRIVILEGE的内容。
    清理的标准为YY下表中ENDDATE字段为空或者此字段晚于2009年12月底的数据保留，其余入历史数据中心，YYHIS下数据直接清理并备份到带库。
/***********************************************************************************************/
工程步骤
说明：下面将以MM地市为例说明。
##步骤1大约在工程实施前的半天或更早前实施
1、脚本准备及操作流程攥写
工程相关脚本涉及多个方面，下面将先描述较复杂易出错的导数脚本。
工程涉及到parfile及执行导入导出的脚本均为自动生成。
所涉及到的parfile有如下几种：
    exp_MMYY_dgclear_CM_SUBS_PRODUCT_20100625_.par  --过滤导出YY下某表中ENDDATE字段为空或者此字段晚于2009年12月底的数据，此部分内容将直接导回YY用户。
    exp_MMYY_dgclear_CM_SUBS_PRODUCT_20100625_his_.par  --过滤导出YY下某表中ENDDATE字段早于2009年12月底的数据，此部分内容将导入历史数据中心。
    imp_MMYY_dgclear_CM_SUBS_PRODUCT_20100625_.par  --将exp_MMYY_dgclear_CM_SUBS_PRODUCT_20100625_.par导出的数据导入YY用户。
    exp_dg_MMYYHIS_20100625_.par  --将三表YYHIS用户下的数据导出（此部分将直接清理然后备份到带库）。
    exp_dg_MMYY_20100625_copy_.par  --导出YY下某表的数据，以作备份（此部分仅仅作为备份，但由于与工程实施时间相差数小时，因此会丢失数据）。
自动生成parfile脚本可参照如下脚本（将生成类似exp_MMYY_dgclear_CM_SUBS_PRODUCT_20100625_.par文件）：
    #!/bin/sh
    for CITY in GZ CZ SG MM MZ YF
    do
    for TAB_NAME in CM_SUBS_PRODUCT CM_SUBS_SERVICE CM_SUBS_PRIVILEGE
    do
    PARFILE="exp_${CITY}YY_dgclear_${TAB_NAME}_20100625_.par"
    echo "${PARFILE}"
    echo "userid=xj_exp_data/fred-2009" > ${PARFILE}
    echo "directory=MOVE_${CITY}" >> ${PARFILE}
    echo "dumpfile=exp_${CITY}YY_dgclear_${TAB_NAME}_20100625_%u.dmp" >> ${PARFILE}
    echo "logfile=exp_${CITY}YY_dgclear_${TAB_NAME}_20100625_.log" >> ${PARFILE}
    echo "parallel=4" >> ${PARFILE}
    echo "exclude=index,statistics,trigger,grant" >> ${PARFILE}
    echo "tables=(" >> ${PARFILE}
    echo "${CITY}YY.${TAB_NAME}" >> ${PARFILE}
    echo ")" >> ${PARFILE}
    echo "QUERY=${CITY}YY.${TAB_NAME}:"'"where ENDDATE is null or ENDDATE>=to_date('"'2009-12-01','yyyy-mm-dd')"'"' >> ${PARFILE}
    done
    done
自动生成导入导出执行脚本可参照：
    #!/bin/sh
    CITY=$1
    for TAB_NAME in CM_SUBS_PRODUCT CM_SUBS_SERVICE CM_SUBS_PRIVILEGE
    do
    EXPPAR="exp_${CITY}YY_dgclear_${TAB_NAME}_20100625_.par"
    echo "nohup expdp parfile=${EXPPAR} > ${EXPPAR}.out &"
    done
    for TAB_NAME in CM_SUBS_PRODUCT CM_SUBS_SERVICE CM_SUBS_PRIVILEGE
    do
    EXPHISPAR="exp_${CITY}YY_dgclear_${TAB_NAME}_20100625_his_.par"
    echo "nohup expdp parfile=${EXPHISPAR} > ${EXPHISPAR}.out &"
    done
    for TAB_NAME in CM_SUBS_PRODUCT CM_SUBS_SERVICE CM_SUBS_PRIVILEGE
    do
    IMPPAR="imp_${CITY}YY_dgclear_${TAB_NAME}_20100625_.par"
    echo "nohup impdp parfile=${IMPPAR} > ${IMPPAR}.out &"
    done
工程中还会涉到建索引、赋权等方面脚本。
删除索引
    select 'drop index '||owner||'.'||index_name||';' from dba_indexes where owner='MMYY' and table_name in ('CM_SUBS_PRODUCT','CM_SUBS_SERVICE','CM_SUBS_PRIVILEGE');
    生成的脚本类似 drop index MMYY.IDX_SUBS_SERVICE_APPLYOID;
disable触发器
    select 'alter trigger '||owner||'.'||TRIGGER_NAME||' DISABLE;' from DBA_TRIGGERS where owner='MMYY' and table_name in ('CM_SUBS_PRODUCT','CM_SUBS_SERVICE','CM_SUBS_PRIVILEGE');
    生成的脚本类似 alter trigger MMYY.TRIG_GRP_SUBS_PRIVILEGE_CK DISABLE;
建索引语句
    select 'select dbms_metadata.get_ddl(''INDEX'','''||index_name||''','''||owner||''')||'' parallel 16;'' from dual;' from dba_indexes where owner='MMYY' and table_name in ('CM_SUBS_PRODUCT','CM_SUBS_SERVICE','CM_SUBS_PRIVILEGE');
    select 'alter index '||owner||'.'||index_name||' parallel 1;' from dba_indexes where owner='MMYY' and table_name in ('CM_SUBS_PRODUCT','CM_SUBS_SERVICE','CM_SUBS_PRIVILEGE');
修改触发器状态语句
    select 'alter trigger '||owner||'.'||TRIGGER_NAME||' enable;' from DBA_TRIGGERS where owner='MMYY' and table_name in ('CM_SUBS_PRODUCT','CM_SUBS_SERVICE','CM_SUBS_PRIVILEGE');
    生成的脚本类似：alter trigger MMYY.TRIG_GRP_SUBS_PRIVILEGE_CK enable;
赋权语句
     grant select,insert,update,delet MMYYHIS.CM_SUBS_PRODUCT to HW_YY_RW;
##步骤2在工程实施前的两三个小时实施
2、各表的统计与备份
将YYHIS及YY下各表的数据导出，并统计其记录数、大小(查看DBA_TABLES及DBA_INDEXES)。
备份执行parfile为exp_dg_MMYYHIS_20100625_.par及exp_dg_MMYY_20100625_copy_.par的导出。
##步骤3以后为工程正式实施时间
3、停止应用（由开发商实施）
4、锁定程序账号并查杀其进程
    alter user MMYY account lock;
    alter user MMZW account lock;
--检查账号锁定状态
    select username, account_status from dba_users where username in ('MMYY','MMZW');
--生成杀掉MMYY,MMZW的进程
    select 'ps -ef | grep '||p.spid||'| grep LOCAL=NO|awk ''{print $2}''|xargs kill -9' from v$process p, v$session s where p.addr=s.paddr and s.username in ('MMYY','MMZW');
5、过滤导出MMYY下表的数据
①过滤导出需要导回YY下的数据
    nohup expdp parfile=exp_MMYY_dgclear_CM_SUBS_PRODUCT_20100625_.par > exp_MMYY_dgclear_CM_SUBS_PRODUCT_20100625_.par.out &
    nohup expdp parfile=exp_MMYY_dgclear_CM_SUBS_SERVICE_20100625_.par > exp_MMYY_dgclear_CM_SUBS_SERVICE_20100625_.par.out &
    nohup expdp parfile=exp_MMYY_dgclear_CM_SUBS_PRIVILEGE_20100625_.par > exp_MMYY_dgclear_CM_SUBS_PRIVILEGE_20100625_.par.out &
②过滤导出需要导入历史数据中心的数据
    nohup expdp parfile=exp_MMYY_dgclear_CM_SUBS_PRODUCT_20100625_his_.par > exp_MMYY_dgclear_CM_SUBS_PRODUCT_20100625_his_.par.out &
    nohup expdp parfile=exp_MMYY_dgclear_CM_SUBS_SERVICE_20100625_his_.par > exp_MMYY_dgclear_CM_SUBS_SERVICE_20100625_his_.par.out &
    nohup expdp parfile=exp_MMYY_dgclear_CM_SUBS_PRIVILEGE_20100625_his_.par > exp_MMYY_dgclear_CM_SUBS_PRIVILEGE_20100625_his_.par.out &
说明:上述脚本可同时执行
6、drop mmyyhis中的表
    drop table mmyyhis.CM_SUBS_PRODUCT cascade constraints;
    drop table mmyyhis.CM_SUBS_SERVICE cascade constraints;
    drop table mmyyhis.CM_SUBS_PRIVILEGE cascade constraints;
--确认表是否被删除
    select owner, table_name from dba_tables where owner='MMYYHIS' and table_name in ('CM_SUBS_PRODUCT','CM_SUBS_SERVICE','CM_SUBS_PRIVILEGE');
7、创建新的mmyyhis分区表(由开发商执行但当晚并无实施)
8、truncate MMYY下表内容
    truncate table MMYY.CM_SUBS_PRODUCT;
    truncate table MMYY.CM_SUBS_SERVICE;
    truncate table MMYY.CM_SUBS_PRIVILEGE;
--确认原表已经清空
    select count(*) from MMYY.CM_SUBS_PRODUCT;
    select count(*) from MMYY.CM_SUBS_SERVICE;
    select count(*) from MMYY.CM_SUBS_PRIVILEGE;
9、删除索引
--select 'drop index '||owner||'.'||index_name||';' from dba_indexes where owner='MMYY' and table_name in ('CM_SUBS_PRODUCT','CM_SUBS_SERVICE','CM_SUBS_PRIVILEGE');
    drop index MMYY.IDX_SUBS_SERVICE_APPLYOID;
    drop index MMYY.IDX_SUBS_SERVICE_STATUSDATE;
    drop index MMYY.PK_CM_SUBS_SERVICE;
    drop index MMYY.IDX_SUBS_SERVICE_SUBSID;
    drop index MMYY.IDX_CM_SUBS_PRODUCT_SUBSID;
    drop index MMYY.UIDX_CM_SUBS_PRODUCT_OID;
    drop index MMYY.IDX_SUBS_PRODUCT_SUBSPROD;
    drop index MMYY.IDX_SUBS_PRODUCT_PRODID;
    drop index MMYY.PK_CM_SUBS_PRIVILEGE;
    drop index MMYY.IDX_CM_SUBS_PRIVILEGE_SUBSID;
--确认index已删除
    select owner,index_name from dba_indexes where owner='MMYY' and table_name in ('CM_SUBS_PRODUCT','CM_SUBS_SERVICE','CM_SUBS_PRIVILEGE');
10、disable掉当前的trigger
--select 'alter trigger '||owner||'.'||TRIGGER_NAME||' DISABLE;' from DBA_TRIGGERS where owner='MMYY' and table_name in ('CM_SUBS_PRODUCT','CM_SUBS_SERVICE','CM_SUBS_PRIVILEGE');
    alter trigger MMYY.TRIG_GRP_SUBS_PRIVILEGE_CK DISABLE;
    alter trigger MMYY.TRIG_SUBS_SERVICE_MUSIC DISABLE;
--确认trigger状态为disable
    select owner,trigger_name,status from dba_triggers where owner='MMYY' and table_name in ('CM_SUBS_PRODUCT','CM_SUBS_SERVICE','CM_SUBS_PRIVILEGE');
11、导入在线数据exp_MMYY_dgclear_20100625_%u.dmp
    nohup impdp parfile=imp_MMYY_dgclear_CM_SUBS_PRODUCT_20100625_.par > imp_MMYY_dgclear_CM_SUBS_PRODUCT_20100625_.par.out &
    nohup impdp parfile=imp_MMYY_dgclear_CM_SUBS_SERVICE_20100625_.par > imp_MMYY_dgclear_CM_SUBS_SERVICE_20100625_.par.out &
    nohup impdp parfile=imp_MMYY_dgclear_CM_SUBS_PRIVILEGE_20100625_.par > imp_MMYY_dgclear_CM_SUBS_PRIVILEGE_20100625_.par.out &
12、新建原表索引
建索引语句参照：
    CREATE INDEX "MMYY"."IDX_SUBS_SERVICE_APPLYOID" ON "MMYY"."CM_SUBS_SERVICE" ("APPLYOID")
      PCTFREE 10 INITRANS 2 MAXTRANS 255 NOLOGGING COMPUTE STATISTICS
      STORAGE(INITIAL 1048576 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
      PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT)
      TABLESPACE "MM_HIS_IND"
      parallel 16;
--查看新建索引的状态
    set linesize 200
    select index_name,table_name,status,DEGREE from dba_indexes where owner='MMYY' and table_name in ('CM_SUBS_PRODUCT','CM_SUBS_SERVICE','CM_SUBS_PRIVILEGE');
13、更改并行度
    --select 'alter index '||owner||'.'||index_name||' parallel 1;' from dba_indexes where owner='MMYY' and table_name in ('CM_SUBS_PRODUCT','CM_SUBS_SERVICE','CM_SUBS_PRIVILEGE');
语句参照：
    alter index MMYY.IDX_SUBS_SERVICE_APPLYOID parallel 1;
--确认当前并行度
    set linesize 200
    select index_name,table_name,status,DEGREE from dba_indexes where owner='MMYY' and table_name in ('CM_SUBS_PRODUCT','CM_SUBS_SERVICE','CM_SUBS_PRIVILEGE');
    select table_name,degree from dba_tables where owner='MMYY' and table_name in ('CM_SUBS_PRODUCT','CM_SUBS_SERVICE','CM_SUBS_PRIVILEGE');
14、修改触发器状态
--select 'alter trigger '||owner||'.'||TRIGGER_NAME||' enable;' from DBA_TRIGGERS where owner='MMYY' and table_name in ('CM_SUBS_PRODUCT','CM_SUBS_SERVICE','CM_SUBS_PRIVILEGE');
    alter trigger MMYY.TRIG_GRP_SUBS_PRIVILEGE_CK enable;
    alter trigger MMYY.TRIG_SUBS_SERVICE_MUSIC enable;
--确认trigger状态为enable
    select owner,trigger_name,status from dba_triggers where owner='MMYY' and table_name in ('CM_SUBS_PRODUCT','CM_SUBS_SERVICE','CM_SUBS_PRIVILEGE');
    15、对表进行统计分析
    exec dbms_stats.gather_table_stats('MMYY','CM_SUBS_PRODUCT',estimate_percent=>10,method_opt=>'for all indexed columns size 1',degree=>16,cascade=>true,force=>true);
    exec dbms_stats.gather_table_stats('MMYY','CM_SUBS_SERVICE',estimate_percent=>10,method_opt=>'for all indexed columns size 1',degree=>16,cascade=>true,force=>true);
    exec dbms_stats.gather_table_stats('MMYY','CM_SUBS_PRIVILEGE',estimate_percent=>10,method_opt=>'for all indexed columns size 1',degree=>16,cascade=>true,force=>true);
--查看统计分析后表的数据量
    alter session set nls_date_format='yyyy-mm-dd hh24:mi:ss';
    select table_name,num_rows,LAST_ANALYZED from dba_tables where owner='MMYY' and table_name in ('CM_SUBS_PRODUCT','CM_SUBS_SERVICE','CM_SUBS_PRIVILEGE');
16、YYHIS用户下表授权（由于当晚没有重建YYHIS表所以没有执行下面的语句）
执行脚本类似于：
    grant select,insert,update,delet MMYYHIS.CM_SUBS_PRODUCT to HW_YY_RW;
17、统计清理结果
可以参照步骤2，主要为了统计清理出多大的数据量以填写实施报告。
18、解锁账号
    alter user MMYY account unlock;
    alter user MMZW account unlock;
--确认已经解锁
    select username,account_status from dba_users where username in ('MMYY','MMZW');
19、重启应用（开发商实施）
/***********************************************************************************************/
总结
    这是我第一次参与实施夜间工程(*^__^*) 嘻嘻。这是一个典型的数据清理工程。
    1、项目实施前脚本及操作步骤已经准备得很完善，这使得操作能有条不紊地进行，且很大程度避免能人为操作的失误（当时较疲劳），这点十分值得之后参照。
    2、本项目由于某开发商没提前准备使得工程延误接近两个小时，这点突显了沟通的重要。另外，一位同事说他实施项目前一两个小时会先与接口人沟通，这个经验很值得参考。
    3、本次项目实施脚本均含检查脚本，此外每执行一条语句注释一句，这两点以后均可沿用。
    4、对于导数，多长时间合理，如何确认状态是正常的，这两点心里还是没底，还需要去加强。
    5、本次项目实施前本来预计要在crontab中停止导数及统计收集进程，但由于没预计好什么时候停止，最后没有停，虽然没有造成什么影响，但还是应该避免再出现这种情况。
/***********************************************************************************************/

--<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@

/***********************************************************************************************/
深圳库系统割接
/***********************************************************************************************/
    本次项目实施时间约为2010年6月25日 21:30~1:15，记录于2010年6月26日 18:04:53。
/***********************************************************************************************/
工程内容
    从深圳库导出YY和ZW的数个表，传输到另一台机器后导入并脱敏
/***********************************************************************************************/
工程步骤
1、从深圳库导出文件
2、以tar命令打包导出的文件再用gzip压缩
3、传输文件并解压
4、建用户并执行导入（对于需要脱敏的表排除了索引）
5、脱敏
原本开发商所提供的脱敏脚本为：
    declare
    cursor  cur_oid  is  select  subsid from CM_SUBS_SUBSCRIBER ;
    var_oid  CM_SUBS_SUBSCRIBER.subsid%type;
    var_num  number;
    begin
    open cur_oid;
    loop
    exit  when cur_oid%notfound;
    fetch cur_oid into var_oid;
    update CM_SUBS_SUBSCRIBER set 
    --用户名称
    subsname='中国移动'||substr(custid,8),
    --密码
    password='123321',
    --用户的Vip类型
    VIPTYPE='VC0000',
    --资料的创建时间,不做为计费的起始时间
    CREATEDATE=to_date('2007-12-23 11:01:01','yyyy-mm-dd hh24:mi:ss'),
    --VIP卡类型
    VIPCARDTYPE='CardNormal',
    --VIP卡号
    CARDNO='000',
    --大客户的当前客户经理
    CURRENTCUSTMGR='',
    --行业客户经理(负责客户经理)
    RESPONSECUSTMGR=''
    where subsid=var_oid ;
    var_num:=var_num+1;
    if mod(var_num,1000)=0 then
       commit;
        dbms_output.put_line('CM_SUBS_SUBSCRIBER 1000 records committed...');
    end if;
    end loop;
    close  cur_oid;
    commit;
    end;
    /
修改后的脚本为：
    update /*+parallel(a,24)*/ SZYY_OCECS.CM_SUBS_SUBSCRIBER a set 
    subsname='中国移动'||substr(custid,8),
    password='123321',
    VIPTYPE='VC0000',
    CREATEDATE=to_date('2007-12-23 11:01:01','yyyy-mm-dd hh24:mi:ss'),
    VIPCARDTYPE='CardNormal',
    CARDNO='000',
    CURRENTCUSTMGR='',
    RESPONSECUSTMGR='';
对于这两种方法的优劣，还没比较出
6、建索引
取建索引脚本主要用get_ddl以及SET_TRANSFORM_PARAM函数取结果后修改。
/***********************************************************************************************/
总结
    这次记录时间比较后，所以部分脚本没有记录下来。值得思考的问题主要有：
    1、开发商提供的脱敏脚本以及自行修改的脚本哪种好，没比较出来
    2、本次导入并没有设置好相关参数，导致不少不必要的报错，以后得注意此问题。
    3、获取可执行的建索引脚本还是有必要研究的。
    4、这类型的操作常有，为了避免重复性劳动，还是值得研究整个过程如何优化的！
/***********************************************************************************************/

--<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@ --<-<-<@

/*$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*/
/*待添加整理部分$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*/
/*$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*/


--关闭数据库(单实例)
确定实例
select instance_name from v$instance;
alter system switch logfile;
shutdown immediate;

--oracle目录清理
1、/oracle/products/10.2/db/network/log
注：需用以cat方式清理
2、/oracle/products/admin/*/bdump
注：cdmp目录均可以用rm -rf清理
find . -type d
3、/oracle/products/admin/
注：较大的trc文件可以用cat /dev/null>方式清理
ls -ltr |grep trc|awk '{if($5>10485760)print $9}'|xargs du -sm

ls -ltr |grep trc|awk '{if($5>10485760)print "cat /dev/null>"$9}' >cat.sh |xargs du -sm


find . -size +1048 -exec ls -alt {} \;

4、/oracle/products/OracleHomes/agent10g/S3_C_YZ_YZSJK/sysman/emd

--根据log日志查找dmp文件
1、找出相关log日志
grep -r CS_REC_RECEPTION * |grep exported|grep 200708|grep -v '0 rows'|grep MM
2、查看log日志
找出大小以及dmp文件
 /oracle/datadump/move_tab/gz/exp_gzyyhis0203.dmp
 06 February, 2009 19:34:34
 293.0 GB

--watchauth进程
watchauth.sh(文件存放在/下)，需用root用户跑
nohup sh watchauth.sh > watchauth.out &
####################################
#!/bin/sh
AUTHDIR=/oracle/products/10.2/crs/crs/auth
while [ true ]
do
if [ -d $AUTHDIR ]; then
  sleep 1
else
   NOW=`date`
   echo "The auth directory is not found at $NOW" >> /home/oracle/watchauth.log
   mkdir $AUTHDIR
   chown root:oinstall $AUTHDIR
   chmod 0755 $AUTHDIR
fi
sleep 10
done
############ End ######################################


--导数评估
userid=system/oracle
SCHEMAS=yygz
logfile=exp_YYGZ_20100402.log
parallel=4
exclude=statistics,trigger,grant
ESTIMATE_ONLY=y

--存储过程
set serveroutput on
declare
v_str varchar2(200);
begin
for i in (select username 
			from dba_users 
			where username like 
			'%ZW' 
			and account_status='OPEN'
		  )
loop
	v_str :='truncate table '||i.username||'.'||'CH_ZJTY_BOSSSUCCHIS;';
	--dbms_output.put_line(v_str);
	execute v_str;
	dbms_output.put_line('CH_ZJTY_BOSSSUCCHIS has been truncated!');
end loop;
end;
/
set serveroutput off

--导出脚本
userid=xj_exp_data/fred-2009
directory=MOVE_TEMP 
dumpfile=expdp_dgzw_20100401_%u.dmp 
logfile=expdp_dgzw_20100401.log
EXCLUDE=indexes,statistics,grants 
parallel=2
tables=(
DGZW.RB_PF_BALANCETYPE,
DGZW.RB_CBB_UNWOFFCUST,
DGZW.RB_CBA_EBOXUNITDETHIS,
DGZW.RB_CBA_EBOXUNITDET,
DGZW.RB_SB_BALANCE)

--导入脚本
userid=system/oracle
directory=GZDUMP
dumpfile=exp_GZYYHIS_20100208_his%u.dmp
logfile=imp_GZYYHIS_20100221_01.log
parallel=1
remap_schema=GZYYHIS:YYGZ
INCLUDE=TABLE_DATA
TABLE_EXISTS_ACTION=append
remap_tablespace=(
gz_CM_DATA:yy_gz_dat,
gz_CS_DATA:yy_gz_dat,
yy_gz_datA:yy_gz_dat,
gz_MM_DATA:yy_gz_dat,
gz_OT_DATA:yy_gz_dat,
gz_PCSA_DATA:yy_gz_dat,
gz_MCM_DATA:yy_gz_dat,
gz_MLM_DATA:yy_gz_dat,
gz_YYO_DATA:yy_gz_dat,
gz_CM_IND:yy_gz_idx,
gz_CS_IND:yy_gz_idx,
gz_YY_IND:yy_gz_idx,
gz_MM_IND:yy_gz_idx,
gz_OT_IND:yy_gz_idx,
gz_PCSA_IND:yy_gz_idx,
gz_MCM_IND:yy_gz_idx,
gz_MLM_IND:yy_gz_idx,
gz_YYO_IND:yy_gz_idx,
gz_his_data:yy_gz_dat,
gz_his_ind:yy_gz_idx
)
tables=(
GZYYHIS.CS_ACC_COLLECT:CS_ACC_COLLECT_200905
GZYYHIS.CS_ACC_CYCLEINVOICE:CS_ACC_CYCLEINVOICE_200905
GZYYHIS.CS_ACC_CYCLEINVOICEBILLITEM:CC_CYCLEINVOICEBILLITEM_200905
GZYYHIS.CS_ACC_INVPRINTLOG:CS_ACC_INVPRINTLOG_200905
GZYYHIS.CS_ACC_OUTCOLLECT:CS_ACC_OUTCOLLECT_200905
GZYYHIS.CS_CWL_REVENUE:CS_CWL_REVENUE_200905
GZYYHIS.CS_CWL_WORKLOAD:CS_CWL_WORKLOAD_200905
GZYYHIS.CS_REC_ACCOUNT:CS_REC_ACCOUNT_200905
GZYYHIS.CS_REC_CHANGE:CS_REC_CHANGE_200905
GZYYHIS.CS_REC_CUSTOMER:CS_REC_CUSTOMER_200905
GZYYHIS.CS_REC_FEE:CS_REC_FEE_200905
GZYYHIS.CS_REC_FEE_BREAK:CS_REC_FEE_BREAK_200905
GZYYHIS.CS_REC_INDIVIAL:CS_REC_INDIVIAL_200905
GZYYHIS.CS_REC_OPENCARDSHIS:CS_REC_OPENCARDSHIS_200907
GZYYHIS.CS_REC_PAYTYPE:CS_REC_PAYTYPE_200905
GZYYHIS.CS_REC_PRESENT:CS_REC_PRESENT_200905
GZYYHIS.CS_REC_PRIVILEGE:CS_REC_PRIVILEGE_200905
GZYYHIS.CS_REC_PRODATTR:CS_REC_PRODATTR_200905
GZYYHIS.CS_REC_PRODUCT:CS_REC_PRODUCT_200905
GZYYHIS.CS_REC_PROTOCOL_LOG:CS_REC_PROTOCOL_LOG_200905
GZYYHIS.CS_REC_RECEPTION:CS_REC_RECEPTION_200905
GZYYHIS.CS_REC_RESOURCE:CS_REC_RESOURCE_200905
GZYYHIS.CS_REC_SCORECHG:CS_REC_SCORECHG_200905
GZYYHIS.CS_REC_SUBS:CS_REC_SUBS_200905
GZYYHIS.CS_REC_VGOPUSERDATA:CS_REC_VGOPUSERDATA_200910
GZYYHIS.SP_WORKF_COMM_HIS:SP_WORKF_COMM_HIS_200910
GZYYHIS.SP_WORKF_OUTDETAIL:SP_WORKF_OUTDETAIL_200910
)

select segment_name,tablespace_name,owner,status from dba_rollback_segs where STATUS='NEEDS RECOVERY'

--RMAN模板
RMAN> run{
allocate channel  c1 device type disk;
allocate channel  c2 device type disk;
allocate channel  c3 device type disk;
allocate channel  c4 device type disk;
backup as compressed backupset database format '/oracle/products/dg_data/%u_%r_%t_full.bak';
release channel c1;
release channel c2;
release channel c3;
release channel c4;
}


--根据CURRENT_SCN导数
col CURRENT_SCN for 9999999999999999
select CURRENT_SCN from v$database ;

userid='/ as sysdba'
directory=ex_dp
dumpfile=gdsm_gg_yj20100412.dmp
FLASHBACK_SCN=67262523713
tables=(
gdsm.sv_sms_changeerr
gdsm.sv_sms_chargeprivisms
gdsm.sv_sms_command
gdsm.sv_sms_limitsms
);

--集市脚本

$ cd /oracle/scripts/
$ ls -ltr *.sh
-rwx------   1 oracle   oinstall        147 Feb 02 15:42 cxdm.sh
-rwx------   1 oracle   oinstall        111 Feb 09 18:59 hwdm.sh
$ more cxdm.sh
for dm in gzdm szdm hzdm mzdm swdm czdm jydm  sgdm qydm zqdm stdm zhdm zsdm hydm
do
  nohup sqlplus tbbk/bkods2010@$dm @$1  1>$dm.log 2>&1 & 
done
$ cat hwdm.sh

for dm in dgdm fsdm jmdm yjdm zjdm mmdm yfdm
do
  nohup sqlplus tbbk/bkods2010@$dm @$1  1>$dm.log 2>&1 &
done

--网管oracle目录清理
/oracle/products/OracleHomes/oms10g/Apache/Apache/logs
/oracle/products/OracleHomes/oms10g/sysman/recv





declare
  i number;
begin
  i := 0;
  for v_cur in (select MEMSERVNUMBER from tmpx_tp1002907) loop
    insert into mmyy.pc_prod_sale_customer
      (CUSTGROUPID, CUSTNO, REGION, STARTDATE, ENDDATE)
      select '75408368876841',v_cur.MEMSERVNUMBER,668,to_date('2010-05-10 00:00:00', 'yyyy-mm-dd hh24:mi:ss'), to_date('2099-01-01 00:00:00', 'yyyy-mm-dd hh24:mi:ss') from dual;
    i := i + 1;
    if (mod(i, 10000) = 0) then
      commit;
    end if;
  end loop;
  commit;
end;
 

--查看特定等待事件达到30个以上的时间点
select snap_id,to_char(SAMPLE_TIME,'yyyymmdd hh24:mi:ss'),count(*) from DBA_HIST_ACTIVE_SESS_HISTORY
where event in('gc current request','gc cr request','gc buffer busy','latch: cache buffers chains','latch: cache buffer handles','enq: DX - contention','row cache lock','DFS lock handle')
  and snap_id in(60162,60163)
  and (SAMPLE_TIME between to_date('20100512 8:50','yyyymmdd hh24:mi') and to_date('20100512 10:30','yyyymmdd hh24:mi'))
group by to_char(SAMPLE_TIME,'yyyymmdd hh24:mi:ss'),snap_id
having count(*)>=30
order by 2;

--查看某时间点等待事件情况
select  EVENT,count(*) from DBA_HIST_ACTIVE_SESS_HISTORY where snap_id=60163 and
to_char(SAMPLE_TIME,'yyyymmdd hh24:mi:ss')='20100512 09:03:44' and WAIT_CLASS<>'Idle'
group by event
order by 2;

--查询某时间点进程情况
select  BLOCKING_SESSION,event,count(*) from DBA_HIST_ACTIVE_SESS_HISTORY where snap_id=60163 and
to_char(SAMPLE_TIME,'yyyymmdd hh24:mi:ss')='20100512 09:03:44' and WAIT_CLASS<>'Idle'
  and event in('gc current request','gc cr request','gc buffer busy','latch: cache buffers chains','latch: cache buffer handles','enq: DX - contention','row cache lock','DFS lock handle')
  group by BLOCKING_SESSION,event
  order by 3;

select SESSION_ID,USER_ID,SQL_ID,BLOCKING_SESSION,event from DBA_HIST_ACTIVE_SESS_HISTORY where snap_id=60163 and 
to_char(SAMPLE_TIME,'yyyymmdd hh24:mi:ss')='20100512 09:03:44' and WAIT_CLASS<>'Idle'
  and SESSION_ID =5334;

select to_char(SAMPLE_TIME,'yyyymmdd hh24:mi:ss'),SESSION_ID,USER_ID,SQL_ID,BLOCKING_SESSION,event from DBA_HIST_ACTIVE_SESS_HISTORY where snap_id=60163 and 
(SAMPLE_TIME  between to_date('20100512 09:01:44','yyyymmdd hh24:mi:ss') and to_date('20100512 09:05:44','yyyymmdd hh24:mi:ss')) and WAIT_CLASS<>'Idle'
  and SESSION_ID =6550;
  
--查看某事件段内等待事件情况
select snap_id,to_char(SAMPLE_TIME,'yyyymmdd hh24:mi:ss'),count(*) from DBA_HIST_ACTIVE_SESS_HISTORY
where event in('gc current request','gc cr request','gc buffer busy','latch: cache buffers chains',
'latch: cache buffer handles','enq: DX - contention','row cache lock','DFS lock handle') and
snap_id in(60162,60163) and (SAMPLE_TIME between to_date('20100512 8:50','yyyymmdd hh24:mi') and to_date('20100512 10:30','yyyymmdd hh24:mi'))
group by to_char(SAMPLE_TIME,'yyyymmdd hh24:mi:ss'),snap_id
having count(*)>=30
order by 2;
--查看某时间点等待事件情况
select  EVENT,count(*) from DBA_HIST_ACTIVE_SESS_HISTORY where snap_id=60163 and
to_char(SAMPLE_TIME,'yyyymmdd hh24:mi:ss')='20100512 09:03:44' and WAIT_CLASS<>'Idle'
group by event
order by 2;
--查询某时间点进程情况
select  BLOCKING_SESSION,event,count(*) from DBA_HIST_ACTIVE_SESS_HISTORY where snap_id=60163 and
to_char(SAMPLE_TIME,'yyyymmdd hh24:mi:ss')='20100512 09:03:44' and WAIT_CLASS<>'Idle'
  and event in('gc current request','gc cr request','gc buffer busy','latch: cache buffers chains','latch: cache buffer handles','enq: DX - contention','row cache lock','DFS lock handle')
  group by BLOCKING_SESSION,event
  order by 3;

select SESSION_ID,USER_ID,SQL_ID,BLOCKING_SESSION,event from DBA_HIST_ACTIVE_SESS_HISTORY where snap_id=60163 and 
to_char(SAMPLE_TIME,'yyyymmdd hh24:mi:ss')='20100512 09:03:44'
  and SESSION_ID =5387;

select to_char(SAMPLE_TIME,'yyyymmdd hh24:mi:ss'),SESSION_ID,USER_ID,SQL_ID,BLOCKING_SESSION,event from DBA_HIST_ACTIVE_SESS_HISTORY where snap_id=60163 and 
(SAMPLE_TIME  between to_date('20100512 09:01:44','yyyymmdd hh24:mi:ss') and to_date('20100512 09:05:44','yyyymmdd hh24:mi:ss'))
  and SESSION_ID =6550;
  
select to_char(a.SAMPLE_TIME,'yyyy-mm-dd hh24:mi:ss') sample_time,
c.username,
a.SESSION_ID,
a.SESSION_SERIAL#,
b.SQL_TEXT
from DBA_HIST_ACTIVE_SESS_HISTORY a,DBA_HIST_SQLTEXT b,dba_users c
where a.SQL_ID=b.SQL_ID
and a.user_id=c.user_id
--and c.username='GZYY'
and snap_id=60172
and to_char(sample_time,'yyyymmdd hh24:mi:ss')>='20100512 13:30:00'
and to_char(sample_time,'yyyymmdd hh24:mi:ss')<='20100512 13:35:00';


高消耗语句查询
set line 2300
set pagesize 500
col module for a50
col sql_text for a2000
select distinct a.PARSING_SCHEMA_NAME,c.MODULE,a.INSTANCE_NUMBER,a.sql_id,a.execs as 执行次数,ROUND(a.cpu_times/a.execs,2)as 单次执行时间,a.cpu_times as cpu消耗时间,ROUND(a.cpu_times/b.sum_time*100,2) as 消耗cpu百分比,a.buffer_gets as 逻辑读,ROUND(a.buffer_gets/b.sum_buffer*100,2) as 逻辑读百分比,a.disk_read as 物理读,ROUND(a.disk_read/b.sum_disk*100,2) as 物理读百分比,c.sql_text 
from
(select PARSING_SCHEMA_NAME,INSTANCE_NUMBER,sql_id,sum(EXECUTIONS_DELTA)AS execs,round(sum(CPU_TIME_DELTA)/1000000,2)AS cpu_times,round(sum(ELAPSED_TIME_DELTA)/1000000,2)AS elapsed_time,sum(BUFFER_GETS_DELTA)AS  buffer_gets,sum(DISK_READS_DELTA)AS disk_read
from WRH$_SQLSTAT where (SNAP_ID between 60508 and 60512) and INSTANCE_NUMBER=1 group by PARSING_SCHEMA_NAME,INSTANCE_NUMBER,sql_id) a ,
(SELECT round(SUM(CPU_TIME_DELTA)/1000000,2) sum_time ,SUM(BUFFER_GETS_DELTA) sum_buffer,sum(DISK_READS_DELTA) sum_disk FROM WRH$_SQLSTAT where (SNAP_ID between 60508 and 60512) and INSTANCE_NUMBER=1) b,
v$sql c
where a.execs>0 and a.sql_id=c.sql_id order by cpu消耗时间 desc;

select a.INSTANCE_NUMBER,a.snap_id,to_char(begin_interval_time,'yyyymmdd hh24:mi:ss')||'-'||to_char(end_interval_time,'yyyymmdd hh24:mi:ss') TIME,PARSING_SCHEMA_NAME,cpu_times,to_char(round(cpu_times/sum_time,2)*100)||'%' percent from
  (select INSTANCE_NUMBER,snap_id,PARSING_SCHEMA_NAME,round(sum(CPU_TIME_DELTA)/1000000,2) AS cpu_times from WRH$_SQLSTAT where (SNAP_ID between 60433 and 60479)  group by PARSING_SCHEMA_NAME,snap_id,INSTANCE_NUMBER) a,
  (SELECT snap_id,round(SUM(CPU_TIME_DELTA)/1000000,2) sum_time FROM WRH$_SQLSTAT where SNAP_ID between 60433 and 60479 group by snap_id) b,
  dba_hist_snapshot c
where a.snap_id=b.snap_id and c.snap_id=a.snap_id and PARSING_SCHEMA_NAME='ITMUSER1'
order by begin_interval_time,a.INSTANCE_NUMBER;
select snap_id,PARSING_SCHEMA_NAME,round(sum(CPU_TIME_DELTA)/1000000,2) AS cpu_times from WRH$_SQLSTAT where (SNAP_ID between 60508 and 60512)  group by PARSING_SCHEMA_NAME,snap_id order by 1;

col snap_id for 999999
col begin_interval_time for a30
col end_interval_time for a30
select * from(
	select snap_id,begin_interval_time,end_interval_time
	from dba_hist_snapshot
	where begin_interval_time>to_date('20100518 0','yyyymmdd hh24') and  end_interval_time<to_date('20100519 0','yyyymmdd hh24')
	order by begin_interval_time desc
)where rownum<101;

select snap_id,to_char(begin_interval_time,'yyyy-mm-dd hh24:mi'),to_char(end_interval_time,'yyyy-mm-dd hh24:mi')
from dba_hist_snapshot
where begin_interval_time>to_date('20100519','yyyymmdd') and end_interval_time<(to_date('20100519','yyyymmdd')+1);

select case when 1<>2 and to_date('20100506','yyyymmdd')+5<to_date('20100520','yyyymmdd') then 'union' else ';' end varunion  from dual;

alter profile GMCCPWD LIMIT PASSWORD_LIFE_TIME UNLIMITED;

select * from
  (select owner,sum_MB,rownum num from (
    select owner,sum(bytes)/1024/1024 sum_MB
    from dba_segments
    where tablespace_name='USERS'
    group by owner
    order by 2 desc))
where owner='XJ_EXP_DATA';


set serveroutput on
declare
  v_beg_date char(8);--开始查询日期
  v_end_date char(8);--结束查询日期
  i_interval number;--每次查询间隔天数
  n_beg_snap_id number;--每次查询所开始的快照
  n_end_snap_id number;--每次查询所结束的快照
  v_union varchar(50);
 begin
   v_beg_date:='20100421';
   v_end_date:='20100520';
   i_interval:=5;
   for i in (
     select date_char,INSTANCE_NUMBER,min(snap_id) min_snap_id,max(snap_id) max_snap_id from
      (select to_char(to_date(v_beg_date,'yyyymmdd')+(rownum-1)*i_interval,'yyyymmdd') date_char from dual connect by level<(to_date(v_end_date,'yyyymmdd')-to_date(v_beg_date,'yyyymmdd'))/i_interval+1) a,
      dba_hist_snapshot b
     where to_char(begin_interval_time,'yyyymmdd')=date_char
     group by date_char,INSTANCE_NUMBER
     order by 1,2)
   loop
   select case when i.INSTANCE_NUMBER=1 or (to_date(i.date_char,'yyyymmdd')+i_interval<to_date(v_end_date,'yyyymmdd')) then 'union' else 'order by snap_id,INSTANCE_NUMBER;' end varunion into v_union  from dual;
   dbms_output.put_line('--查询'||i.date_char||'日'||i.INSTANCE_NUMBER||'结点情况');
   dbms_output.put_line('select a.INSTANCE_NUMBER,a.snap_id,to_char(begin_interval_time,''yyyymmdd hh24:mi:ss'')||''-''||to_char(end_interval_time,''yyyymmdd hh24:mi:ss'') TIME,PARSING_SCHEMA_NAME,cpu_times,to_char(round(cpu_times/sum_time,2)*100)||''%'' percent from');
   dbms_output.put_line('  (select INSTANCE_NUMBER,snap_id,PARSING_SCHEMA_NAME,round(sum(CPU_TIME_DELTA)/1000000,2) AS cpu_times from WRH$_SQLSTAT where (SNAP_ID between '||i.min_snap_id||' and '||i.max_snap_id||')  group by PARSING_SCHEMA_NAME,snap_id,INSTANCE_NUMBER) a,');
   dbms_output.put_line('  (SELECT INSTANCE_NUMBER,snap_id,round(SUM(CPU_TIME_DELTA)/1000000,2) sum_time FROM WRH$_SQLSTAT where SNAP_ID between '||i.min_snap_id||' and '||i.max_snap_id||' group by snap_id,INSTANCE_NUMBER) b,');    
   dbms_output.put_line('  dba_hist_snapshot c');
   dbms_output.put_line('where a.snap_id=b.snap_id and c.snap_id=a.snap_id and a.INSTANCE_NUMBER=b.INSTANCE_NUMBER and c.INSTANCE_NUMBER=a.INSTANCE_NUMBER and PARSING_SCHEMA_NAME=''ITMUSER1'' and a.INSTANCE_NUMBER='||i.INSTANCE_NUMBER);
   dbms_output.put_line(v_union);
   end loop;
 end;
 /
 
 //itmuser1消耗(每隔五天，每个snap_id的统计值)
set line 2300
set pagesize 1000
col module for a50
col sql_text for a2000
set pagesize 1000
select  a.PARSING_SCHEMA_NAME,a.snap_id,to_char(c.begin_interval_time,'yyyymmdd hh24:mi:ss')||'-'||to_char(c.end_interval_time,'yyyymmdd hh24:mi:ss') TIME,a.INSTANCE_NUMBER,a.cpu_times as 用户cpu消耗时间,b.sum_time as 总cpu时间,ROUND(a.cpu_times/b.sum_time*100,4) as 消耗cpu百分比
from
(select PARSING_SCHEMA_NAME,snap_id,INSTANCE_NUMBER,round(sum(CPU_TIME_DELTA)/1000000,4)AS cpu_times,round(sum(ELAPSED_TIME_DELTA)/1000000,4)AS elapsed_time
from WRH$_SQLSTAT  group by PARSING_SCHEMA_NAME,snap_id,INSTANCE_NUMBER) a ,
(SELECT snap_id,instance_number,round(SUM(CPU_TIME_DELTA)/1000000,4) sum_time  FROM WRH$_SQLSTAT  group by snap_id,INSTANCE_NUMBER) b,
dba_hist_snapshot c
where a.snap_id=b.snap_id and a.snap_id=c.snap_id and a.instance_number=c.instance_number
and to_char(c.begin_interval_time,'yyyymmdd') in (select to_char(to_date('20100420','yyyymmdd')+(rownum-1)*5,'yyyymmdd')  from dual connect by level<(to_date('20100520','yyyymmdd')-to_date('20100420','yyyymmdd'))/5+1)
and a.instance_number=b.instance_number and a.parsing_schema_name='ITMUSER1' order by a.instance_number,a.snap_id;

alter table fszwhis.IB_DG_WOFFLOG drop premary key;

赋权问题
视图frnt.TW_BASS_USR_MO_201005对应表为EDS.TW_BASS_USR_MO_201005、eds.TW_GMCC_USR_VEST_MO_201005
除了要把frnt.TW_BASS_USR_MO_201005的对象权限赋予fquery外，
另外还得将EDS.TW_BASS_USR_MO_201005及eds.TW_GMCC_USR_VEST_MO_201005的对象权限赋予frnt用户(with grant option)。

查CPU
cd  /usr/sbin/
psrinfo -p
psrinfo
parallel_threads_per_cpu

--精确计算
ls -ltr *st*|awk '{print $9}'|xargs du -sg|awk '{print $1}'|xargs|tr ' ' '+'|bc
--粗略计算
echo $(($(ls -ltr *fs* *st* *dg*|awk '{print $9}'|xargs du -sg|awk '{print $1}'|xargs|tr ' ' '+')))

--查AWR报告性能指标
echo $(cat test.txt|grep "Buffer  Hit"|awk '{print $4}')" NULL "$(cat test.txt|grep "Library Hit"|awk '{print $4}')" NULL "$(cat test.txt|grep "Latch Hit"|awk '{print $9}')" NULL "$(cat test.txt|grep "In-memory Sort"|awk '{print $8}')


grep "Logical reads"|"Physical reads"|"Physical writes"|"Transactions"|"Executes" test.txt


--ftp 传输文件
for i in 10.243.208.3 10.243.208.5 10.243.208.7 10.243.208.9 10.243.208.11 10.243.208.31 10.243.208.33 10.243.208.35 10.243.208.37 10.243.208.39 10.243.208.41
do
ftp -n ${i} <<!
user xjljy rrandcc123
bin
prompt off
cd /home/xjljy
put login.sql
bye
!
done
  
--解压文件
gzip -d awrrpt_1_51812_51932.html.gz

--分割文件
if 文件名　of 子文件名　count切割单位记录数　skip 切割起点 bs以多少字节为１次切割单位

dd if=test.gz of=test.gz.dd1 bs=1 count=30000
dd if=test.gz of=test.gz.dd2 bs=1 count=30000 skip=30000
dd if=test.gz of=test.gz.dd3 bs=1 count=19211 skip=60000

dd if=test.gz.dd1 of=test.gz bs=1 count=30000
dd if=test.gz.dd2 of=test.gz bs=1 count=30000 seek=30000
dd if=test.gz.dd3 of=test.gz bs=1 count=19211 seek=60000

--合并脚本
#!/bin/sh
FILEa=test1.txt
FILEb=test2.txt
NUM1=`wc -l ${FILEa} | awk '{print $1}'`
NUM2=`wc -l ${FILEb} | awk '{print $1}'`
if [ "$NUM1" -lt "$NUM2" ]; then
LONG=$NUM2
else
LONG=$NUM1
fi
i=1
while [ "$i" -le "$LONG" ]
do
echo `sed -n "${i}p" ${FILEa}` `sed -n "${i}p" ${FILEb}`
let i=$i+1
done

--基于时间找文件
find . -mtime +2 |xargs ls -ltr|pg

find . -ctime -2 |xargs ls -ltr|awk '{print $5}'|xargs|tr ' ' '+'|bc

--列情况
  SELECT OWNER,TABLE_NAME,COLUMN_NAME,DATA_TYPE FROM DBA_TAB_COLUMNS where owner in (
 'VENUS',
 'VENUS2',
 'VENUS1',
 'ITMUSER1',
 'JIANKONG',
 'OUTLN',
 'XJ_EXP_DATA',
 'AIUAP'
 )ORDER BY 1,2
 
 
oradebug setmypid
oradebug unlimit;
oradebug hanganalyze 2;


ls -lut 


--查询SYS审计，最好是基于表空间名字查 
ls -ltr|awk '{if($6=="Jun"&&$7=="02") {print "echo \""$9"\"\n grep -i TO_CDR_201004 "$9}}'|cat>/tmp/get.sh


imp USERID=xj_exp_data/gmcc123@tydb1 FROMUSER=test TOUSER=test2 file=test.dmp GRANTS=n TABLES=tb
date +%b' '%d' '%H:%M:%S
exp USERID=xj_exp_data/gmcc123@tydb1 owner=LOGON file=LOGON.dmp
date +%b' '%d' '%H:%M:%S
imp USERID=xj_exp_data/gmcc123@tydb1 FROMUSER=TYYYHIS TOUSER=test file=TYYYHIS.dmp GRANTS=n TABLES=CS_SMS_SMPPROCESS

exp USERID=xj_exp_data/fred_2010 direct=y  tables=stzw.IB_WL_rtdeductlog file=exp_STZW_IB_WL_rtdeductlog.dmp
imp USERID=system/oracle file=exp_STZW_IB_WL_rtdeductlog.dmp log=exp_STZW_IB_WL_rtdeductlog.log full=y commit=y ignore=y BUFFER=100000 STATISTICS=none

--查询审计策略
set lin 200 pagesize 0  
col AUD for a200
select max(substr(user_name,2))||'^'||AUDIT_OPTION AUD from
  (select sys_connect_by_path(user_name,',') user_name,AUDIT_OPTION from
    (select user_name,AUDIT_OPTION,AUDIT_OPTION||rn rchild,AUDIT_OPTION||(rn-1) rfather from
      (select user_name,AUDIT_OPTION,row_number() over (PARTITION BY AUDIT_OPTION order by user_name) rn from
        (select user_name,max(substr(AUDIT_OPTION,2)) AUDIT_OPTION from
          (select user_name,sys_connect_by_path(AUDIT_OPTION,',') AUDIT_OPTION from
            (select user_name,AUDIT_OPTION,user_name||rn rchild,user_name||(rn-1) rfather from
              (select user_name,AUDIT_OPTION,row_number() over (PARTITION BY user_name order by AUDIT_OPTION) rn from
                 (select USER_NAME,PRIVILEGE AUDIT_OPTION from DBA_PRIV_AUDIT_OPTS union select USER_NAME,AUDIT_OPTION from DBA_STMT_AUDIT_OPTS order by 1,2)))
          CONNECT BY PRIOR rchild=rfather START WITH rfather LIKE '%0')
        group by user_name)))
  CONNECT BY PRIOR rchild=rfather START WITH rfather LIKE '%0')
group by AUDIT_OPTION;

select user_name||'^'||AUDIT_OPTION AUD from
  (select user_name,max(substr(AUDIT_OPTION,2)) AUDIT_OPTION from
          (select user_name,sys_connect_by_path(AUDIT_OPTION,',') AUDIT_OPTION from
            (select user_name,AUDIT_OPTION,user_name||rn rchild,user_name||(rn-1) rfather from
              (select user_name,AUDIT_OPTION,row_number() over (PARTITION BY user_name order by AUDIT_OPTION) rn from
                 (select USER_NAME,PRIVILEGE AUDIT_OPTION from DBA_PRIV_AUDIT_OPTS union select USER_NAME,AUDIT_OPTION from DBA_STMT_AUDIT_OPTS order by 1,2)))
          CONNECT BY PRIOR rchild=rfather START WITH rfather LIKE '%0')
        group by user_name)
order by AUDIT_OPTION,user_name;

select USER_NAME,PRIVILEGE AUDIT_OPTION from DBA_PRIV_AUDIT_OPTS where USER_NAME='CXDBA'
union
select USER_NAME,AUDIT_OPTION from DBA_STMT_AUDIT_OPTS where USER_NAME='CXDBA';

--查询历史数据表分布
alter session set nls_date_format='yyyymmdd';
select TABLE_OWNER,TABLE_NAME,max(substr(MONTH,2)) MONTH FROM 
 (SELECT TABLE_OWNER,TABLE_NAME,sys_connect_by_path(MONTH,',') MONTH FROM 
 (SELECT TABLE_OWNER,TABLE_NAME,MONTH,TABLE_OWNER||TABLE_NAME||rn rchild,TABLE_OWNER||TABLE_NAME||(rn-1) rfather from 
 (SELECT test.TABLE_OWNER,test.TABLE_NAME ,test.MONTH,row_number() over (PARTITION BY test.TABLE_OWNER||test.TABLE_NAME ORDER BY test.MONTH) rn FROM 
 (select a.TABLE_OWNER,a.TABLE_NAME,to_char(decode(min(a.MONTH)||'-'||max(a.MONTH),max(a.MONTH)||'-'||min(a.MONTH),to_char(min(a.MONTH)),min(a.MONTH)||'-'||max(a.MONTH))) month from 
 (select t.TABLE_OWNER,t.TABLE_NAME,to_date(substr(t.PARTITION_NAME,-6,6),'yyyymm') MONTH 
 from dba_tab_partitions t,dba_segments s
 where t.TABLE_OWNER=s.owner and t.TABLE_NAME=s.SEGMENT_NAME and t.PARTITION_NAME=s.PARTITION_NAME and
 t.TABLE_OWNER='YYGZ' and t.PARTITION_NAME not like '%MAX' and bytes/1024/1024>1
 order by t.TABLE_OWNER,t.PARTITION_NAME) a 
 group by ADD_MONTHS(a.MONTH,-rownum),a.TABLE_OWNER,a.TABLE_NAME) test)) 
 CONNECT BY PRIOR rchild=rfather START WITH rfather LIKE '%0') 
GROUP BY TABLE_OWNER,TABLE_NAME; 

orapwd file=/oracle/products/10.2/db/dbs/orapwcdr1 password=10Jz4paT force=y

--数据字典统计收集
exec DBMS_STATS.GATHER_DICTIONARY_STATS ( options =>'GATHER AUTO');

--最新文件
ls -lut

11g -log
/home/oracle/app/oracle/diag/rdbms/ora21/ora21/trace/alert_ora21.log
/home/oracle/app/oracle/diag/rdbms/*/*/trace/*.log
$ echo $ORACLE_HOME
/home/oracle/app/oracle/11.1/db

--检查索引
select * from dba_tables where degree > '1' and owner LIKE '__ZW';
select OWNER,INDEX_NAME,DEGREE,STATUS from dba_indexes where  (degree> '1' or status != 'VALID') AND OWNER LIKE '__ZW' and status!='N/A';
select INDEX_OWNER,INDEX_NAME,PARTITION_NAME,STATUS from dba_ind_partitions WHERE   INDEX_OWNER LIKE '__ZW' and status != 'USABLE';
select owner,table_name,constraint_name,status from dba_constraints where owner like '__ZW' and status != 'ENABLED';

--字符
OLDPATH=/home/xjljy/mvtest/aa3
STR=aa
PRE=${OLDPATH%/*}
LAST=${OLDPATH##*/}
RESULT=${PRE}/${STR}/${LAST}

--高消耗语句查询
select  a.PARSING_SCHEMA_NAME,a.INSTANCE_NUMBER,a.sql_id,a.execs as 执行次数,ROUND(a.cpu_times/a.execs,2)as 单次执行时间,a.cpu_times as cpu消耗时间,ROUND(a.cpu_times/b.sum_time*100,2) as 消耗cpu百分比,a.buffer_gets as 逻辑读,ROUND(a.buffer_gets/b.sum_buffer*100,2) as 逻辑读百分比,a.disk_read as 物理读,ROUND(a.disk_read/b.sum_disk*100,2) as 物理读百分比 from
  (select PARSING_SCHEMA_NAME,INSTANCE_NUMBER,sql_id,sum(EXECUTIONS_DELTA)AS execs,round(sum(CPU_TIME_DELTA)/1000000,2)AS cpu_times,round(sum(ELAPSED_TIME_DELTA)/1000000,2)AS elapsed_time,sum(BUFFER_GETS_DELTA)AS  buffer_gets,sum(DISK_READS_DELTA)AS disk_read
     from sys.WRH$_SQLSTAT where SNAP_ID=61920 and INSTANCE_NUMBER=1 group by PARSING_SCHEMA_NAME,INSTANCE_NUMBER,sql_id) a ,
  (SELECT round(SUM(CPU_TIME_DELTA)/1000000,2) sum_time ,SUM(BUFFER_GETS_DELTA) sum_buffer,sum(DISK_READS_DELTA) sum_disk FROM sys.WRH$_SQLSTAT where (SNAP_ID=61920) and INSTANCE_NUMBER=1) b
where a.execs>0 order by cpu消耗时间 desc

select  a.PARSING_SCHEMA_NAME,a.INSTANCE_NUMBER,a.sql_id,a.execs as 执行次数,case when a.execs>0 then ROUND(a.cpu_times/a.execs,2) else null end as 单次执行时间,a.cpu_times as cpu消耗时间,ROUND(a.cpu_times/b.sum_time*100,2) as 消耗cpu百分比 from
  (select PARSING_SCHEMA_NAME,INSTANCE_NUMBER,sql_id,sum(EXECUTIONS_DELTA)AS execs,round(sum(CPU_TIME_DELTA)/1000000,2)AS cpu_times,round(sum(ELAPSED_TIME_DELTA)/1000000,2)AS elapsed_time,sum(BUFFER_GETS_DELTA)AS  buffer_gets,sum(DISK_READS_DELTA)AS disk_read
     from sys.WRH$_SQLSTAT where SNAP_ID=61920 and INSTANCE_NUMBER=1 group by PARSING_SCHEMA_NAME,INSTANCE_NUMBER,sql_id) a ,
  (SELECT round(SUM(CPU_TIME_DELTA)/1000000,2) sum_time ,SUM(BUFFER_GETS_DELTA) sum_buffer,sum(DISK_READS_DELTA) sum_disk FROM sys.WRH$_SQLSTAT where (SNAP_ID=61920) and INSTANCE_NUMBER=1) b
where 1=1 order by cpu消耗时间 desc;


select INSTANCE_NUMBER,PARSING_SCHEMA_NAME,sql_id,execs,sum_cpu_time,per_cpu_time from
  (select INSTANCE_NUMBER,PARSING_SCHEMA_NAME,sql_id,execs,sum_cpu_time,case when execs>0 then ROUND(sum_cpu_time/execs,2) else null end as per_cpu_time,row_number() over (PARTITION BY substr(PARSING_SCHEMA_NAME,3,2)||INSTANCE_NUMBER order by sum_cpu_time desc) rn from(
      SELECT a.PARSING_SCHEMA_NAME,a.INSTANCE_NUMBER,a.sql_id,sum(a.EXECUTIONS_DELTA) AS execs,round(sum(a.CPU_TIME_DELTA)/1000000,2)AS sum_cpu_time
      FROM sys.WRH$_SQLSTAT a,dba_hist_snapshot b
      where a.snap_id=b.snap_id and a.instance_number=b.instance_number 
        and b.snap_id in(select snap_id from dba_hist_snapshot where to_char(begin_interval_time,'yyyymmdd')='20100617')
        and a.PARSING_SCHEMA_NAME in(select username from dba_users where username like '__YY' or username like '__ZW')
      group by a.PARSING_SCHEMA_NAME,a.INSTANCE_NUMBER,a.sql_id
      order by a.instance_number,sum_cpu_time desc)
  where execs=0 or sum_cpu_time/execs>1)
where rn<11 order by INSTANCE_NUMBER,sum_cpu_time desc;

SELECT a.instance_number,round(SUM(CPU_TIME_DELTA)/1000000,4) sum_time
FROM sys.WRH$_SQLSTAT a,dba_hist_snapshot b
where a.snap_id=b.snap_id and a.instance_number=b.instance_number and b.snap_id in(select snap_id from dba_hist_snapshot where to_char(begin_interval_time,'yyyymmdd')='20100617')
group by a.INSTANCE_NUMBER
order by a.instance_number;

--imp导数
imp USERID=xj_exp_data/gmcc123@tydb1 IGNORE=y  FROMUSER=TYZW TOUSER=TYZW file=TYZW.dmp GRANTS=n TABLES=IB_DT_REQRULEDESC LOG=IB_DT_REQRULEDESC.log

--两阶段事务故障处理
报错内容：
ORA-01591: lock held by in-doubt distributed transaction 310.5.1383252 FILE:
处理方法：
rollback work force '310.5.1383252';
commit;
exec dbms_transaction.PURGE_LOST_DB_ENTRY('310.5.1383252');
commit;
检查：
select * from pending_trans$  where LOCAL_TRAN_ID='310.5.1383252';
结果为“no rows selected”即可。

--日常巡检
操作系统配置　　prtconf
数据库版本　CRS版本 select * from v$version;
主机负荷检查　
vmstat 2 10
vmstat -s
数据库初始化参数
strings /dev/rdg_spfile

--关闭数据库(单实例)
确定实例
select instance_name from v$instance;
alter system switch logfile;
shutdown immediate;
徐亿鹏
--oracle目录清理
1、/oracle/products/10.2/db/network/log
注：需用以cat方式清理
2、/oracle/products/admin/szdb/bdump
注：cdmp目录均可以用rm -rf清理
find . -type d
3、/oracle/products/admin/
注：较大的trc文件可以用cat /dev/null>方式清理
ls -ltr |grep trc|awk '{if($5>1048576)print $9}'|xargs du -sm
find . -size +1048 -exec ls -alt {} \;
4、/oracle/products/OracleHomes/agent10g/S3_C_YZ_YZSJK/sysman/emd

--根据log日志查找dmp文件
1、找出相关log日志
grep -r CS_REC_RECEPTION * |grep exported|grep 200708|grep -v '0 rows'|grep MM
2、查看log日志
找出大小以及dmp文件
 /oracle/datadump/move_tab/gz/exp_gzyyhis0203.dmp
 06 February, 2009 19:34:34
 293.0 GB


#◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇
#◇◆常用模板◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◆◇
#◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆◇
--后台跑脚本模板
nohup sh altertable_dg.sh > altertable_dg.out &

--后台ftp模板
HOST_IP=10.244.148.210
USRNM=oracle
PWD=oracle
ftp -inv $HOST_IP  <<! 
user $USRNM $PWD
bin
prompt off
mput czyy/exp_CZYYHIS_20091214*
mput dgyy/exp_DGYYHIS_20091214*
mput hyyy/exp_HYYYHIS_20091214*
mput swyy/exp_SWYYHIS_20091214*
close
bye
!
exit

--后台SQL脚本
. ~/.profile
sqlplus / as sysdba <<EOF
set echo on
set verify on
spool create_tab.log
@sz/sz/sz_yy_dat.TXT
spool off
exit
EOF

--导数评估
userid=system/oracle
SCHEMAS=yygz
logfile=exp_YYGZ_20100402.log
parallel=4
exclude=trigger,grant
ESTIMATE_ONLY=y

--存储过程
--有误，待修正
set serveroutput on
declare
v_str varchar2(200);
begin
for i in (select username 
			from dba_users 
			where username like 
			'%ZW' 
			and account_status='OPEN'
		  )
loop
	v_str :='truncate table '||i.username||'.'||'CH_ZJTY_BOSSSUCCHIS;';
	--dbms_output.put_line(v_str);
	execute v_str;
	dbms_output.put_line('CH_ZJTY_BOSSSUCCHIS has been truncated!');
end loop;
end;
/
set serveroutput off

--导出脚本
userid=xj_exp_data/fred-2009
directory=MOVE_TEMP 
dumpfile=expdp_dgzw_20100401_%u.dmp 
logfile=expdp_dgzw_20100401.log
EXCLUDE=indexes,statistics,grants 
parallel=2
tables=(
DGZW.RB_PF_BALANCETYPE,
DGZW.RB_CBB_UNWOFFCUST,
DGZW.RB_CBA_EBOXUNITDETHIS,
DGZW.RB_CBA_EBOXUNITDET,
DGZW.RB_SB_BALANCE)

--导入脚本
userid=system/oracle
directory=GZDUMP
dumpfile=exp_GZYYHIS_20100208_his%u.dmp
logfile=imp_GZYYHIS_20100221_01.log
parallel=1
remap_schema=GZYYHIS:YYGZ
INCLUDE=TABLE_DATA
TABLE_EXISTS_ACTION=append
remap_tablespace=(
gz_CM_DATA:yy_gz_dat,
gz_CS_DATA:yy_gz_dat,
yy_gz_datA:yy_gz_dat,
gz_MM_DATA:yy_gz_dat,
gz_OT_DATA:yy_gz_dat,
gz_PCSA_DATA:yy_gz_dat,
gz_MCM_DATA:yy_gz_dat,
gz_MLM_DATA:yy_gz_dat,
gz_YYO_DATA:yy_gz_dat,
gz_CM_IND:yy_gz_idx,
gz_CS_IND:yy_gz_idx,
gz_YY_IND:yy_gz_idx,
gz_MM_IND:yy_gz_idx,
gz_OT_IND:yy_gz_idx,
gz_PCSA_IND:yy_gz_idx,
gz_MCM_IND:yy_gz_idx,
gz_MLM_IND:yy_gz_idx,
gz_YYO_IND:yy_gz_idx,
gz_his_data:yy_gz_dat,
gz_his_ind:yy_gz_idx
)
tables=(
GZYYHIS.CS_ACC_COLLECT:CS_ACC_COLLECT_200905
GZYYHIS.CS_ACC_CYCLEINVOICE:CS_ACC_CYCLEINVOICE_200905
GZYYHIS.CS_ACC_CYCLEINVOICEBILLITEM:CC_CYCLEINVOICEBILLITEM_200905
GZYYHIS.CS_ACC_INVPRINTLOG:CS_ACC_INVPRINTLOG_200905
GZYYHIS.CS_ACC_OUTCOLLECT:CS_ACC_OUTCOLLECT_200905
GZYYHIS.CS_CWL_REVENUE:CS_CWL_REVENUE_200905
GZYYHIS.CS_CWL_WORKLOAD:CS_CWL_WORKLOAD_200905
GZYYHIS.CS_REC_ACCOUNT:CS_REC_ACCOUNT_200905
GZYYHIS.CS_REC_CHANGE:CS_REC_CHANGE_200905
GZYYHIS.CS_REC_CUSTOMER:CS_REC_CUSTOMER_200905
GZYYHIS.CS_REC_FEE:CS_REC_FEE_200905
GZYYHIS.CS_REC_FEE_BREAK:CS_REC_FEE_BREAK_200905
GZYYHIS.CS_REC_INDIVIAL:CS_REC_INDIVIAL_200905
GZYYHIS.CS_REC_OPENCARDSHIS:CS_REC_OPENCARDSHIS_200907
GZYYHIS.CS_REC_PAYTYPE:CS_REC_PAYTYPE_200905
GZYYHIS.CS_REC_PRESENT:CS_REC_PRESENT_200905
GZYYHIS.CS_REC_PRIVILEGE:CS_REC_PRIVILEGE_200905
GZYYHIS.CS_REC_PRODATTR:CS_REC_PRODATTR_200905
GZYYHIS.CS_REC_PRODUCT:CS_REC_PRODUCT_200905
GZYYHIS.CS_REC_PROTOCOL_LOG:CS_REC_PROTOCOL_LOG_200905
GZYYHIS.CS_REC_RECEPTION:CS_REC_RECEPTION_200905
GZYYHIS.CS_REC_RESOURCE:CS_REC_RESOURCE_200905
GZYYHIS.CS_REC_SCORECHG:CS_REC_SCORECHG_200905
GZYYHIS.CS_REC_SUBS:CS_REC_SUBS_200905
GZYYHIS.CS_REC_VGOPUSERDATA:CS_REC_VGOPUSERDATA_200910
GZYYHIS.SP_WORKF_COMM_HIS:SP_WORKF_COMM_HIS_200910
GZYYHIS.SP_WORKF_OUTDETAIL:SP_WORKF_OUTDETAIL_200910
)

--月底维稳
--查看消耗大于20W的语句
col username for a15
col event for a40
select username,program,sql_id,event from v$session 
where sql_id in (select sql_id from v$sql_plan where cost>200000 and id=0);

--高并发语句  
 select sql_id,trim(program),count(*)
   from (select a.sql_id, program
           from v$session a
          where  a.status = 'ACTIVE'
            and a.sql_id is not null
         union all
         select a.PREV_SQL_ID as sql_id, program
           from v$session a
          where a.sql_id is null
            and a.status = 'ACTIVE')
  group by trim(program),sql_id
  having count(*)>1
  order by 3 desc;
  
select sql_id,count(*)
from (select a.sql_id
        from v$session a
       where  a.status = 'ACTIVE'
         and a.sql_id is not null
      union all
      select a.PREV_SQL_ID as sql_id
        from v$session a
       where a.sql_id is null and a.PREV_SQL_ID is not null
         and a.status = 'ACTIVE')
group by sql_id
having count(*)>1
order by 2 desc;


--强制走索引
select  /*+ full(a) parallel(a,8)*/ memservnumber from szyy.group_subs_member a where statusdate between to_date('20100601','yyyymmdd') and
to_date('20100630235959','yyyymmddhh24miss') and status = 'stcmInv' and shortnumber like '5%' and
memtype = 0;


移动表
--语句
ALTER TABLE FSZW.IB_DG_WOFFLOG MOVE PARTITION IB_DG_WOFFLOG201005 TABLESPACE FS_HIS_DATA UPDATE GLOBAL INDEXES PARALLEL 16;
ALTER TABLE FSZW.IB_DG_WOFFLOG PARALLEL 1;
ALTER INDEX FSZW.IDX_DG_WL_WOFFLOG1 REBUILD PARTITION IB_DG_WOFFLOG201005 PARALLEL 16;
ALTER INDEX FSZW.IDX_DG_WL_WOFFLOG1 PARALLEL 1;
--空间检查
select owner,SEGMENT_NAME,PARTITION_NAME,TABLESPACE_NAME from dba_segments where owner='FSZW' and SEGMENT_NAME='IB_DG_WOFFLOG' and PARTITION_NAME='IB_DG_WOFFLOG201005';
--并行度检查，需要为1
select owner,TABLE_NAME,degree from dba_tables where owner='FSZW' and TABLE_NAME='IB_DG_WOFFLOG';
--索引检查，需要为N/A或者VALID
select OWNER,INDEX_NAME,DEGREE,STATUS from dba_indexes where TABLE_OWNER='FSZW' and TABLE_NAME='IB_DG_WOFFLOG';
--分区索引检查，需为USABLE
select p.INDEX_OWNER,p.INDEX_NAME,p.PARTITION_NAME,p.STATUS
from dba_ind_partitions p,dba_indexes i
WHERE  p.INDEX_OWNER=i.OWNER and i.INDEX_NAME=p.INDEX_NAME and i.TABLE_OWNER='FSZW' and i.TABLE_NAME='IB_DG_WOFFLOG' and i.STATUS='N/A';
--约束检查，需为ENABLED
select owner,table_name,constraint_name,status from dba_constraints where owner ='FSZW' and table_name='IB_DG_WOFFLOG';

--并行度检查，需要为1
select owner,TABLE_NAME,degree,LOGGING from dba_tables where owner='VENUS1' and TABLE_NAME='CHKDUP_PROCESS';
--索引检查，需要为N/A或者VALID
select OWNER,INDEX_NAME,DEGREE,LOGGING,STATUS from dba_indexes where TABLE_OWNER='VENUS1' and TABLE_NAME='CHKDUP_PROCESS';
--分区索引检查，需为USABLE
select p.INDEX_OWNER,p.INDEX_NAME,p.PARTITION_NAME,p.STATUS
from dba_ind_partitions p,dba_indexes i
WHERE  p.INDEX_OWNER=i.OWNER and i.INDEX_NAME=p.INDEX_NAME and i.TABLE_OWNER='VENUS1' and i.TABLE_NAME='CHKDUP_PROCESS' and i.STATUS='N/A' and p.STATUS<>'N/A';

select p.INDEX_OWNER,p.INDEX_NAME,p.PARTITION_NAME,p.STATUS
from dba_ind_subpartitions p,dba_indexes i
WHERE  p.INDEX_OWNER=i.OWNER and i.INDEX_NAME=p.INDEX_NAME and i.TABLE_OWNER='VENUS1' and i.TABLE_NAME='CHKDUP_PROCESS' and i.STATUS='N/A';


监听器配置(参考dgdb1)
位置 $ORACLE_HOME/network/admin
#listener.ora
LISTENER_S1=
 (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS_LIST =
        (ADDRESS = (PROTOCOL = TCP)(HOST = s5yz_vip)(PORT = 1521)(QUEUESIZE=20)(IP = FIRST))
      )
    )
  )
LISTENER_S2=
 (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS_LIST =
        (ADDRESS = (PROTOCOL = TCP)(HOST = s6yz_vip)(PORT = 1521)(QUEUESIZE=20)(IP = FIRST))
      )
    )
  )

#tnsnames.ora
dgdb1 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 10.243.208.10)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = dgdb)
      (INSTANCE_NAME = dgdb1)
    )
  )
dgdb2 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 10.243.208.12)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = dgdb)
      (INSTANCE_NAME = dgdb2)
    )
  )
sdg =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 10.243.208.10)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = sdg)
    )
  )
ssw =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 10.243.208.12)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = ssw)
    )
  )
scz =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 10.243.208.12)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = scz)
    )
  )
shy =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 10.243.208.12)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = shy)
    )
  )

#/etc/hosts
###IP Addr for RAC3#####
10.243.208.9    S5_C_YZ_YZSJK
10.243.208.10   s5yz_vip
10.243.208.133  S5_C_YZ_YZSJK_BEIFEN

10.243.208.11   S6_C_YZ_YZSJK
192.168.208.11  s6yz_pri
10.243.208.12   s6yz_vip
10.243.208.134  S6_C_YZ_YZSJK_BEIFEN

#监听状态检查
lsnrctl status LISTENER_S1

LSNRCTL for IBM/AIX RISC System/6000: Version 10.2.0.4.0 - Production on 02-JUL-2010 10:32:47

Copyright (c) 1991, 2007, Oracle.  All rights reserved.

Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=s5yz_vip)(PORT=1521)(QUEUESIZE=20)(IP=FIRST)))
STATUS of the LISTENER
------------------------
Alias                     listener_s1
Version                   TNSLSNR for IBM/AIX RISC System/6000: Version 10.2.0.4.0 - Production
Start Date                12-JUN-2010 03:06:01
Uptime                    20 days 7 hr. 26 min. 46 sec
Trace Level               off
Security                  ON: Local OS Authentication
SNMP                      ON
Listener Parameter File   /oracle/products/10.2/db/network/admin/listener.ora
Listener Log File         /oracle/products/10.2/db/network/log/listener_s1.log
Listening Endpoints Summary...
  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=10.243.208.10)(PORT=1521)))
Services Summary...
Service "SYS$SYS.KUPC$S_1_20100702051844.DGDB" has 1 instance(s).
  Instance "dgdb1", status READY, has 1 handler(s) for this service...
Service "dgdb" has 1 instance(s).
  Instance "dgdb1", status READY, has 1 handler(s) for this service...
Service "dgdb_XPT" has 1 instance(s).
  Instance "dgdb1", status READY, has 1 handler(s) for this service...
Service "sdg" has 1 instance(s).
  Instance "dgdb1", status READY, has 1 handler(s) for this service...
The command completed successfully

#监听状态检查(另一个结点)
lsnrctl status LISTENER_S2

LSNRCTL for IBM/AIX RISC System/6000: Version 10.2.0.4.0 - Production on 02-JUL-2010 10:36:03

Copyright (c) 1991, 2007, Oracle.  All rights reserved.

Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=s6yz_vip)(PORT=1521)(QUEUESIZE=20)(IP=FIRST)))
STATUS of the LISTENER
------------------------
Alias                     listener_s2
Version                   TNSLSNR for IBM/AIX RISC System/6000: Version 10.2.0.4.0 - Production
Start Date                12-JUN-2010 03:06:10
Uptime                    20 days 7 hr. 29 min. 52 sec
Trace Level               off
Security                  ON: Local OS Authentication
SNMP                      ON
Listener Parameter File   /oracle/products/10.2/db/network/admin/listener.ora
Listener Log File         /oracle/products/10.2/db/network/log/listener_s2.log
Listening Endpoints Summary...
  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=10.243.208.12)(PORT=1521)))
Services Summary...
Service "dgdb" has 1 instance(s).
  Instance "dgdb2", status READY, has 1 handler(s) for this service...
Service "dgdb_XPT" has 1 instance(s).
  Instance "dgdb2", status READY, has 1 handler(s) for this service...
Service "scz" has 1 instance(s).
  Instance "dgdb2", status READY, has 1 handler(s) for this service...
Service "shy" has 1 instance(s).
  Instance "dgdb2", status READY, has 1 handler(s) for this service...
Service "ssw" has 1 instance(s).
  Instance "dgdb2", status READY, has 1 handler(s) for this service...
The command completed successfully

主机重启操作标准
1、请开发商停止应用
2、停止监听器
lsnrctl stop listener_s1/2(监听器名字)
监听器的配置见$ORACLE_HOME/network/admin/listener.ora
3、检查数据库是否还存在连接
ps Cef |grep LOCAL=NO
如果还有输出结果，类似于
  oracle  151610       1   0 09:23:58      -  0:00 oracledgdb1 (LOCAL=NO) 
  oracle  176186       1   0 18:09:51      - 10:20 oracledgdb1 (LOCAL=NO) 
  oracle  184408       1   0 12:18:05      -  0:05 oracledgdb1 (LOCAL=NO) 
  oracle  196744       1   0   Jun 30      -  0:02 oracledgdb1 (LOCAL=NO) 
  oracle  200906       1   0   Jun 29      -  3:09 oracledgdb1 (LOCAL=NO) 
  oracle  205002       1   0   Jun 29      -  0:00 oracledgdb1 (LOCAL=NO) 
说明数据库还存在连接，需要终止
4、终止数据连接(需要和局方负责人确认)
ps -ef |grep -v grep|grep LOCAL=NO |awk '{print $2}' |xargs kill -9
5、检查数据库运行状态
select group#, status, archived from v$log where status in ('ACTIVE', 'CURRENT');
要求当前ACTIVE状态的REDO LOG的数目不大于1个时，否则延迟关闭数据库，等待I/O量下降。
select RECOVERY_ESTIMATED_IOS,ACTUAL_REDO_BLKS,TARGET_REDO_BLKS,LOG_FILE_SIZE_REDO_BLKS,TARGET_MTtr,ESTIMATED_MTTR from v$Instance_recovery;
其中estimated_mttr表示可以接受的数据库启动时间，当数据库异常关闭时，启动时间可能达到此值。
6、确认数据库没有连接时，用如下命令停止数据库
srvctl stop instance -d dgdb -i dgdb1 -o immediate
在停库的时候，需要在另外的窗口观看报错日志
tail Cf alterdgdb1.log
7、停止crs
使用root用户停止crs
crsctl stop crs
检查crs是否已经完全停止,只剩下init.crsd进程则表示停止完成
ps -ef|grep crs
8、完成数据库停止
通知局方及主机负责人
以下为重启流程
1、与主机负责人确认HACMP已完成起动
2、启动crs
默认HACMP会自动将CRS起动，若没有自动起动，使用ROOT用户，用下面的命令起动CRS
crsctl start crs
起动完成后检查crs是否正常
crsctl check crs
crs_stat Ct
正常结果应为
CSS appears healthy
CRS appears healthy
EVM appears healthy
3、启动数据库
默认数据库会自动启动，如果没自动启动，则用一下命令
srvctl start instance -d dgdb -i dgdb1 
注：其中dgdb表示数据库名，实际操作时以实际数据库名替代
dgdb1表示需要停止的数据库实例名，实际操作时以实际数据库实例名代替
检查crs状态，确认服务已启动
crs_stat Ct
4、启动相关市公司服务
部署情况如下：
    GZDB1	广州前台
    GZDB2	广州后台
    SZDB1	深圳前台应用,公共数据
    SZDB2	深圳后台应用
    DGDB1	东莞 
    DGDB2	潮州 汕尾 河源 
    FSDB1	佛山(含顺德)
    FSDB2	茂名 湛江 阳江 韶关
    STDB1	汕头
    STDB2	惠州 肇庆 揭阳
    ZSDB1	清远 云浮 中山
    ZSDB2	江门 梅州 珠海
服务启停命令如下：
1)	启动服务：
srvctl start service -d dgdb -s sdg Ci dgdb1
2)	停止服务：
srvctl stop service -d dgdb -s sdg
注：
-i dgdb1 表示服务运行的实例
-s sdg 启动的服务名
停止服务时可以不指定实例名
5、启动监听
lsnrctl start listener_s1/2(监听器名)
检查监听状态
lsnrctl status listener_s1/2(监听器名)
    /home/oracle$lsnrctl status listener_s1
    LSNRCTL for IBM/AIX RISC System/6000: Version 10.2.0.2.0 - Production on 21-OCT-2008 18:08:48
    Copyright (c) 1991, 2005, Oracle.  All rights reserved.
    Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=s5yz_vip)(PORT=1521)(QUEUESIZE=20)(IP=FIRST)))
    STATUS of the LISTENER
    ------------------------
    Alias                     listener_s1
    Version                   TNSLSNR for IBM/AIX RISC System/6000: Version 10.2.0.2.0 - Production
    Start Date                22-AUG-2008 11:30:46
    Uptime                    60 days 6 hr. 38 min. 2 sec
    Trace Level               off
    Security                  ON: Local OS Authentication
    SNMP                      ON
    Listener Parameter File   /oracle/products/10.2/db/network/admin/listener.ora
    Listener Log File         /oracle/products/10.2/db/network/log/listener_s1.log
    Listening Endpoints Summary...
      (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=10.243.208.10)(PORT=1521)))
    Services Summary...
    Service "dgdb" has 1 instance(s).
      Instance "dgdb1", status READY, has 1 handler(s) for this service...
    Service "dgdb_XPT" has 1 instance(s).
      Instance "dgdb1", status READY, has 1 handler(s) for this service...
    Service "sdg" has 1 instance(s).
      Instance "dgdb1", status READY, has 1 handler(s) for this service...
    The command completed successfully
    
    输出文件说明：
    Instance "dgdb1"  Service "sdg" 等状态为READY
若实例及服务没有完成注册，使用下面命令手工注册
alter system register;                            
6、检查数据库状态
检查报警日志
检查文件系统
df -g
检查监听
lsnrctl status listener_s1
检查crs
crs_stat -t
检查数据库连接
sqlplus xxx/xxx@sdg
检查日志切换
分别连接RAC两个节点，确认日志切换是否正常。
alter system switch logfile;
alter system checkpoint;    
7、完成启动
通知局方及开发商负责人，数据库状态正常，可以启动应用
8、启动后台维护脚本
进程名字	      启动方式	                                  用户	  作用
Watchauth	      nohup sh /home/oracle/watchauth.sh & 	      root	  检查$ORA_CRS_HOME/crs/auth目录
monitor_kksfbc	nohup sh /home/oracle/kill_kksfbc.sh &	    oracle	检查异常等待进程
session_lock_ak	nohup sh /home/oracle/session_lock_ak.sh &	oracle	检查长时间锁定进程
listener_check	nohup sh /home/oracle/listener_check.sh &	  oracle	检查监听进程
0、存在风险
a.RAC其中一个节点HACMP重起后（如1号节点），原先自动转移至2号节点的VIP由于资源争用无法回切至1号节点，需重起2号节点的HACMP解决故障。
b.实例关闭过程中，由于存在过多的异常进程，长时间没有响应常规的数据库关闭方式（shutdown immediate），需手工中止数据库核心进程方式非正常关闭数据库。
c.实例关闭后，由于操作系统已标记为删除状态的共享内存段无法释放，需重起主机解决。
d.实例启动后，市公司服务自动切换至另一节点后由于资源争用无法正常回切，且导致市公司服务无法接受连接，需重起另一个实例解决故障。




9楼电脑密码
Shsnc2010/yzgmcc


//查找某表被锁住
set pages 130;
set lines 1300;
col object_name for a20;
col machine for a20;
col program for a20;
col killid for a30;
col os_pid format a20;

select object_name ,machine ,s.program ,
s.sid||','||s.serial# as killid,
p.spid as os_pid ,
s.sql_address,
l.locked_mode,
s.username,
s.process,
s.sql_id
from v$locked_object l,
dba_objects o ,v$session s ,v$process p
where l.object_id=o.object_id and l.session_id=s.sid
and s.paddr=p.addr 
and object_name=upper('&tablename') and o.owner=upper('&owner')
order by 1
;

--密码周期
dba_PROFILEs PASSWORD_LIFE_TIME

--归档
archive log list


--网管机oracle目录
/oracle/products/OracleHomes/oms10g/Apache/Apache/logs
/oracle/products/OracleHomes/oms10g/sysman/recv

--删除帐号
set lin 200 pagesize 500
col username for a12
col account_status for a25
col days for 9999.99
col sql for a50
select username,account_status,sysdate-LOCK_DATE days,case when sysdate-LOCK_DATE>=7 then 'drop user '||username||' cascade;' else 'alter user '||username||' account lock;' end SQL from dba_users where username in('SWWH01','SWWH02','TUGANG','SWYJH_M');


--查看位数
getconf LONG_BIT


产生随机数相关语句
--产生2010年5月1日到5月10日间的随机日期(含5月10日)
alter session set nls_date_format='yyyy-mm-dd';
SELECT TO_DATE(TRUNC(DBMS_RANDOM.VALUE(TO_CHAR(TO_DATE('2010-05-01','yyyy-mm-dd'),'J'),TO_CHAR(TO_DATE('2010-05-10','yyyy-mm-dd'),'J')+1)),'J') FROM DUAL;
--产生0到100间的整数
SELECT TRUNC(DBMS_RANDOM.VALUE(0, 100+1)) FROM DUAL;
--设置随机数种子，seed with a binary integer
execute dbms_random.seed(12345678);
--设置随机数种子，seed with a string (up to length 2000)
execute dbms_random.seed('Xjshsnc');
execute dbms_random.seed(TO_CHAR(SYSDATE,'MM-DD-YYYY HH24:MI:SS'));
--产生随机数，get a random 38-digit precision number, 0.0 <= value < 1.0
select dbms_random.value from dual;
--产生随机数，返回从-power(2,31)到power(2,31)的整数
select dbms_random.random from dual;
--产生随机数，get a random Oracle number x, low <= x < high
select dbms_random.value(5.20,13.14) from dual;
--产生随机数，get a random number from a normal distribution
--返回服从正态分布的一组数。此正态分布标准偏差为1，期望值为0。这个函数返回的数值中有68%是介于-1与+1之间，95%介于-2与+2之间，99%介于-3与+3之间
select dbms_random.normal from dual;
--产生随机字符串
    /*
    'u','U'  :  upper case alpha characters only
    'l','L'  :  lower case alpha characters only
    'a','A'  :  alpha characters only (mixed case)
    'x','X'  :  any alpha-numeric characters (upper)
    'p','P'  :  any printable characters
    */
col str for a30
select dbms_random.string('x',10) STR from dual;
--查看相应的text source 
select text from dba_source
where owner='SYS' and name = 'DBMS_RANDOM'and type = 'PACKAGE' 
order by line;


--循环例子
set serveroutput on
declare  
  i number:=0;  
  j number:=0;  
begin  
  for k in 1 .. 1000 loop  
    i:= dbms_random.normal;  
    if i > j  
    then j:=i;  
    end if;  
  end loop;  
    dbms_output.put_line(j);  
  end;  
 / 
 
--with写法范例
set lin 200 pagesize 500
col db_name for a10
col city_name for a10
with city as(
  select 'gz' city_name,1 db_id from dual union all
  select 'sz' city_name,2 db_id from dual union all
  select 'dg' city_name,3 db_id from dual union all
  select 'cz' city_name,3 db_id from dual union all
  select 'sw' city_name,3 db_id from dual union all
  select 'hy' city_name,3 db_id from dual
),
db as (
  select 'gzdb' db_name,1 db_id from dual union all
  select 'szdb' db_name,2 db_id from dual union all
  select 'dgdb' db_name,3 db_id from dual
)
select d.db_name,c.city_name
from city c,db d
where d.db_id=c.db_id
order by d.db_id,c.city_name;

--利用正则表达式匹配第2个结尾为;的项，结果为新奇士橙
select rtrim(regexp_substr('哈密瓜;新奇士橙;火龙果;李子'||';', '.*?'||';', 1, 2), ';') from dual;	

--利用正则表达式将一行以';'分隔内容转换为多行
select fruit from (
  select regexp_substr('哈密瓜;新奇士橙;火龙果;李子;西瓜','[^;]+',1,x.n) fruit 
  from dual a,
    (select rownum n from dual connect by rownum < length('哈密瓜;新奇士橙;火龙果;李子;西瓜')-length(replace('哈密瓜;新奇士橙;火龙果;李子;西瓜',';',''))+2)x
)

--替换右/左字符串gmcc,结果应为oracle
col str for a20
select rtrim('oraclegmccgmcc','gmcc') STR from dual;
select ltrim('gmccgmccoracle','gmcc') STR from dual;

--将以;分隔的行分为多行
col column_value for a20
SELECT column_value
FROM (SELECT ';'||'西瓜;荔枝;苹果;李子;哈密瓜;新奇士橙'||';' names FROM dual) t1,
      TABLE(CAST(MULTISET( SELECT SUBSTR (names,INSTR (names, ';', 1, LEVEL  ) + 1,INSTR (names, ';', 1, LEVEL+1) - INSTR (names, ';', 1, LEVEL) -1 ) FROM DUAL
        CONNECT BY LEVEL <= LENGTH(names)-LENGTH(REPLACE(names,';',''))-1 ) AS SYS.ODCIVARCHAR2LIST ) ) t2;

--将一行以';'分隔内容转换为多行
CREATE OR REPLACE TYPE type_split IS TABLE OF VARCHAR2 (4000); 
 
create or replace function split(p_list varchar2,p_sep varchar2 := ',') return type_split pipelined 
IS 
 l_idx pls_integer; 
 v_list varchar2(50) := p_list; 
 begin 
      loop 
           l_idx := instr(v_list,p_sep); 
           if l_idx > 0 then 
               pipe row(substr(v_list,1,l_idx-1)); 
               v_list := substr(v_list,l_idx+length(p_sep)); 
           else 
                pipe row(v_list); 
                exit; 
           end if; 
      end loop; 

      return; 
 end split; 


drop type type_split;
drop function split;

--AIX 翻阅之前命令
set -o vi
esc+- 翻阅之前命令

--查看约束情况 
select owner,TABLE_NAME,CONSTRAINT_NAME,CONSTRAINT_TYPE
from dba_constraints
where owner='GZYY' and TABLE_NAME='CM_GRP_BILLONCEMAIL';


--ddl格式设置
begin
  DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'TABLESPACE',FALSE);
  DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'STORAGE',FALSE);
  DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'CONSTRAINTS',FALSE);
  DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'REF_CONSTRAINTS',FALSE);
  DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'SEGMENT_ATTRIBUTES',FALSE);
  DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'CONSTRAINTS_AS_ALTER',FALSE);
  DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'SQLTERMINATOR',TRUE);
end;
/

begin
  DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'TABLESPACE',FALSE);
  DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'STORAGE',FALSE);
  DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'SQLTERMINATOR',TRUE);
  DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'SEGMENT_ATTRIBUTES',FALSE);
end;
/

--获取定义
. ~/.profile 
sqlplus -s /nolog  <<EOF
conn / as sysdba
set long 99999999
set pagesize 10000
set line 200
set longc 99999  --之前格式主因是没有设置此项
set head off
set feed off
spool /oracle/datadump/ddl.sql
select dbms_metadata.get_ddl('TABLE','BAT_BKJOB_PARA_HIS','GZYY')||';' from dual;
select dbms_metadata.get_ddl('TABLE','BAT_INSTALL_RESINFO','GZYY')||';' from dual;
select dbms_metadata.get_ddl('TABLE','CB_LOG_TRANSLOG','GZYY')||';' from dual;
select dbms_metadata.get_ddl('TABLE','CB_MUSIC_MUSICCLUB_OPR_BATCH','GZYY')||';' from dual;
select dbms_metadata.get_ddl('TABLE','CB_SP_BDREQ','GZYY')||';' from dual;
select dbms_metadata.get_ddl('TABLE','CB_SP_BIZPROCREQ','GZYY')||';' from dual;
spool off
exit
EOF


sqlplus命令
a(ppend) text
  往缓冲区当前行添加文本text，注意，如果text与命令间只有一空格，直接添加到行尾，如果要增加"and XXX=XX"之类的内容请添加两空格
c(hang)/old/new
  替换缓冲区当前行文本内容，注意，仅会替换第一个匹配的字符串，此外，字符串中可包含空格
c(hang)/text
  删除缓冲区当前行文本内容text，注意，仅会删除第一个匹配的字符串
i(nput) text
  在缓冲区当前行字后添加一行，文本内容为text，注意，文本内容结尾仅有一个;会自动和谐此字符，多个遭遇ORA-00911: invalid character吧！
del (n)
  删除缓冲区中内容的第n行，如果不给出n则为当前行
l(ist)
  显示缓冲区中所有行，并将当前行指向最后一行
l(ist) n
  显示缓冲区中第n行，并将当前行指向此行
l(ist) n m
  显示缓冲区中第n到m行，并将当前行指向第m行，注意，n<=m且n与m行存在
r(un)
  执行缓冲区中的命令
/
  效果同run
@filename
  执行文件名为filename的脚本，注意此文件名必须含扩展名，如果有且只有扩展名为.sql，则可忽略此扩展名
@@filename
  效果类似@filename，但用于脚本中再调用脚本的情况
save filename
  保存文件，如果filname中不包含扩展名则保存的文件名为filename.sql，否则为filename，可指定路径
get filename
  将filename对应内容调入缓冲区，filename扩展名方面的规则与save操作一致
start filename
  运行filename对应的脚本，filename扩展名方面的规则与save操作一致
edit
  编辑当前缓冲区中的内容(保存到afiedt.buf)，注意，如果没有配置变量EDITOR将失败，配置可参考export echo EDITOR=vi
edit filename
  编辑filename对应脚本，filename扩展名方面的规则与save操作一致
spool filename
  将之后的操作及结果存储到filename对应文件，filename扩展名方面的规范与save操作类似，但扩展名为lst，此外，如果对应文件存在其内容会被覆盖  
exit
  退出sqlplus
show user
  显示当前连接用户
show error
  显示错误信息，一般用于显示存储过程等中的错误
show all
  显示所有系统变量值，注意，如果想看具体某个变量值，可直接show，例如show autocommit
clear screen
  清空屏幕内容

sqlplus 格式预配置
    oracle支持自定义任意数量的sql*plus命令，这些命令会在成功启动sql*plus或者执行connect命令后自动执行。
影响这些命令的因素为两个文件：
   1、全局配置文件 此文件为$ORACLE_HOME/sqlplus/admin/glogin.sql，默认情况下成功启动sql*plus或者使用connect命令时会自动执行
   2、当前路径下的配置文件login.sql 如果此文件存在，oracle只会运行此文件，却忽略情况1中的提及的login.sql。
	如下login.sql文件可供参考
set termout off
define gname=idle
column global_name new_value gname
select lower(user)||'@'||lower(INSTANCE_NAME)||'('||lower(HOST_NAME)||')' global_name from v$instance;
alter session set nls_date_format='YYYY-MM-DD HH24:MI:SS';
set sqlprompt '&gname> '
set time on
set timing on
set termout on


--集市导入脚本
userid=xjwh01/xjwh2010  log=mzhyy.log      fromuser=zhyy    touser=zhboss    IGNORE=y file=mzhyy.dmp  GRANTS=n full=n rows=y commit=y buffer=3145728

--增加临时表空间
alter tablespace TEMP
add tempfile '/oracle/hisdata/temp_02.dbf' size 16380m autoextend off;


已经安装组件
V$OPTION

--
set serveroutput on
declare
v_num  number :=0;
v_sql varchar(1000);
begin
  for v_cursor in (select rowid from xj_exp_data.tmp_lvcheck) loop
      v_sql:='insert into sys.to_tmp_lvcheck(str01) select str01 from xj_exp_data.tmp_lvcheck where rowid='''||v_cursor.rowid||'''';
      --dbms_output.put_line(v_sql);
      execute immediate v_sql;
      v_sql:='delete from xj_exp_data.tmp_lvcheck where  rowid='''||v_cursor.rowid||'''';
      --dbms_output.put_line(v_sql);
      execute immediate v_sql;
      v_num:=v_num+1;
        if mod(v_num,5)=0 then
          commit;
          dbms_output.put_line('xj_exp_data.tmp_lvcheck 5 records committed...');
       end if;
  end loop;
  exception
  when others then
  rollback;
  dbms_output.put_line('Fail: '||v_sql);
end;
/

select /*+parallel(a,16)*/ userid,cast((from_tz(ntimestamp#,'00:00') at local) as date) timestamp,sqltext from xj_exp_data.AUD201006 a where obj$creator='GZYY' and obj$name='CM_CA_ACCOUNT';


 set autot on
 
 set autot off
 
 DROP PUBLIC DATABASE LINK BOSS15MON;
 
 CREATE PUBLIC DATABASE LINK BOSS15MON CONNECT TO BOSS15MON IDENTIFIED BY EdU7i#sRH USING 'boss15mon';
 
 
 create profile force_passwd limit
password_life_time 90
password_grace_time 10
password_reuse_time 1800
password_reuse_max unlimited
failed_login_attempts 3
password_lock_time 1/440
password_verify_function verify_function;


--恢复已删除的表
flashback table xj_exp_data.BBBBB to before drop;

--查询回收站
select OWNER,OBJECT_NAME,ORIGINAL_NAME,DROPTIME from DBA_RECYCLEBIN where owner='XJ_EXP_DATA' and ORIGINAL_NAME='FTEST';

alter table YYHZ.SP_WORKF_COMM_HIS split partition PART_MAX
at (TO_DATE(' 2010-06-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) 
into ( PARTITION SP_WORKF_COMM_HIS_201005 TABLESPACE HZ_YY_DAT COMPRESS,
   partition part_max TABLESPACE HZ_YY_DAT COMPRESS)
parallel 4 ;

col TABLE_OWNER for a8
col TABLE_NAME for a20
col PARTITION_NAME for a25
col HIGH_VALUE for a100
select TABLE_OWNER,TABLE_NAME,PARTITION_NAME,HIGH_VALUE
from dba_tab_partitions
where TABLE_OWNER  in ('YYHZ','HZYY','HZYYHIS') and TABLE_NAME in('SP_WORKF_COMM_HIS')
order by 1,2,3;



S7_C_YZ_YZSJK:/home/oracle$cat  monitor_kksfbc.sh
#!/bin/sh
ORACLE_HOME=/oracle/products/10.2/db
while [ true ]
do
$ORACLE_HOME/bin/sqlplus -S "/as sysdba" @sp << EOF
EOF
if [ `cat kill_kksfbc.sh|wc -l` -gt 0 ]
then
sh kill_kksfbc.sh
cp kill_kksfbc.sh ./ak_log/kill_kksfbc.sh.`date +%b_%d_%H_%M_%S`
>kill_kksfbc.sh
fi
sleep 60
done
S7_C_YZ_YZSJK:/home/oracle$cat clearcrslog.sh
tdir=/oracle/products/10.2/crs/srvm/auth/
ls -ltr $tdir |grep -v  "$(date -u +"%b %d")" |grep -v total|awk '{print "'"$tdir"'"$9}' |xargs rmdir

tdir=/oracle/products/10.2/crs/log/$(echo `hostname` |tr A-Z a-z)/client/
ls -ltr $tdir |grep -v  "$(date -u +"%b %d")" |grep -v total|awk '{print "'"$tdir"'"$9}' |xargs rm
S7_C_YZ_YZSJK:/home/oracle$cat watchauth.sh
#!/bin/sh
AUTHDIR=/oracle/products/10.2/crs/crs/auth
while [ true ]
do
if [ -d $AUTHDIR ]; then
  sleep 1
else
   NOW=`date`
   echo "The auth directory is not found at $NOW" >> /home/oracle/watchauth.log
   mkdir $AUTHDIR
   chown root:oinstall $AUTHDIR
   chmod 0755 $AUTHDIR
fi
sleep 10
done


--重建用户
SELECT 'create user '||USERNAME||' identified by values '''||PASSWORD||''' default tablespace '||DEFAULT_TABLESPACE||' temporary tablespace '||TEMPORARY_TABLESPACE||' quota unlimited on '||DEFAULT_TABLESPACE||';' FROM DBA_USERS WHERE USERNAME in('JYYY','ZQZW');
select 'grant '||PRIVILEGE||' to '||GRANTEE||';' from dba_sys_privs where GRANTEE in('JYYY','ZQZW');
select 'grant '||GRANTED_ROLE||' to '||GRANTEE||';' from DBA_ROLE_PRIVS where GRANTEE in('JYYY','ZQZW');
select 'grant '||PRIVILEGE||' on '||OWNER||'.'||TABLE_NAME||' to '||GRANTEE||';' from dba_tab_privs where GRANTEE in('JYYY','ZQZW');
select 'drop user '||username||' cascade;' from dba_users where USERNAME in('JYYY','ZQZW');


--测试分区表
  CREATE TABLE "XJ_EXP_DATA"."TEST_PAR"
   (    "USERNAME" VARCHAR2(30) NOT NULL ENABLE,
        "USER_ID" NUMBER NOT NULL ENABLE,
        "PASSWORD" VARCHAR2(30),
        "ACCOUNT_STATUS" VARCHAR2(32) NOT NULL ENABLE,
        "LOCK_DATE" DATE,
        "EXPIRY_DATE" DATE,
        "DEFAULT_TABLESPACE" VARCHAR2(30) NOT NULL ENABLE,
        "TEMPORARY_TABLESPACE" VARCHAR2(30) NOT NULL ENABLE,
        "CREATED" DATE NOT NULL ENABLE,
        "PROFILE" VARCHAR2(30) NOT NULL ENABLE,
        "INITIAL_RSRC_CONSUMER_GROUP" VARCHAR2(30),
        "EXTERNAL_NAME" VARCHAR2(4000),
        CONSTRAINT "PK_TEST_PAR" PRIMARY KEY ("USERNAME") ENABLE
   )
   PARTITION BY RANGE ("CREATED")
    (PARTITION "TEST_PAR_2006"  VALUES LESS THAN (TO_DATE(' 2007-01-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')),
     PARTITION "TEST_PAR_2007"  VALUES LESS THAN (TO_DATE(' 2008-01-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')),
     PARTITION "TEST_PAR_2008"  VALUES LESS THAN (TO_DATE(' 2009-01-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')),
     PARTITION "TEST_PAR_2009"  VALUES LESS THAN (TO_DATE(' 2010-01-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')),
     PARTITION "TEST_PAR_2010"  VALUES LESS THAN (TO_DATE(' 2011-01-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')),
     PARTITION "TEST_PAR_2011"  VALUES LESS THAN (TO_DATE(' 2012-01-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')),
     PARTITION "PART_MAX"  VALUES LESS THAN (TO_DATE(' 9999-12-31 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN'))
  )  ENABLE ROW MOVEMENT ;
   
  CREATE INDEX "XJ_EXP_DATA"."IDX_TEST_PAR1" ON "XJ_EXP_DATA"."TEST_PAR" ("USER_ID", "PASSWORD");
  
  insert into "XJ_EXP_DATA"."TEST_PAR"
  select * from dba_users;


--赋权
set serveroutput on
declare
v_sql varchar2(1000);
begin
  for v_cursor in ( 
    select b.username,a.owner,a.table_name from dba_tables a,
      (select username from dba_users where username like '__') b
    where (a.owner=b.username||'YY'  or a.owner=b.username||'ZW')
  ) loop
  v_sql := 'grant select,delete,update,insert on "'||v_cursor.owner||'"."'||v_cursor.table_name||'" to '||v_cursor.username;
    begin
      execute immediate v_sql;
      dbms_output.put_line('Sucess: '||v_sql);
    exception
      when others then
      dbms_output.put_line('Fail: '||v_sql);
    end;
  end loop;
end;
/


--批量建账号
set lin 200 pagesize 500
col user_name for a10
col SQL for a200
select SQL from(
  with userlist as(
    select 'gz' user_name from dual union all
    select 'st' user_name from dual union all
    select 'hz' user_name from dual union all
    select 'jy' user_name from dual union all
    select 'jm' user_name from dual union all
    select 'zs' user_name from dual union all
    select 'zh' user_name from dual union all
    select 'qy' user_name from dual union all
    select 'mz' user_name from dual union all
    select 'yf' user_name from dual union all
    select 'zq' user_name from dual union all
    select 'sz' user_name from dual union all
    select 'dg' user_name from dual union all
    select 'zj' user_name from dual union all
    select 'yj' user_name from dual union all
    select 'fs' user_name from dual union all
    select 'cz' user_name from dual union all
    select 'mm' user_name from dual union all
    select 'sg' user_name from dual union all
    select 'sw' user_name from dual union all
    select 'hy' user_name from dual
  )
  select  '--Begin to create user '||user_name||'.' SQL,10 ord,user_name from userlist union
  select 'create user '||user_name||' identified by gmcc123 default tablespace USERS temporary tablespace TEMP quota 2G on users;' SQL,20 ord,user_name from userlist union
  select 'grant create session,select any table to '||user_name||';' SQL,30 ord,user_name from userlist union
  select 'grant resource to '||user_name||';' SQL,40 ord,user_name from userlist union
  select  '--End of creating user '||user_name||'.' SQL,50 ord,user_name from userlist
)
order by user_name,ord asc;


with userlist as(
  select 'gz' user_name from dual union all
  select 'st' user_name from dual union all
  select 'hz' user_name from dual union all
  select 'jy' user_name from dual union all
  select 'jm' user_name from dual union all
  select 'zs' user_name from dual union all
  select 'zh' user_name from dual union all
  select 'qy' user_name from dual union all
  select 'mz' user_name from dual union all
  select 'yf' user_name from dual union all
  select 'zq' user_name from dual union all
  select 'sz' user_name from dual union all
  select 'dg' user_name from dual union all
  select 'zj' user_name from dual union all
  select 'yj' user_name from dual union all
  select 'fs' user_name from dual union all
  select 'cz' user_name from dual union all
  select 'mm' user_name from dual union all
  select 'sg' user_name from dual union all
  select 'sw' user_name from dual union all
  select 'hy' user_name from dual
)
select username,account_status from dba_users where username in (select upper(user_name) from userlist);

set serveroutput on
declare
v_sql varchar2(1000);
begin
  for v_cursor in ( 
    select b.username,a.owner,a.table_name from dba_tables a,
      (select username from dba_users where username like '__') b
    where (a.owner=b.username||'YY'  or a.owner=b.username||'ZW' or a.owner='COMMON')
  ) loop
  v_sql := 'grant select,delete,update,insert on "'||v_cursor.owner||'"."'||v_cursor.table_name||'" to '||v_cursor.username;
    begin
      execute immediate v_sql;
      --dbms_output.put_line('Sucess: '||v_sql);
    exception
      when others then
      dbms_output.put_line('Fail: '||v_sql);
    end;
  end loop;
end;
/

--查询序列情况
select SEQUENCE_OWNER,SEQUENCE_NAME,INCREMENT_BY,CACHE_SIZE from dba_SEQUENCEs where SEQUENCE_OWNER ='ZJYY' and SEQUENCE_NAME='S_SP_TRANS_SEQ';


conn fszhougongjian_s/gmcc123@(DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = 10.249.48.36)(PORT = 1521)) (CONNECT_DATA = (SERVER = DEDICATED) (SERVICE_NAME = ora11) (INSTANCE_NAME = ora11)))


--重新编译失效对象
@?/rdbms/admin/utlrp

--集市
$ . ~/.profile
$ nohup sh all.dm mon_ck.sql &

--undo 使用情况
col tablespace_name for a10
select a.owner,a.tablespace_name,a.status,a.use_mb,round(a.use_mb/b.total_mb*100) use_precent
from
(select owner,tablespace_name,status,sum(bytes)/1024/1024 use_mb from dba_undo_extents
 group by owner,tablespace_name,status) a, 
(select tablespace_name, sum(bytes)/1024/1024 total_mb from dba_data_files 
 where tablespace_name like '%UNDO%' group by tablespace_name) b
where a.tablespace_name=b.tablespace_name
order by 1,2,3;

--自动删除归档文件
0 * * * * /home/oracle/delete_arch.sh 1>/home/oracle/delete_arch.sh.out 2>&1 
$ more  /home/oracle/delete_arch.sh
. ~/.profile
rman target /  <<EOF
delete archivelog all;
yes
exit
EOF

--资源组
 select username, INITIAL_RSRC_CONSUMER_GROUP from dba_users order by 2,1;
 

--占用内存最多的会话
select * from( 
 select s.sid, s.serial#, s.username, s.program, s.module, s.machine, s.sql_id, s.prev_sql_id, p.spid, p.pga_alloc_mem
from v$session s, v$process p
where p.addr=s.paddr
order by p.pga_alloc_Mem desc
)where rownum<11;


--统计文件

#!/bin/sh
SUM=0
ls -l /oracle/audit_gz1|grep .aud | awk -v month="Jan" '$8=="2010"&&$6==month {print $5}'>yxzfile.txt
while read LINE
do
SIZE=`echo $LINE | awk '{print $1}'`
let SUM=SUM+SIZE
done<yxzfile.txt
echo "scale=3; ${SUM}/1024/1024" | bc


注：
因为在AIX中，ls -lrt显示的文件时间信息是半年以前的才显示年份，半年以内的显示为具体的时间hh24:mi，
所以如果要统计半年内的某个月时，需要修改$8=="2010"&&$6==month的筛选条件，如$8!="2009"&&$8!="2010"&&$6==month

由于每个月的文件太多，大约十几万个，所以循环求和花费的时间也较长

我在gzdb1中只需上述脚本，统计2010年一月的文件总大小为 247.516MB


--检查LV脚本
--lv_check.sh
lslv dg_yj_yy_gj_01n|grep -E "LV STATE|LOGICAL VOLUME">/tmp/lv_check.txt
lslv dg_yj_yy_gj_02n|grep -E "LV STATE|LOGICAL VOLUME">>/tmp/lv_check.txt
lslv dg_yj_yy_gj_03n|grep -E "LV STATE|LOGICAL VOLUME">>/tmp/lv_check.txt
lslv dg_yj_yy_gj_04n|grep -E "LV STATE|LOGICAL VOLUME">>/tmp/lv_check.txt
lslv dg_yj_yy_gj_05n|grep -E "LV STATE|LOGICAL VOLUME">>/tmp/lv_check.txt
lslv dg_yj_yy_gj_06n|grep -E "LV STATE|LOGICAL VOLUME">>/tmp/lv_check.txt
lslv dg_yj_yy_gj_07n|grep -E "LV STATE|LOGICAL VOLUME">>/tmp/lv_check.txt
lslv dg_yj_yy_gj_08n|grep -E "LV STATE|LOGICAL VOLUME">>/tmp/lv_check.txt
cat /tmp/lv_check.txt|awk '{if(index($0,"LOGICAL VOLUME")>0) {printf"%s ",$0} else {print $0}}'|awk '{print "    LV: "$3"    Status: "$12}'


--脱敏脚本（经过测试）
declare
cursor  cur_OPERID  is  select  OPERID from common.sa_so_operinfo;
var_OPERID  common.sa_so_operinfo.OPERID%type;
var_num  number;
begin
var_num:=0;
DBMS_OUTPUT.ENABLE ;
open cur_OPERID;
loop
exit  when cur_OPERID%notfound;
fetch cur_OPERID into var_OPERID;
update common.sa_so_operinfo set
  BIRTHDAY=to_date('2007-12-23 11:01:01','yyyy-mm-dd hh24:mi:ss'),
  CERTID='',
  HOMEADDRESS='',
  PRISOCIETYRELATION='',
  FAMILYDES='',
  FAX='',
  HOME_TELE='',
  EMAIL='',
  MSISDN=''
where OPERID=var_OPERID ;
var_num:=var_num+1;
if mod(var_num,10000)=0 then
   commit;
   dbms_output.put_line('common.sa_so_operinfo 10000 records committed...');
end if;
end loop;
close  cur_OPERID;
commit;
end;
/

--查看sga情况
select * from v$sgainfo;


--truncate表例子
ZHZW.IB_DG_WOFFLOG:IB_DG_WOFFLOG201002 

select bytes/1024/1024 MB from dba_segments where owner='ZHZWHIS' and segment_name='IB_DG_WOFFLOG' and partition_name='IB_DG_WOFFLOG201002';

--并行度检查，需要为1
select owner,TABLE_NAME,degree,LOGGING from dba_tables where owner='ZHZWHIS' and TABLE_NAME='IB_DG_WOFFLOG';
--索引检查，需要为N/A或者VALID
select OWNER,INDEX_NAME,DEGREE,LOGGING,STATUS from dba_indexes where TABLE_OWNER='ZHZWHIS' and TABLE_NAME='IB_DG_WOFFLOG';
--分区索引检查，需为USABLE
select p.INDEX_OWNER,p.INDEX_NAME,p.PARTITION_NAME,p.STATUS
from dba_ind_partitions p,dba_indexes i
WHERE  p.INDEX_OWNER=i.OWNER and i.INDEX_NAME=p.INDEX_NAME and i.TABLE_OWNER='ZHZWHIS' and i.TABLE_NAME='IB_DG_WOFFLOG' and i.STATUS='N/A' and p.STATUS<>'N/A';

select p.INDEX_OWNER,p.INDEX_NAME,p.PARTITION_NAME,p.STATUS
from dba_ind_subpartitions p,dba_indexes i
WHERE  p.INDEX_OWNER=i.OWNER and i.INDEX_NAME=p.INDEX_NAME and i.TABLE_OWNER='ZHZWHIS' and i.TABLE_NAME='IB_DG_WOFFLOG' and i.STATUS='N/A';


ALTER TABLE ZHZWHIS.IB_DG_WOFFLOG truncate PARTITION IB_DG_WOFFLOG201002 UPDATE GLOBAL INDEXES PARALLEL 16;


userid=xj_exp_data/fred_2010
directory=MOVE_ZH
dumpfile=exp_ZHZW_20100806_1_%u.dmp
logfile=imp_ZHZW_20100807.log
remap_schema=ZHZW:ZHZWHIS
INCLUDE=TABLE_DATA
TABLE_EXISTS_ACTION=append
tables=(
ZHZWHIS.IB_DG_WOFFLOG:IB_DG_WOFFLOG201002
)

创建序列
--create SEQUENCE seq
increment by 1
start with 1
nocycle
cache 2000
order;


---------测试准备-----------
export echo EDITOR=vi
cd /tmp
vi login.sql

set termout off
define gname=idle
column global_name new_value gname
alter session set nls_date_format='YYYY-MM-DD HH24:MI:SS';
select lower(user)||'@'||lower(INSTANCE_NAME)||'('||lower(HOST_NAME)||')' global_name from v$instance;
set sqlprompt '&gname> '
set time on
set timing on
set termout on
set lin 200 pagesize 500

create user crabbit identified by bear default tablespace users;
grant connect,resource to crabbit;
----------方法1-------------------------
create table crabbit.test_table(
id number,
num number,
dat date,
str varchar(10)
) nologging;

insert /*+append*/ into crabbit.test_table
select 
 rownum id,
 trunc(dbms_random.value(0,100),2) num,
 TO_DATE(trunc(DBMS_RANDOM.VALUE( TO_CHAR(TO_DATE('1980-01-01','yyyy-mm-dd'),'J'),TO_CHAR(TO_DATE('2020-01-01','yyyy-mm-dd'),'J')+1)) ,'J')+dbms_random.value dat,
 dbms_random.string('l',TRUNC(DBMS_RANDOM.VALUE(0, 10+1))) str
from dual connect by level < 1000000+1;
commit;

--创建约束，更改属性
alter table crabbit.test_table add constraint pk_test_table primary key(id) enable;
alter table crabbit.test_table logging;

----------方法2-------------------------
spool test
--播种
execute dbms_random.seed('crabbit');

--创建表（含一百万行数据）
create table crabbit.test_table nologging
 as 
select 
  rownum id,
  trunc(dbms_random.value(0,100),2) num,
  TO_DATE(trunc(DBMS_RANDOM.VALUE( TO_CHAR(TO_DATE('1980-01-01','yyyy-mm-dd'),'J'),TO_CHAR(TO_DATE('2020-01-01','yyyy-mm-dd'),'J')+1)) ,'J')+dbms_random.value dat,
  dbms_random.string('l',TRUNC(DBMS_RANDOM.VALUE(0, 10+1))) str
from dual connect by level < 1000000+1;

--创建约束，更改属性
alter table crabbit.test_table modify (str varchar(10));
alter table crabbit.test_table add constraint pk_test_table primary key(id) enable;
alter table crabbit.test_table logging;
spool off
------善后--------------------
drop table crabbit.test_table purge;
drop user crabbit casade;


--删除表空间后lv还是closed的状态
fuser -u /dev/rdg_yj_yy_gj_04n
kill相关进程


--帐号管理需要以下权限
create session,create user,drop user,grant any role,grant any privilege,grant any object privilege


--查找并行语句父进程
select qcsid from v$px_session where sid in (1073,1022,873,919,1027,860);

--表空间
--检查脚本
lslv dg_mm_mlm_d04	|grep -E "LOGICAL VOLUME|LV STATE|PP SIZE|LPs">/tmp/lv_check.txt
lslv dg_mm_mlm_i07n |grep -E "LOGICAL VOLUME|LV STATE|PP SIZE|LPs">>/tmp/lv_check.txt
lslv dg_sg_mlm_d05	|grep -E "LOGICAL VOLUME|LV STATE|PP SIZE|LPs">>/tmp/lv_check.txt
lslv dg_lvm_yj_d09n |grep -E "LOGICAL VOLUME|LV STATE|PP SIZE|LPs">>/tmp/lv_check.txt
lslv dg_yj_mlm_d04	|grep -E "LOGICAL VOLUME|LV STATE|PP SIZE|LPs">>/tmp/lv_check.txt
lslv dg_yj_mlm_i04	|grep -E "LOGICAL VOLUME|LV STATE|PP SIZE|LPs">>/tmp/lv_check.txt
lslv dg_zj_mlm_d05	|grep -E "LOGICAL VOLUME|LV STATE|PP SIZE|LPs">>/tmp/lv_check.txt
lslv dg_zj_mlm_d06	|grep -E "LOGICAL VOLUME|LV STATE|PP SIZE|LPs">>/tmp/lv_check.txt
cat /tmp/lv_check.txt|awk '{if(index($0,"LOGICAL VOLUME")>0) {printf"%s ",$0} else {print $0}}' >/tmp/lv_check2.txt
cat /tmp/lv_check2.txt|awk '{if(index($0,"LOGICAL VOLUME")>0) {printf"%s ",$0} else {print $0}}' >/tmp/lv_check3.txt
cat /tmp/lv_check3.txt|awk '{if(index($0,"LOGICAL VOLUME")>0) {printf"%s ",$0} else {print $0}}' >/tmp/lv_check4.txt
echo "LV状态检查："
cat /tmp/lv_check4.txt|awk '{print "LV: "$3"    Status: "$12"    Size: "$18*$21" "$19}'
echo "权限检查检查："
ls -l /dev/rdg_mm_mlm_d04	
ls -l /dev/rdg_mm_mlm_i07n 
ls -l /dev/rdg_sg_mlm_d05	
ls -l /dev/rdg_lvm_yj_d09n 
ls -l /dev/rdg_yj_mlm_d04	
ls -l /dev/rdg_yj_mlm_i04	
ls -l /dev/rdg_zj_mlm_d05	
ls -l /dev/rdg_zj_mlm_d06	

--连接检查 link_check.sh
ls -l /oracle/products/dg_data/mm_mlm_d04.dbf   2>/tmp/ls_err.txt  1>/tmp/ls_info.txt
ls -l /oracle/products/dg_data/mm_mlm_i07n.dbf 2>>/tmp/ls_err.txt 1>>/tmp/ls_info.txt
ls -l /oracle/products/dg_data/sg_mlm_d05.dbf  2>>/tmp/ls_err.txt 1>>/tmp/ls_info.txt
ls -l /oracle/products/dg_data/sg_mlm_i09n.dbf 2>>/tmp/ls_err.txt 1>>/tmp/ls_info.txt
ls -l /oracle/products/dg_data/yj_mlm_d04.dbf  2>>/tmp/ls_err.txt 1>>/tmp/ls_info.txt
ls -l /oracle/products/dg_data/yj_mlm_i04.dbf  2>>/tmp/ls_err.txt 1>>/tmp/ls_info.txt
ls -l /oracle/products/dg_data/zj_mlm_d05.dbf  2>>/tmp/ls_err.txt 1>>/tmp/ls_info.txt
ls -l /oracle/products/dg_data/zj_mlm_d06.dbf  2>>/tmp/ls_err.txt 1>>/tmp/ls_info.txt
if [ `wc -l /tmp/ls_info.txt|awk '{print $1}'` -eq 0 ]
then 
 echo "不存在已建立的link"
else 
 echo "下述"`cat /tmp/ls_info.txt|wc -l`"个link已经存在"
 cat /tmp/ls_info.txt|awk '{print $9}'
fi
if [ `wc -l /tmp/ls_err.txt|awk '{print $1}'` -eq 0 ]
then 
 echo "不存在未建立的link"
else 
 echo "下述"`cat /tmp/ls_err.txt|wc -l`"个link还没建立"
 cat /tmp/ls_err.txt|awk '{print $5}'
fi


--获取存储过程脚本
where_str="select OWNER,OBJECT_NAME,object_type from dba_objects where (owner='HZYY' or owner='HZZW') and STATUS='VALID' and (object_type='PACKAGE' or object_type='PROCEDURE')"
sqlplus -S /nolog<<EOF
conn xj_exp_data/fred_2010
set linesize 20000 pagesize 20000
set long 400000
set head off
set echo off
set verify off
set term off verify off feedback off
set trimout on
set trimspool on
spool /tmp/get_sql.sql
set serveroutput on
declare
v_sql varchar2(1000);
begin
  for v_cursor in (${where_str}) loop
    begin
    v_sql := 'select dbms_metadata.get_ddl(upper('''||v_cursor.object_type||'''),upper('''||v_cursor.OBJECT_NAME||'''),upper('''||v_cursor.owner||''')) from dual;';
      dbms_output.put_line(v_sql);
    v_sql := 'select ''/'' from dual;';
      dbms_output.put_line(v_sql);
    end;
  end loop;
end;
/
set serveroutput off
spool off
exit
EOF
echo "sqlplus -S /nolog<<EOF">/tmp/get_sql.sh
echo "conn xj_exp_data/fred_2010">>/tmp/get_sql.sh
echo "set linesize 20000 pagesize 20000">>/tmp/get_sql.sh
echo "set long 400000">>/tmp/get_sql.sh
echo "set head off">>/tmp/get_sql.sh
echo "set echo off">>/tmp/get_sql.sh
echo "set verify off">>/tmp/get_sql.sh
echo "set term off verify off feedback off">>/tmp/get_sql.sh
echo "set trimout on">>/tmp/get_sql.sh
echo "set trimspool on">>/tmp/get_sql.sh
echo "set trimspool on">>/tmp/get_sql.sh
echo "spool pp.sql">>/tmp/get_sql.sh
cat /tmp/get_sql.sql>>/tmp/get_sql.sh
echo "set serveroutput off">>/tmp/get_sql.sh
echo "spool off">>/tmp/get_sql.sh
echo "exit">>/tmp/get_sql.sh
echo "EOF">>/tmp/get_sql.sh
sh /tmp/get_sql.sh



//查询当前用户下所有的表
SET LONG 2000000
SET PAGESIZE 0
EXECUTE DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'STORAGE',false);
SELECT DBMS_METADATA.GET_DDL('TABLE',u.table_name)
     FROM USER_ALL_TABLES u
     WHERE u.nested='NO' 
     AND (u.iot_type is null or u.iot_type='IOT');
EXECUTE DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'DEFAULT');


//DBA用户查询其它用户创建的所有表
SET LONG 2000000
SET PAGESIZE 0
SELECT DBMS_METADATA.GET_DDL('TABLE',u.table_name,'XJ_MONITOR')
     FROM all_all_tables u
     WHERE owner='XJ_MONITOR' and u.nested='NO' 
     AND (u.iot_type is null or u.iot_type='IOT');


--获取定义
select TEXT from all_source where owner='HZYY' and NAME='P_TEL_MODIFYNUMSYNC' order by LINE;


--查找sql对应的存储过程
select PLSQL_OBJECT_ID  from v$session where sql_id='g6brkwv4un67c';


@?/rdbms/admin/ashrpt
-10

--查看语句情况
select cpu_time/1000/executions, elapsed_time/1000/executions, executions, last_load_time from v$sql where sql_id='g6brkwv4un67c';

--删除分区表
alter table YYQY.SP_WORKF_OUTDETAIL drop PARTITION SP_WORKF_OUTDETAIL_201009;

--检查TT报错
   ttdaemonlog -show replication | grep `date +"%Y-%m-%d"`
   ttdaemonlog -show server | grep `date +"%Y-%m-%d"`
   ttdaemonlog -show ora| grep `date +"%Y-%m-%d"`
   
--清理归档
rman target /
RMAN> crosscheck archivelog all;
RMAN> delete archivelog all;
Do you really want to delete the above objects (enter YES or NO)? yes


--excel
=VLOOKUP(B1,B:B,1,FALSE)

--ORA-01410: invalid ROWID处理
oracle工程师给出的解决方案为重建索引
但当天开发商希望同时重建表，在删除索引后，以create table as方式新建表备份时却意外仍然报此错
用select count(*) from gdmss.T_TRANS_LINE;查询此表，发现同样报此错
尝试对表进行alter table GDMSS.T_TRANS_LINE move;
最后用如下语句成功解决
create table gdmss.T_TRANS_LINE_20100815
as
select  /*+ full(a) parallel(a,2)*/ * from gdmss.T_TRANS_LINE a;
接着创建索引，检查，任务顺利完成


--TT脚本
$ cat /home/timesten/scripts/tt
#!/bin/sh
. $HOME/.profile
TT_HOME=/TimesTen/tt70
DSN='dsn=OCE;uid=timesten'
cd $TT_HOME/scripts
case $1 in 
  cgcheck)   
  $TT_HOME/bin/ttisql  -connstr $DSN  -v 1 << EOF >>cgcheck.sql.out
  select 'call TTCACHEAUTOREFRESHSTATSGET('''||trim(cgowner)||''''||','||''''||trim(cgname)||''');'  from  sys.cache_group;
  exit;
EOF
  echo "   columnlabels 1;" > cgcheckall.sql
  cat $TT_HOME/scripts/cgcheck.sql.out | grep call |grep -v select |awk '{print $2,$3}' >>cgcheckall.sql
  ttisql -f $TT_HOME/scripts/cgcheckall.sql -connstr $DSN  -v 2
  rm cgcheckall.sql cgcheck.sql.out
  ;;
  repstat)
  ttRepAdmin -showstatus $DSN 
  ;;
  bkpstat)
  $TT_HOME/bin/ttisql -e "call ttbackupstatus;bye;" -connstr $DSN  -v 1
  ;;
  cgstat)
  $TT_HOME/bin/ttisql -e "cachegroups;bye;" -connstr $DSN  -v 1
  ;;
  ttstat)
  $TT_HOME/bin/ttstatus | grep -v Process | grep -v Server | grep -v Client | grep -v Node  
  ;;    
  cglist)
  $TT_HOME/bin/ttisql -connstr $DSN  -v 1 << EOF
   columnlabels 1;
   select trim(cgowner)  cg_owner,cgname cg_name,
   case REFRESH_MODE when 'N' then 'NO auto refresh' 
   when 'I' then 'Incremental auto refresh' 
   when 'Y' then 'Full auto refresh' end as cg_refresh_mode,
   case REFRESH_STATE when 'Y' then 'On' 
   when 'P' then 'Paused'
   when 'N' then 'Off' end as cg_state,
   REFRESH_INTERVAL,CGATTRIBUTES from sys.cache_group;
   exit
EOF
  ;;
  replist)
  $TT_HOME/bin/ttisql -e "repschemes;bye;"  -connstr $DSN  -v 1
  ;;
  ckptlist)
  $TT_HOME/bin/ttisql -e "call ttckpthistory;bye;"  -connstr $DSN  -v 1
  ;;
  xalist)
  $TT_HOME/bin/ttxactadmin $DSN  
  ;;
  disk)
  echo "Filesystem    GB blocks    Free   %Used    Iused   %Iused    Mounted on"
  df -g |awk '{if(0+substr($4,1,length($4)-1)>79) print $1"      "$2"      "$3"      "$4"     "$5"      "$6"     "$7}'
  ;;
  showlog) 
   str=`date +"%Y%m%d"`
   days=1
   yy=`echo $str|cut -c 1-4`
   mm=`echo $str|cut -c 5-6`
   dd=`echo $str|cut -c 7-8`
   sav_dd=$days
   days=`expr $days - $dd`
   while [ $days -ge 0 ]
   do
           mm=`expr $mm - 1`
           [ $mm -eq 0 ] && mm=12 && yy=`expr $yy - 1`
           aaa=`cal $mm $yy`
           bbb=`echo $aaa|awk '{print $NF}'`
           days=`expr $days - $bbb`
   done
   dd=`expr 0 - $days`
   expr $dd : "^.$" > /dev/null && dd=0$dd
   expr $mm : "^.$" > /dev/null && mm=0$mm
   ytoday="$yy-$mm-$dd"
   $TT_HOME/bin/ttdaemonlog -show replication | grep $ytoday
   $TT_HOME/bin/ttdaemonlog -show replication | grep `date +"%Y-%m-%d"`
   $TT_HOME/bin/ttdaemonlog -show server | grep $ytoday
   $TT_HOME/bin/ttdaemonlog -show server | grep `date +"%Y-%m-%d"`
   $TT_HOME/bin/ttdaemonlog -show ora| grep $ytoday
   $TT_HOME/bin/ttdaemonlog -show ora| grep `date +"%Y-%m-%d"`
  ;;
  loghold)
  $TT_HOME/bin/ttisql -e "call ttlogholds;bye;" -connstr $DSN  -v 1
  ;;
  showpolicy)
  $TT_HOME/bin/ttadmin $DSN   
  ;;
  monitor)
  $TT_HOME/bin/ttisql -e "monitor;bye;"  -connstr $DSN  -v 1
  ;;     
  reprole)
  $TT_HOME/bin/ttisql -e "call ttrepstateget;bye;"  -connstr $DSN  -v 1
  ;;
  td)
   echo "  -------------------文件系统使用率超过80%------------------------";
   echo "Filesystem    GB blocks    Free   %Used    Iused   %Iused    Mounted on"
   df -g |awk '{if(0+substr($4,1,length($4)-1)>79) print $1"      "$2"      "$3"      "$4"     "$5"      "$6"     "$7}'
   echo ""
   echo "  -------------------系统负载检查vmstat 3 10 ----------------------";
   vmstat 3 10
   echo ""
   echo "  -----TT运行状态检查，包括连接数，缓存和复制代理进程检查---------------";
   $TT_HOME/bin/ttstatus | grep -v Process | grep -v Server | grep -v Client | grep -v Node  
   echo ""
   echo "  -----TT持有日志检查---------------";
   $TT_HOME/bin/ttisql -e "call ttlogholds;bye;" -connstr $DSN  -v 1
   echo ""
   echo "  -----TT CHECKPOINT检查---------------";
   $TT_HOME/bin/ttisql -e "call ttckpthistory;bye;"  -connstr $DSN  -v 1
   echo ""
   echo "  -----TT 资源使用情况检查---------------";
   $TT_HOME/bin/ttisql -e "monitor;bye;"  -connstr $DSN  -v 1
   echo ""   
   
   echo "  ---------------TT运行日志检查(今天，采集系统时间）---------------";
   str=`date +"%Y%m%d"`
   days=1
   yy=`echo $str|cut -c 1-4`
   mm=`echo $str|cut -c 5-6`
   dd=`echo $str|cut -c 7-8`
   sav_dd=$days
   days=`expr $days - $dd`
   while [ $days -ge 0 ]
   do
           mm=`expr $mm - 1`
           [ $mm -eq 0 ] && mm=12 && yy=`expr $yy - 1`
           aaa=`cal $mm $yy`
           bbb=`echo $aaa|awk '{print $NF}'`
           days=`expr $days - $bbb`
   done
   dd=`expr 0 - $days`
   expr $dd : "^.$" > /dev/null && dd=0$dd
   expr $mm : "^.$" > /dev/null && mm=0$mm
   ytoday="$yy-$mm-$dd"
   $TT_HOME/bin/ttdaemonlog -show replication | grep $ytoday
   $TT_HOME/bin/ttdaemonlog -show replication | grep `date +"%Y-%m-%d"`
   $TT_HOME/bin/ttdaemonlog -show server | grep $ytoday
   $TT_HOME/bin/ttdaemonlog -show server | grep `date +"%Y-%m-%d"`
   $TT_HOME/bin/ttdaemonlog -show ora| grep $ytoday
   $TT_HOME/bin/ttdaemonlog -show ora| grep `date +"%Y-%m-%d"`
   echo ""        
  ;;  
  config)
  $TT_HOME/bin/ttisql -e "call TTCONFIGURATION;bye;"  -connstr $DSN  -v 1
  ;;
  conn)
  $TT_HOME/bin/ttstatus | grep connections | grep -v "no connections"
  ;;
  run)
  $TT_HOME/bin/ttstatus | grep -i -E "running"
  ;;
  bkmk)
  $TT_HOME/bin/ttisql -e "call ttbookmark;bye;"  -connstr $DSN  -v 1
  ;;
  si)
  $TT_HOME/bin/ttisql -v 4 $DSN 
  ;;
  replog)
  $TT_HOME/bin/ttrepadmin -log $DSN
  ;;
  *)
   echo
   echo "Usage: tt keyword [value1] ";
   echo 
   echo "  -----------------------------------------------------------------";
   echo "  cgcheck                     -- get the cache group autorefresh state";
   echo "  repstat                     -- get the replication status";
   echo "  bkpstat                     -- get backup status";
   echo "  cgstat                      -- get the all cache group state";
   echo "  ttstat                      -- get the timesten status today";  
   echo "  cglist                      -- get the checkpoint state";
   echo "  replist                     -- get replication schemes";
   echo "  ckptlist                    -- get all cache group objects";
   echo "  xalist                      -- get all transactions";
   echo "  disk                        -- get disk used is >%80";
   echo "  showlog                     -- get ttdaemonlog log today";
   echo "  loghold                     -- get the ttlogholds";
   echo "  showpolicy                  -- get TimesTen policy";
   echo "  monitor                     -- get the timesten resource";
   echo "  reprole                     -- get the replication role";
   echo "  td                          -- get the tt today health";
   echo "  config                      -- get the tt deamon config information";
   echo "  conn                        -- 获得TT的当前连接数";
   echo "  run                         -- 获得CACHE和REPLICATION进程的状态";
   echo "  bkmk                        -- 获得最后写日志文件和复制进程持有的日志序列号";
   echo "  si                          -- 登陆TT";
   echo "  replog                      -- 检查复制进程持有日志个数据";
   echo "  ----------------------------------------------------------------";
   echo
   ;;
esac

select /*+ ordered */
       a.username   block_user,
       a.sid                                block_sid,
       a.serial#,
       a.logon_time,
       a.sql_id,
       b.type,
       b.lmode       mode_held,
       b.ctime       time_held,
       c.sid         waiter_sid,
       c.request     request_mode,
       c.ctime       time_waited
from   v$lock b, v$enqueue_lock c, v$session a
where  a.sid     = b.sid
and    b.id1     = c.id1(+)
and    b.id2     = c.id2(+)
and    c.type(+) = 'TX'
and    b.type    = 'TX'
and    b.block   = 1
order by time_held, time_waited;

--建立华为帐号
set lin 200 pagesize 500
select DEFAULT_TABLESPACE,TEMPORARY_TABLESPACE,PROFILE,count(*) from dba_users group by DEFAULT_TABLESPACE,TEMPORARY_TABLESPACE,PROFILE order by 4;

create user HW_TYJ_ROS
identified by gmcc123
default tablespace GZ_HW_WH
temporary tablespace TEMP12
quota 2G on users;

grant create session,create table,create view,CREATE SEQUENCE,CREATE SYNONYM,create trigger,CREATE PROCEDURE,select any dictionary to HW_TYJ_ROS;
grant HW_ROS,COMMONRO to HW_TYJ_ROS;

grant execute on dbms_xplan to HW_TYJ_ROS;
grant execute on dbms_metadata to HW_TYJ_ROS;
grant execute on dbms_workload_repository to HW_TYJ_ROS;


select 'grant '||role||' to HW_TYJ_ROS;' SQL 
from dba_roles 
where role like '__YYRO' or role like '__YYHISRO' or role like '__ZWRO'
union
select 'grant select on '||owner||'.'||view_name||' to HW_TYJ_ROS;' SQL 
from dba_views where owner='MGSJ' and (
view_name like '___CM_SUBS_SUBSCRIBER'
or view_name like '___CM_SUBS_SUBSCRIBER'
or view_name like '___CM_CU_CUSTOMER'
or view_name like '___CM_CU_INDIVIDUAL'
or view_name like '___CM_CA_SETTLETYPE'
or view_name like '___CM_CU_GROUP'
or view_name like '___CM_CU_CONTACTINFO'
or view_name like '___CM_CU_GROUPBANK'
or view_name like '___CS_CHECK'
or view_name like '___CM_SUBS_BILLMAIL'
or view_name like '___CM_CA_BILLMAIL'
);

audit table by HW_TYJ_ROS by access;
audit update table,insert table,delete table by HW_TYJ_ROS by access;
audit update any table,insert any table,delete any table by HW_TYJ_ROS by access;

--取消行移动特征
alter table XJ_EXP_DATA.TEST_PAR disable ROW MOVEMENT;

--查询行移动特征
select owner,TABLE_NAME,ROW_MOVEMENT from dba_tables where owner='XJ_EXP_DATA' and TABLE_NAME='TEST_PAR';

--查询实例启动以来CPU使用时间、解析时间及递归使用时间  
select name,value
from v$sysstat
where name in(
    'CPU used when call started',
    'parse time cpu',
    'recursive cpu usage'
  );
--查询某会话的CPU使用时间、解析时间及递归使用时间  
select n.name,s.value
from v$sesstat s,v$statname n
where s.STATISTIC# = n.STATISTIC#
  and n.name in(
    'CPU used when call started',
    'parse time cpu',
    'recursive cpu usage'
  )
  and s.sid=&sid;
--查询某等待事件类别及属性
col name for a20
col WAIT_CLASS for a10
col PARAMETER1 for a15
col PARAMETER2 for a15
col PARAMETER3 for a15
select NAME,WAIT_CLASS,PARAMETER1,PARAMETER2,PARAMETER3
from v$event_name
where name='gc buffer busy';

--备份清理审计目录
#!/bin/sh
mkdir /oracle/audit_zs2/2009
ls -l |grep .aud | awk '$8=="2009" {print $9}' > /oracle/audit_zs2/aud2009.txt
echo "start move"
while read FILE
do
mv ${FILE} /oracle/audit_zs2/2009
done < aud2009.txt
tar -cf oracle_base.tar /oracle/audit_zs2/2009
zip /oracle/datadump/aud2009.tar.gz /oracle/datadump/aud2009.tar

解压缩
tar -xvf oracle_base.tar oracle_base


--统计会话数
create table XJ_EXP_DATA.session_count(
time date,
db number,
jm number
);

export ORACLE_SID=szdb1
sqlplus -S /nolog<<EOF
conn / as sysdba
set linesize 200 pagesize 500
set long 400000
set head off
set echo off
set verify off
set term off verify off feedback off
set trimout on
SET MARKUP HTML ON ENTMAP ON SPOOL ON PRE OFF
set trimspool on
truncate table XJ_EXP_DATA.session_count;
declare
v_sql varchar2(1000);
begin
  for v_cursor in (select rownum from dual connect by level < 500) loop
    v_sql := 'insert into XJ_EXP_DATA.session_count select sysdate,b.jm,a.db from (select count(*) db from v\$session) a,(select count(*) jm from v\$session where username=''JMYY'') b';
    execute immediate v_sql;
    commit;
    dbms_lock.sleep(3);
  end loop;
end;
/
exit
EOF

--恢复数据
select *
from icdkbs.t_msg_bulletintype
AS OF TIMESTAMP to_timestamp('20100830 17:20:00','yyyymmdd hh24:mi:ss');


 @?/rdbms/admin/utllockt
 
 
--开发商的分区表改造方案
1,停止应用
2,将原表和原索引改名
alter table szzw.IB_DG_WOFFLOG rename to szzw.IB_DG_WOFFLOG_old
alter index xxzw.PK_IB_DG_WOFFLOG rename to szzw.PK_IB_DG_WOFFLOG_old
alter index xxzw.IDX_DG_WL_WOFFLOG1 rename to szzw.IDX_DG_WL_WOFFLOG1_old

3,创建分区表（2010 9月份为第一分区）和索引
   CREATE TABLE  SZZW.IB_DG_WOFFLOG                                                                     
   (     WOFFLOGID  NUMBER(14,0) NOT NULL,                                                
         EBOXID  NUMBER(14,0),                                                            
         GENBILLCYC  NUMBER(8,0),                                                         
         EBOXUNITID  NUMBER(14,0),                                                        
         EBOXUNITDETID  NUMBER(14,0),                                                     
         SUBSID  NUMBER(14,0),                                                            
         ACCTID  NUMBER(14,0),                                                            
         VALIDBILLCYC  NUMBER(8,0),                                                       
         AMT  NUMBER(14,0),                                                               
         SOUCE  NUMBER(3,0),                                                              
         IMPDATE  NUMBER(8,0)  )
         TABLESPACE SZ_HIS_DATA                                                          
  PARTITION BY RANGE (GENBILLCYC)                                                         
 (                                                                                        
 PARTITION  IB_DG_WOFFLOG201008   VALUES LESS THAN (20100901)  TABLESPACE  SZ_HIS_DATA   ,
 PARTITION  IB_DG_WOFFLOG201009   VALUES LESS THAN (20101001)  TABLESPACE  SZ_HIS_DATA   ,
 PARTITION  IB_DG_WOFFLOG201010   VALUES LESS THAN (20101101)  TABLESPACE  SZ_HIS_DATA   ,
 PARTITION  IB_DG_WOFFLOG201011   VALUES LESS THAN (20101201)  TABLESPACE  SZ_HIS_DATA   ) ENABLE ROW MOVEMENT ;

 

4 新建临时表

CREATE TABLE SZZW.WOFFTMP AS SELECT * FROM SZZW.IB_DG_WOFFLOG WHERE 1=0;


5. exchange 分区，将表IB_DG_WOFFLOG_old 的08分区作为表SZZW.WOFFTMP
ALTER TABLE  SZZW.IB_DG_WOFFLOG_OLD EXCHANGE PARTITION IB_DG_WOFFLOG201008 WITH TABLE SZZW.WOFFTMP WITHOUT VALIDATION;


6，exchange 分区 将表WOFFTMP 作为IB_DG_WOFFLOG 的08分区
alter table SZZW.IB_DG_WOFFLOG exchange partition IB_DG_WOFFLOG201008 with table SZZW.WOFFTMP WITHOUT VALIDATION;

7，重建索引

ALTER INDEX szzw.PK_IB_DG_WOFFLOG_old   REBUILD  PARALLEL 32;
ALTER INDEX szzw.IDX_DG_WL_WOFFLOG1_old PARTITION IB_DG_WOFFLOG201008 REBUILD PARALLEL 32;
CREATE INDEX SZZW.IDX_DG_WL_WOFFLOG1 ON SZZW.IB_DG_WOFFLOG(SUBSID) TABLESPACE SZ_MIB_IND LOCAL PARALLEL 32 ;
CREATE INDEX SZZW.PK_IB_DG_WOFFLOG ON SZZW.IB_DG_WOFFLOG(WOFFLOGID,GENBILLCYC) TABLESPACE SZ_HIS_DATA LOCAL PARALLEL 32;


ALTER INDEX  szzw.PK_IB_DG_WOFFLOG_old PARALLEL 1;
ALTER INDEX  szzw.szzw.IDX_DG_WL_WOFFLOG1_old PARALLEL 1; 
ALTER INDEX  szzw.IDX_DG_WL_WOFFLOG1 PARALLEL 1;  
ALTER INDEX  szzw.PK_IB_DG_WOFFLOG PARALLEL 1;  
  
8,检查
--实际上还需要有一步赋权
select 'grant '||PRIVILEGE||' on SZZW.IB_DG_WOFFLOG to '||GRANTEE||';' SQL from dba_tab_privs where owner=upper('SZZW') and TABLE_NAME=upper('IB_DG_WOFFLOG_old');



--批量生成parfile脚本
touch /tmp/creat_parfile_exp_XXZW_20100830.sh
cat /dev/null>/tmp/creat_parfile_exp_XXZW_20100830.sh
sqlplus -S /nolog<<EOF
conn xj_exp_data/fred_2010
set linesize 200 pagesize 500
set long 400000
set head off
set echo off
set verify off
set term off verify off feedback off
set trimout on
set trimspool on
col sql for a2000
set long 2000
col sql_str for a120
spool /tmp/creat_parfile_exp_XXZW_20100830.sh
with parfile_sql as (
  select 'touch exp_XXZW_20100830.par' sql_str,-30 sql_order from dual union  
  select 'cat /dev/null>exp_XXZW_20100830.par' sql_str,-20 sql_order from dual union  
  select 'chmod 660 exp_XXZW_20100830.par' sql_str,-10 sql_order from dual union  
  select 'userid=xj_exp_data/fred_2010' sql_str,01 sql_order from dual union 
  select 'directory=MOVE_XX' sql_str,05 sql_order from dual union 
  select 'dumpfile=exp_XXZW_20100830_%u.dmp' sql_str,10 sql_order from dual union 
  select 'logfile=exp_XXZW_20100830.log' sql_str,20 sql_order from dual union 
  select 'parallel=2' sql_str,30 sql_order from dual union 
  select 'exclude=index,statistics,trigger,grant' sql_str,40 sql_order from dual union 
  select 'tables=(' sql_str,50 sql_order from dual union 
  select 'XXZWHIS.SP_HLR_RESULT' sql_str,60 sql_order from dual union 
  select 'XXZWHIS.SP_CHK_LOG' sql_str,70 sql_order from dual union 
  select 'XXZWHIS.SP_UPLDESC_RESULT' sql_str,80 sql_order from dual union 
  select 'XXZWHIS.SP_NOSTATE_RESULT' sql_str,90 sql_order from dual union    
  select 'XXZWHIS.SP_INT_RESULT' sql_str,100 sql_order from dual union  
  select 'XXZWHIS.SP_UPLOAD_SUC' sql_str,110 sql_order from dual union 
  select 'XXZWHIS.SP_AIR_REQRESULT' sql_str,120 sql_order from dual union 
  select 'XXZWHIS.SP_CHK_TRANSLOG' sql_str,130 sql_order from dual union 
  select 'XXZWHIS.RB_CHECKDUP' sql_str,140 sql_order from dual union 
  select ')' sql_str,150 sql_order from dual
)
select
      case when sql_order>0 then 
        'echo "'||replace(sql_str,'XX',upper(city_name))||'">>'||replace('exp_XXZW_20100830.par','XX',upper(city_name)) 
      else 
        replace(sql_str,'XX',upper(city_name))
      end
    sql_str
from
  parfile_sql,
  (with city_list_data as (
    select 'GZDB' db_name,'gzdb1' ins_name,'gz' city_name from dual union all 
    select 'GZDB' db_name,'gzdb2' ins_name,'gz' city_name from dual union all 
    select 'SZDB' db_name,'szdb1' ins_name,'sz' city_name from dual union all 
    select 'SZDB' db_name,'szdb2' ins_name,'sz' city_name from dual union all 
    select 'DGDB' db_name,'dgdb1' ins_name,'dg' city_name from dual union all 
    select 'DGDB' db_name,'dgdb2' ins_name,'cz' city_name from dual union all 
    select 'DGDB' db_name,'dgdb2' ins_name,'sw' city_name from dual union all 
    select 'DGDB' db_name,'dgdb2' ins_name,'hy' city_name from dual union all 
    select 'FSDB' db_name,'fsdb1' ins_name,'fs' city_name from dual union all 
    select 'FSDB' db_name,'fsdb2' ins_name,'mm' city_name from dual union all 
    select 'FSDB' db_name,'fsdb2' ins_name,'zj' city_name from dual union all 
    select 'FSDB' db_name,'fsdb2' ins_name,'yj' city_name from dual union all 
    select 'FSDB' db_name,'fsdb2' ins_name,'sg' city_name from dual union all 
    select 'STDB' db_name,'stdb1' ins_name,'st' city_name from dual union all 
    select 'STDB' db_name,'stdb2' ins_name,'hz' city_name from dual union all 
    select 'STDB' db_name,'stdb2' ins_name,'zq' city_name from dual union all 
    select 'STDB' db_name,'stdb2' ins_name,'jy' city_name from dual union all 
    select 'ZSDB' db_name,'zsdb1' ins_name,'qy' city_name from dual union all 
    select 'ZSDB' db_name,'zsdb1' ins_name,'yf' city_name from dual union all 
    select 'ZSDB' db_name,'zsdb1' ins_name,'zs' city_name from dual union all 
    select 'ZSDB' db_name,'zsdb2' ins_name,'jm' city_name from dual union all 
    select 'ZSDB' db_name,'zsdb2' ins_name,'mz' city_name from dual union all 
    select 'ZSDB' db_name,'zsdb2' ins_name,'zh' city_name from dual
  )                      
  select distinct city_name       
  from city_list_data a,v\$database b
  where a.db_name=b.name)
order by city_name,sql_order;
spool off
exit
EOF
sh /tmp/creat_parfile_exp_XXZW_20100830.sh
  
--生成脚本
ls -ltr *.par|awk '{print "nohup expdp parfile="$9" >"$9".out &"}'


--批量统计收集
. ~/.profile
sqlplus / as sysdba <<EOF
set echo on
set verify on
spool gather_table20100830.log
declare
v_sql varchar2(1000);
begin
  for v_cursor in (select username from dba_users where username like '__YY') loop
		dbms_stats.gather_table_stats(v_cursor.username,'CM_GROUP_MEMBER',estimate_percent=>10,method_opt=>'for all indexed columns size 1',degree=>16,cascade=>true,force=>true);
		dbms_stats.gather_table_stats(v_cursor.username,'CM_GROUP_MEMBERATTR',estimate_percent=>10,method_opt=>'for all indexed columns size 1',degree=>16,cascade=>true,force=>true);
		dbms_stats.gather_table_stats(v_cursor.username,'CM_GROUP_MEM_RECDETAIL',estimate_percent=>10,method_opt=>'for all indexed columns size 1',degree=>16,cascade=>true,force=>true);
		dbms_stats.gather_table_stats(v_cursor.username,'CM_GROUP_SUBSATTR',estimate_percent=>10,method_opt=>'for all indexed columns size 1',degree=>16,cascade=>true,force=>true);
		dbms_stats.gather_table_stats(v_cursor.username,'CM_GROUP_SUBSCRIBER',estimate_percent=>10,method_opt=>'for all indexed columns size 1',degree=>16,cascade=>true,force=>true);
		dbms_stats.gather_table_stats(v_cursor.username,'CM_SUBS_PAYPLAN',estimate_percent=>10,method_opt=>'for all indexed columns size 1',degree=>16,cascade=>true,force=>true);
		dbms_stats.gather_table_stats(v_cursor.username,'CM_SUBS_PRIVATTR',estimate_percent=>10,method_opt=>'for all indexed columns size 1',degree=>16,cascade=>true,force=>true);
		dbms_stats.gather_table_stats(v_cursor.username,'CM_SUBS_PRIVILEGE',estimate_percent=>10,method_opt=>'for all indexed columns size 1',degree=>16,cascade=>true,force=>true);
		dbms_stats.gather_table_stats(v_cursor.username,'CM_SUBS_PRODUCT',estimate_percent=>10,method_opt=>'for all indexed columns size 1',degree=>16,cascade=>true,force=>true);
		dbms_stats.gather_table_stats(v_cursor.username,'CM_SUBS_RELATION',estimate_percent=>10,method_opt=>'for all indexed columns size 1',degree=>16,cascade=>true,force=>true);
		dbms_stats.gather_table_stats(v_cursor.username,'CM_SUBS_STATUSCHANGEHIS',estimate_percent=>10,method_opt=>'for all indexed columns size 1',degree=>16,cascade=>true,force=>true);
		dbms_stats.gather_table_stats(v_cursor.username,'CM_SUBS_SUBSCRIBER',estimate_percent=>10,method_opt=>'for all indexed columns size 1',degree=>16,cascade=>true,force=>true);
		dbms_stats.gather_table_stats(v_cursor.username,'CS_REC_CHANGE',estimate_percent=>10,method_opt=>'for all indexed columns size 1',degree=>16,cascade=>true,force=>true);
		dbms_stats.gather_table_stats(v_cursor.username,'CS_REC_RECEPTION',estimate_percent=>10,method_opt=>'for all indexed columns size 1',degree=>16,cascade=>true,force=>true);
		dbms_stats.gather_table_stats(v_cursor.username,'GRP_SUBSMEM_PRODUCT',estimate_percent=>10,method_opt=>'for all indexed columns size 1',degree=>16,cascade=>true,force=>true);
  end loop;
end;
/
spool off
exit
EOF

--批量清理
--truncate表空间，并重建全局索引
set serveroutput on
declare
v_sql varchar2(1000);
begin
  for v_cursor in (select distinct owner,object_name from dba_objects where object_name in ('SP_HLR_RESULT','SP_CHK_LOG','SP_UPLDESC_RESULT','SP_NOSTATE_RESULT','SP_INT_RESULT','SP_UPLOAD_SUC','SP_AIR_REQRESULT','SP_CHK_TRANSLOG','RB_CHECKDUP') and owner like '__ZWHIS' and object_type='TABLE') loop
  	v_sql := 'truncate table '||v_cursor.owner||'.'||v_cursor.object_name;
  	execute immediate v_sql;
  	dbms_output.put_line(v_sql);
  end loop;
  for c_gidx in (select owner,index_name from dba_indexes where TABLE_OWNER like '__ZWHIS' and TABLE_NAME in ('SP_HLR_RESULT','SP_CHK_LOG','SP_UPLDESC_RESULT','SP_NOSTATE_RESULT','SP_INT_RESULT','SP_UPLOAD_SUC','SP_AIR_REQRESULT','SP_CHK_TRANSLOG','RB_CHECKDUP') and PARTITIONED='NO') loop
  	v_sql := 'alter index '||c_gidx.owner||'.'||c_gidx.index_name||' rebuild';
  	execute immediate v_sql;
  	dbms_output.put_line(v_sql);
  end loop;
end;
/

--错误案例
explain plan for
create table sz_group_subs as 
select  /*+parallel(a,8)*/ distinct a.*,c.BILLINGNBR
from  cx_whz_ros.tmp_sz_go a,szyy.subs_privilege b,szyy.group_subscriber c
where a.subsid = b.subsid
  and a.yxplanid = b.privid
  and a.startdate = to_char(b.startdate,'yyyymmddhh24miss')
  and b.grpsubsid = c.subsid;
select plan_table_output from table(dbms_xplan.display());  
--当时开发商抱怨开了并行后仍然很慢，但经查执行计划发现并没开并行，原因为distinct写在/*+parallel(a,8)*/之前


--tt错误检查
[timesten@SZOCE2_1]/home/timesten$ tt bkmk
[YOU HAVE NEW MAIL]
< 35902, 476707280, 35902, 476658752, 35902, 427828136 >
[timesten@SZOCE2_1]/home/timesten$ tt showlog
[YOU HAVE NEW MAIL]
[timesten@SZOCE2_1]/home/timesten$ tt replog
[YOU HAVE NEW MAIL]
1 log file retained by replication


_________________________________

select distinct p2 from v$session_wait where event like 'latch free%';
select * from v$latchname where latch#=18;

select * from v$enqueue_stat;
select * from v$enqueue_statistics;


create table t_test as select * from v$enqueue_statistics ;

SQL> select a.eq_type,a.TOTAL_REQ#-b.total_req#,a.total_wait#-b.total_wait# 
  2  from t_test b,v$enqueue_statistics a 
  3  where a.eq_type=b.eq_type;
  
  SQL> select a.eq_type,a.req_reason,a.TOTAL_REQ#-b.total_req#,a.total_wait#-b.total_wait# 
  2  from t_test b,v$enqueue_statistics a 
  3  where a.eq_type=b.eq_type;
 
select sql_id,count(*) from v$session where event like '%TX%' group by sql_id;

SQL>


@?/rdbms/admin/utllockt


--估算剩余时间
select sid, SERIAL# ,SOFAR,TIME_REMAINING,MESSAGE from V$SESSION_LONGOPS where sid=1186;
select sid, SERIAL# ,SOFAR,TIME_REMAINING,MESSAGE from V$SESSION_LONGOPS where TIME_REMAINING>0;

select sl.sid,sl.SERIAL#,s.username,s.PROGRAM,s.sql_id,s.event,to_char(sl.START_TIME,'yyyy-mm-dd hh24:mi:ss'),sl.TIME_REMAINING 
from v$session_longops sl,v$session s where sl.sid=s.sid and sl.serial#=s.serial# and sl.TIME_REMAINING>0 and s.sql_id ='c3mtxhw1w4dy5' order by 8;

--删除快照信息
exec dbms_workload_repository.drop_snapshot_range(29800,35000);

--设置系统参数
alter system set log_archive_max_processes=15 scope=both;

--清理检查脚本
select a.owner,a.SEGMENT_NAME,a.PARTITION_NAME,a.BYTES/1024/1024 GDSM_MB,b.BYTES/1024/1024 GDSMHIS_MB
from dba_segments a,dba_segments b
where a.SEGMENT_NAME=b.SEGMENT_NAME and a.PARTITION_NAME=b.PARTITION_NAME and a.owner='GDSM' and b.owner='GDSMHIS'
 and  
 ((a.SEGMENT_NAME='SV_SMS_REQ' and a.PARTITION_NAME='SV_SMS_REQ_200904' )
 or (a.SEGMENT_NAME='SV_SMS_REQ' and a.PARTITION_NAME='SV_SMS_REQ_200905' )
 or (a.SEGMENT_NAME='SV_SMS_REQ' and a.PARTITION_NAME='SV_SMS_REQ_200906' )
 or (a.SEGMENT_NAME='SV_SMS_REQ' and a.PARTITION_NAME='SV_SMS_REQ_200907' )
 or (a.SEGMENT_NAME='SV_SMS_REQ' and a.PARTITION_NAME='SV_SMS_REQ_200908' )
 or (a.SEGMENT_NAME='SV_SMS_REQ' and a.PARTITION_NAME='SV_SMS_REQ_200909' )
 or (a.SEGMENT_NAME='SV_SMS_REQ' and a.PARTITION_NAME='SV_SMS_REQ_200910' )
 or (a.SEGMENT_NAME='SV_SMS_REQ' and a.PARTITION_NAME='SV_SMS_REQ_200911' )
 or (a.SEGMENT_NAME='SV_SMS_REQ' and a.PARTITION_NAME='SV_SMS_REQ_200912' )
 or (a.SEGMENT_NAME='SV_SMS_REQ' and a.PARTITION_NAME='SV_SMS_REQ_201001' )
 or (a.SEGMENT_NAME='SV_SMS_REQ' and a.PARTITION_NAME='SV_SMS_REQ_201002' )
 or (a.SEGMENT_NAME='SV_SMS_REQ' and a.PARTITION_NAME='SV_SMS_REQ_201003' )
 or (a.SEGMENT_NAME='SV_SMS_REQ' and a.PARTITION_NAME='SV_SMS_REQ_201004' )
 or (a.SEGMENT_NAME='SV_SMS_REQ' and a.PARTITION_NAME='SV_SMS_REQ_201005' )
 or (a.SEGMENT_NAME='SV_SMS_REQ' and a.PARTITION_NAME='SV_SMS_REQ_201006' )
 or (a.SEGMENT_NAME='SV_SMS_SNDREQSUCC' and a.PARTITION_NAME='SV_SNDREQSUCC_200903' )
 or (a.SEGMENT_NAME='SV_SMS_SNDREQSUCC' and a.PARTITION_NAME='SV_SNDREQSUCC_200904' )
 or (a.SEGMENT_NAME='SV_SMS_SNDREQSUCC' and a.PARTITION_NAME='SV_SNDREQSUCC_200905' )
 or (a.SEGMENT_NAME='SV_SMS_SNDREQSUCC' and a.PARTITION_NAME='SV_SNDREQSUCC_200906' )
 or (a.SEGMENT_NAME='SV_SMS_SNDREQSUCC' and a.PARTITION_NAME='SV_SNDREQSUCC_200907' )
 or (a.SEGMENT_NAME='SV_SMS_SNDREQSUCC' and a.PARTITION_NAME='SV_SNDREQSUCC_200908' )
 or (a.SEGMENT_NAME='SV_SMS_SNDREQSUCC' and a.PARTITION_NAME='SV_SNDREQSUCC_200909' )
 or (a.SEGMENT_NAME='SV_SMS_SNDREQSUCC' and a.PARTITION_NAME='SV_SNDREQSUCC_200910' )
 or (a.SEGMENT_NAME='SV_SMS_SNDREQSUCC' and a.PARTITION_NAME='SV_SNDREQSUCC_200911' )
 or (a.SEGMENT_NAME='SV_SMS_SNDREQSUCC' and a.PARTITION_NAME='SV_SNDREQSUCC_200912' )
 or (a.SEGMENT_NAME='SV_SMS_SNDREQSUCC' and a.PARTITION_NAME='SV_SNDREQSUCC_201001' )
 or (a.SEGMENT_NAME='SV_SMS_SNDREQSUCC' and a.PARTITION_NAME='SV_SNDREQSUCC_201002' )
 or (a.SEGMENT_NAME='SV_SMS_SNDREQSUCC' and a.PARTITION_NAME='SV_SNDREQSUCC_201003' )
 or (a.SEGMENT_NAME='SV_SMS_SNDREQSUCC' and a.PARTITION_NAME='SV_SNDREQSUCC_201004' )
 or (a.SEGMENT_NAME='SV_SMS_SNDREQSUCC' and a.PARTITION_NAME='SV_SNDREQSUCC_201005' )
 or (a.SEGMENT_NAME='SV_SMS_SNDREQSUCC' and a.PARTITION_NAME='SV_SNDREQSUCC_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_CZ_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_CZ_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_CZ_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_CZ_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_CZ_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_CZ_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_CZ_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_CZ_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_CZ_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_CZ_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_CZ_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_CZ_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_CZ_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_CZ_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_CZ_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_CZ_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_DG_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_DG_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_DG_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_DG_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_DG_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_DG_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_DG_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_DG_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_DG_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_DG_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_DG_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_DG_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_DG_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_DG_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_DG_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_DG_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_FS_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_FS_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_FS_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_FS_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_FS_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_FS_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_FS_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_FS_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_FS_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_FS_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_FS_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_FS_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_FS_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_FS_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_FS_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_FS_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_GZ_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_GZ_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_GZ_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_GZ_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_GZ_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_GZ_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_GZ_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_GZ_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_GZ_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_GZ_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_GZ_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_GZ_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_GZ_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_GZ_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_GZ_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_GZ_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HY_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HY_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HY_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HY_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HY_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HY_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HY_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HY_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HY_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HY_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HY_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HY_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HY_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HY_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HY_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HY_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HZ_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HZ_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HZ_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HZ_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HZ_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HZ_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HZ_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HZ_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HZ_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HZ_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HZ_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HZ_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HZ_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HZ_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HZ_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_HZ_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JM_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JM_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JM_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JM_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JM_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JM_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JM_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JM_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JM_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JM_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JM_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JM_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JM_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JM_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JM_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JM_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JY_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JY_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JY_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JY_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JY_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JY_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JY_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JY_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JY_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JY_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JY_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JY_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JY_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JY_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JY_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_JY_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MM_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MM_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MM_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MM_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MM_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MM_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MM_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MM_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MM_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MM_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MM_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MM_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MM_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MM_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MM_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MM_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MZ_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MZ_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MZ_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MZ_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MZ_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MZ_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MZ_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MZ_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MZ_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MZ_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MZ_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MZ_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MZ_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MZ_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MZ_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_MZ_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_QY_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_QY_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_QY_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_QY_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_QY_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_QY_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_QY_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_QY_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_QY_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_QY_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_QY_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_QY_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_QY_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_QY_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_QY_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_QY_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SG_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SG_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SG_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SG_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SG_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SG_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SG_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SG_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SG_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SG_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SG_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SG_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SG_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SG_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SG_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SG_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ST_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ST_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ST_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ST_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ST_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ST_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ST_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ST_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ST_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ST_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ST_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ST_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ST_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ST_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ST_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ST_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SW_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SW_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SW_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SW_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SW_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SW_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SW_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SW_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SW_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SW_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SW_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SW_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SW_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SW_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SW_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SW_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SZ_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SZ_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SZ_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SZ_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SZ_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SZ_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SZ_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SZ_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SZ_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SZ_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SZ_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SZ_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SZ_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SZ_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SZ_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_SZ_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YF_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YF_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YF_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YF_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YF_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YF_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YF_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YF_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YF_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YF_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YF_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YF_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YF_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YF_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YF_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YF_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YJ_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YJ_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YJ_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YJ_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YJ_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YJ_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YJ_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YJ_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YJ_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YJ_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YJ_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YJ_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YJ_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YJ_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YJ_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_YJ_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZH_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZH_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZH_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZH_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZH_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZH_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZH_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZH_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZH_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZH_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZH_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZH_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZH_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZH_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZH_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZH_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZJ_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZJ_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZJ_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZJ_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZJ_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZJ_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZJ_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZJ_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZJ_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZJ_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZJ_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZJ_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZJ_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZJ_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZJ_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZJ_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZQ_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZQ_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZQ_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZQ_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZQ_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZQ_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZQ_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZQ_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZQ_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZQ_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZQ_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZQ_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZQ_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZQ_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZQ_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZQ_201006' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZS_200903' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZS_200904' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZS_200905' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZS_200906' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZS_200907' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZS_200908' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZS_200909' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZS_200910' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZS_200911' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZS_200912' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZS_201001' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZS_201002' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZS_201003' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZS_201004' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZS_201005' )
 or (a.SEGMENT_NAME='SV_SMS_RESULT' and a.PARTITION_NAME='SV_SMS_RESULT_ZS_201006' ));
 
--AIX查询登陆失败记录
cd /etc/security
who failedlogin  | grep oracle

--gg同步
-- 应急端
cd /ggs
--进入界面
ggsci
--查看同步情况
info all
--启动同步（需要先disable所有触发器）
add replicat repszqyy, exttrail /ggs/dirdat/zqyy/ss, nodbcheckpoint
start replicat repszqyy, aftercsn 8229761054542

--生产端
cd /oracle/datadump/ggs
--进入界面
ggsci
--查看同步情况
info all
--同步

--如果已经起来
stop ext extsszyy
status ext extsszyy
stop ext dpssszyy
status ext dpssszyy
delete ext extsszyy
delete ext dpssszyy

delete exttrail /oracle/datadump/ggs/dirdat/szyy/ss
cd /oracle/datadump/ggs/dirdat/szyy
rm *
stop mgr

--从零开始
start mgr

add extract dpssszyy , exttrailsource  /oracle/datadump/ggs/dirdat/szyy/ss 
add rmttrail  /ggs/dirdat/szyy/ss, ext dpssszyy, megabytes 100
add ext extsszyy, tranlog, begin now, threads 2
ADD EXTTRAIL  /oracle/datadump/ggs/dirdat/szyy/ss, EXTRACT extsszyy, megabytes 100

start ext dpssszyy
start ext extsszyy

--报错文件
more /ggs/dirrpt/REPSQYZW.rpt


list backup of database summary;
list backup set 27394;

--停止crs
crs_stop -all

--启动crs服务
crs_start ora.gdmss.gdmssdb.gdmss1.srv


--集市一次跑多个库
export ORACLE_BASE=/oracle/products
export ORACLE_TERM=xterm
export ORACLE_HOME=/oracle/products/10.2/db
export PATH=/orac0le/products/10.2/db/bin:/oracle/products/10.2/crs/bin:/usr/bin:/etc:/usr/sbin:/usr/ucb:
sh  cxdm.sh /tmp/audit.sql
sh  hwdm.sh /tmp/audit.sql

select INSTANCE_NAME,(select /*+parallel(a,16)*/ count(*) from dba_audit_trail a) cou from  v$instance;


--目录满
fuser -f nohup.out

fuser -dV /home


--cics重启?
ps -ef|grep ccl
kill -9 7860386
cicscli /s
cicscli /l
c

[S6_C_YZ_CICS@/home/ibmperf]$ cat .profile
PATH=$PATH:/usr/bin:/cicsdump/CheckServer:/etc:/usr/sbin:/usr/ucb:$HOME/bin:/usr/bin/X11:/sbin:.

export PATH
alias paux='ps aux|sort -rn +2|head -30'
alias p='ps -ef|grep -v grep|grep '
alias c='/cicsdump/CheckServer/checkcicsAll.sh'
alias l='lssrc -a|grep cics'
alias C='/cicsdump/CheckServer/CheckWAS'
alias ly='lssrc -a|grep cics|grep YY'
alias lz='lssrc -a|grep cics|grep ZW'
alias c1='rsh S1_C_YZ_CICS'
alias c2='rsh S2_C_YZ_CICS'
alias c3='rsh S3_C_YZ_CICS'
alias c4='rsh S4_C_YZ_CICS'
alias c5='rsh S5_C_YZ_CICS'
alias c6='rsh S6_C_YZ_CICS'
alias c9='rsh S9_C_YZ_CICS'
alias c10='rsh S10_C_YZ_CICS'
alias c11='rsh S11_C_YZ_CICS'
alias c13='rsh 10.243.208.116'
alias c14='rsh 10.243.208.117'
alias j3='rsh S3_C_YZ_J2EE'
alias j4='rsh S4_C_YZ_J2EE'
alias j5='rsh S5_C_YZ_J2EE'
alias j6='rsh S6_C_YZ_J2EE'
alias j7='rsh S7_C_YZ_J2EE'
alias j8='rsh S8_C_YZ_J2EE'
alias vt='vi /cicsdump/T*e/T*e.sh'
alias cas='/cicsdump/CheckServer/checkCicsas.sh'
if [ -s "$MAIL" ]           # This is at Shell startup.  In normal
then echo "$MAILMSG"        # operation, the Shell checks
fi                          # periodically.

#CLASSPATH=/cicsdump/CheckServer/checkctg/ctgclient.jar
#export CLASSPATH

PS1='[S6_C_YZ_CICS@$PWD]$ '
set -o vi
export CDPATH=./:/var/cics_regions/:/cicsdump/ibmcollect

alias ..="cd .." 
alias ...="cd ../.." 
alias ....="cd ../../.." 
alias .....="cd ../../../.." 
alias ......="cd ../../../../.."

You have mail in /usr/spool/mail/ibmperf


--600
1、后台发现大量600报错
2、通过查审计确认用户
3、通知对方停止应用
4、另一个结点建立/删除

--11G查密码暗文
select name, password from user$ where name='GZYY';

--改表名
alter table ZWGZ.IB_WL_EBOXCHGLOG_0129 rename to IB_WL_EBOXCHGLOG;


高CPU消耗进程
ps aux|head -1;ps aux|sort -rn +2|head -10
高内存消耗进程
ps vx|head -1;ps vx|grep -v PID|sort -rn +6|head -10
高换页消耗进程
ps vx|head -1;ps vx|grep -v PID|sort -rn +4|head -10
高磁盘消耗进程
ps aux|head -1;ps aux|sort -rn +3|head -10


--GG

view report EXTSJYZW
info extsjyyy , showch

--split
echo "1/2/3/" |awk '{{split ($1,A,"/")}{print $0A[2]}}'


ls -l log2_59352_660014826.arc|awk '{{split ($9,A,"_")}{print $5" "$9" "A[2]}}'


ls -ltr 1_*.dbf|awk '{{split ($9,A,"_")}{print A[2],$5,$9}}'|sort

ls -ltr *1_*.arc|awk '{{split ($9,A,"_")}{print A[2],$5,$9}}'|sort|awk '{print$3}'



--大写转小写
echo "AAAdB"|tr "[A-Z]" "[a-z]" 


--应急端
cd /ggs/dirprm
vi repsjyyy.prm

add replicat repsstyy, exttrail /ggs/dirdat/styy/ss, nodbcheckpoint
start replicat repsstyy, aftercsn 8247650303972

--handlecollisions
discardfile /ggs/dirrpt/repsjyyy.dsc,purge, megabytes 1000

后面加一行discardrollover

tmp_gg_sh=GG`date +%Y%m%d%H%M%S`.sh
tmp_gg_sh2=tmp`echo $tmp_gg_sh`
echo "cd /oracle/datadump/ggs/">/tmp/$tmp_gg_sh
echo "ggsci <<EOF">>/tmp/$tmp_gg_sh
echo "info all">>/tmp/$tmp_gg_sh
echo "exit">>/tmp/$tmp_gg_sh
echo "EOF">>/tmp/$tmp_gg_sh
sh /tmp/$tmp_gg_sh>/tmp/$tmp_gg_sh.out
echo "cd /oracle/datadump/ggs/">/tmp/$tmp_gg_sh2
echo "ggsci <<EOF">>/tmp/$tmp_gg_sh2
grep EXTRACT GG20100914231546.sh.out|awk '{if($2=="ABENDED") print "info "$3" ,showch"}'>>$tmp_gg_sh2
echo "exit">>/tmp/$tmp_gg_sh2
echo "EOF">>/tmp/$tmp_gg_sh2
sh /tmp/$tmp_gg_sh2>/tmp/$tmp_gg_sh2.out
grep Thread  tmpGG20100914233139.sh.out|grep -v "Thread #:"


grep EXTRACT GG20100914231546.sh.out|awk '{if($2=="ABENDED") print "info "$3" ,showch"}'
ls -ltr *2_*.arc|awk '{{split ($9,A,"_")}{print A[2],$5,$9}}'|sort|awk '{print$3}'


--datapump报错
ORA-31693: Table data object "GZYYHIS"."SP_WORKF_INDETAIL":"SP_WORKF_INDETAIL_201006" failed to load/unload and is being skipped due to error:
ORA-29913: error in executing ODCIEXTTABLEPOPULATE callout
ORA-31617: unable to open dump file "/oracle/datadump/move_tab/gz/exp_GZYYHIS_20100712_
加上
ESTIMATE=statistics

--压缩
alter table YYST.SP_WORKF_COMM_HIS move partition SP_WORKF_COMM_HIS_200804 compress;  

alter table SYS.TEST_PAR move partition TEST_PAR_2010 nocompress tablespace USERS parallel 4;

select TABLE_OWNER,TABLE_NAME,PARTITION_NAME,SUBPARTITION_COUNT,COMPRESSION from dba_tab_partitions where TABLE_OWNER='SYS' and TABLE_NAME='TEST_PAR'

--补丁
$ORACLE_HOME/OPatch/opatch lsinventory


--主机报错检查
errpt -aj BFE4C025|more
Diagnostic Analysis下十几行

--东莞集市无法登陆故障20100922
开发商报无法登陆数据库
以oracle账号登陆后发现pmon进程还在，topas发现系统资源不忙（但高消耗进程中有大量非oracle进程，当时没在意）
尝试登陆却报以下错误
/tmp/sh1278800.1: There is not enough space in the file system.
df- g确认 ，果然/tmp目录满了
/dev/hd3           4.00      0.00  100%      227    31% /tmp
然而进入后却没发现大文件或目录，之前怀疑是权限问题
然后以fuser -dV /tmp查找未释放进程
随机抽查，发现是某个常出问题的账号的进程
DW_DG_SJK_1: oracle: $ps -ef|grep 806916
   xj_dm  806916       1   0 15:35:00      -  2:33 java -jar collectdata.jar 
  oracle  418868 2216632   0 16:34:14  pts/1  0:00 grep 806916 
一统计ps -ef|grep xj_dm|wc -l，发现有172个进程
电话咨询相关账号负责人，确认为异常，索取密码后直接登陆，和谐掉
然后测试正常，通知开发商确认，经测试无异常
再次查询账号xj_dm，却发现类似的进程还在不断地生成
再度电话给相关账号负责人，确认为crontab中不断发起相应进程所致，经其同意后注释掉
一切正常


--dx
col "waiter" format a8;
col "w_Machine" format a15;
col "h_HOLDER" format a8;
col "h_Machine" format a20;

select h_HOLDER,h_Machine,h_sid,h_serial#,h_spid,h_PID,h_INSTANCE,h_process,count(*) c  from(
SELECT s2.username             h_HOLDER,
       s2.machine              h_Machine,
       h.sid                   h_sid, 
       s2.serial#              h_serial#,
       s2.sql_id               h_spid,
       p2.spid                 h_PID,
       S2.INST_ID              h_INSTANCE,
       S2.PROCESS              h_process
FROM   gv$process P1,    gv$process P2,
       gv$session S1,    gv$session S2,
       gv$lock w,        gv$lock h
WHERE
  (((h.LMODE != 0) and (h.LMODE != 1)
  and ((h.REQUEST = 0) or (h.REQUEST = 1)))
  and  (((w.LMODE= 1) or (w.LMODE = 0))
  and ((w.REQUEST != 1) and (w.REQUEST != 0))))
  and  w.type =  h.type
  and  w.id1  =  h.id1
  and  w.id2  =  h.id2
  and  w.sid     !=  h.sid
  and  w.sid       = S1.sid
  and  h.sid       = S2.sid
  and  S1.EVENT  ='enq: DX - contention'
  AND    S1.paddr           = P1.addr
  AND    S2.paddr           = P2.addr
) group by h_HOLDER,h_Machine,h_sid,h_serial#,h_spid,h_PID,h_INSTANCE,h_process
order by c;



--测试表
create table orders_tmp(
  CUST_NBR  NUMBER(5) NOT NULL,
  REGION_ID  NUMBER(5) NOT NULL,
  SALESPERSON_ID  NUMBER(5) NOT NULL,
  YEAR  NUMBER(4) NOT NULL,
  MONTH NUMBER(2) NOT NULL,
  TOT_ORDERS NUMBER(7)  NOT NULL,
  TOT_SALES NUMBER(11,2) NOT NULL
);

insert into orders_tmp values(11,7,11,2001,7,2,12204);
insert into orders_tmp values(4,5,4,2001,10,2,37802);
insert into orders_tmp values(7,6,7,2001,2,3,3750);
insert into orders_tmp values(10,6,8,2001,1,2,21691);
insert into orders_tmp values(10,6,7,2001,2,3,42624);
insert into orders_tmp values(15,7,12,2000,5,6,24);
insert into orders_tmp values(12,7,9,2000,6,2,50658);
insert into orders_tmp values(1,5,2,2000,3,2,44494);
insert into orders_tmp values(1,5,1,2000,9,2,74864);
insert into orders_tmp values(2,5,4,2000,3,2,35060);
insert into orders_tmp values(2,5,4,2000,4,4,6454);
insert into orders_tmp values(2,5,1,2000,10,4,35580);
insert into orders_tmp values(4,5,4,2000,12,2,39190);
commit;
         
--统计用户销售总额及其区域总额
select o.cust_nbr customer,
       o.region_id region,
       sum(o.tot_sales) cust_sales,
       sum(sum(o.tot_sales)) over(partition by o.region_id) region_sales
  from orders_tmp o
 where o.year = 2001
 group by o.region_id, o.cust_nbr;


--
分区索引也有可能是全局索引
INDEX_NAME                             INDEX_COL                           INDEX_TYPE                   PAR
-------------------------------------- ----------------------------------- ---------------------------- ---
GZZWHIS.IDX_IM_WL_CZOPR1               LOGID                               NORMAL-NONUNIQUE             YES
GZZWHIS.IDX_IM_WL_CZOPR2               REQOGID                             NORMAL-NONUNIQUE             NO
GZZWHIS.IDX_IM_WL_CZOPR3               INOUT,RESTYPE,BEGNO                 NORMAL-NONUNIQUE             NO
OWNER                          INDEX_NAME                     LOCALI
------------------------------ ------------------------------ ------
GZZWHIS                        IDX_IM_WL_CZOPR1               GLOBAL

 CREATE TABLE "GZZWHIS"."IM_WL_CZOPR"
   (    "LOGID" NUMBER(11,0),
        "RESTYPE" NUMBER(6,0),
        "BEGNO" VARCHAR2(32),
        "COMID" NUMBER(14,0),
        "NUM" NUMBER(8,0),
        "REQOGID" NUMBER(11,0),
        "INWAYID" VARCHAR2(18),
        "OUTWAYID" VARCHAR2(18),
        "INOPRCODE" VARCHAR2(15),
        "OUTOPRCODE" VARCHAR2(15),
        "INOUT" DATE,
        "BATCHNO" VARCHAR2(30),
        "RESOPRTYPE" NUMBER(3,0),
        "SUCCESS" NUMBER(3,0),
        "OPRCODE" VARCHAR2(15),
        "OLDSTATE" NUMBER(3,0),
        "NEWSTATE" NUMBER(3,0),
        "COMSOURCE" NUMBER(8,0),
        "SENDNO" VARCHAR2(40)
   )
  PARTITION BY RANGE ("INOUT")
 (PARTITION "IM_WL_CZOPR1"  VALUES LESS THAN (TO_DATE(' 2006-12-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR2"  VALUES LESS THAN (TO_DATE(' 2007-01-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR3"  VALUES LESS THAN (TO_DATE(' 2007-02-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR4"  VALUES LESS THAN (TO_DATE(' 2007-03-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR5"  VALUES LESS THAN (TO_DATE(' 2007-04-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS','NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR6"  VALUES LESS THAN (TO_DATE(' 2007-05-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR7"  VALUES LESS THAN (TO_DATE(' 2007-06-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR8"  VALUES LESS THAN (TO_DATE(' 2007-07-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR9"  VALUES LESS THAN (TO_DATE(' 2007-08-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR10"  VALUES LESS THAN (TO_DATE(' 2007-09-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR11"  VALUES LESS THAN (TO_DATE(' 2007-10-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR12"  VALUES LESS THAN (TO_DATE(' 2007-11-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR13"  VALUES LESS THAN (TO_DATE(' 2007-12-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR14"  VALUES LESS THAN (TO_DATE(' 2008-01-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR15"  VALUES LESS THAN (TO_DATE(' 2008-02-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR16"  VALUES LESS THAN (TO_DATE(' 2008-03-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR17"  VALUES LESS THAN (TO_DATE(' 2008-04-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR18"  VALUES LESS THAN (TO_DATE(' 2008-05-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS','NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR19"  VALUES LESS THAN (TO_DATE(' 2008-06-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR20"  VALUES LESS THAN (TO_DATE(' 2008-07-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR21"  VALUES LESS THAN (TO_DATE(' 2008-08-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR22"  VALUES LESS THAN (TO_DATE(' 2008-09-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR23"  VALUES LESS THAN (TO_DATE(' 2008-10-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR24"  VALUES LESS THAN (TO_DATE(' 2008-11-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR25"  VALUES LESS THAN (TO_DATE(' 2008-12-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR200812"  VALUES LESS THAN (TO_DATE(' 2009-01-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR200901"  VALUES LESS THAN (TO_DATE(' 2009-02-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR200902"  VALUES LESS THAN (TO_DATE(' 2009-03-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR200903"  VALUES LESS THAN (TO_DATE(' 2009-04-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR200904"  VALUES LESS THAN (TO_DATE(' 2009-05-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR200905"  VALUES LESS THAN (TO_DATE(' 2009-06-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR200906"  VALUES LESS THAN (TO_DATE(' 2009-07-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR200907"  VALUES LESS THAN (TO_DATE(' 2009-08-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR200908"  VALUES LESS THAN (TO_DATE(' 2009-09-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR200909"  VALUES LESS THAN (TO_DATE(' 2009-10-01 00:00:00','SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR200910"  VALUES LESS THAN (TO_DATE(' 2009-11-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR200911"  VALUES LESS THAN (TO_DATE(' 2009-12-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR200912"  VALUES LESS THAN (TO_DATE(' 2010-01-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201001"  VALUES LESS THAN (TO_DATE(' 2010-02-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201002"  VALUES LESS THAN (TO_DATE(' 2010-03-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201003"  VALUES LESS THAN (TO_DATE(' 2010-04-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS','NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201004"  VALUES LESS THAN (TO_DATE(' 2010-05-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201005"  VALUES LESS THAN (TO_DATE(' 2010-06-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201006"  VALUES LESS THAN (TO_DATE(' 2010-07-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201007"  VALUES LESS THAN (TO_DATE(' 2010-08-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201008"  VALUES LESS THAN (TO_DATE(' 2010-09-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201009"  VALUES LESS THAN (TO_DATE(' 2010-10-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201010"  VALUES LESS THAN (TO_DATE(' 2010-11-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201011"  VALUES LESS THAN (TO_DATE(' 2010-12-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201012"  VALUES LESS THAN (TO_DATE(' 2011-01-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201101"  VALUES LESS THAN (TO_DATE(' 2011-02-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201102"  VALUES LESS THAN (TO_DATE(' 2011-03-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201103"  VALUES LESS THAN (TO_DATE(' 2011-04-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201104"  VALUES LESS THAN (TO_DATE(' 2011-05-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201105"  VALUES LESS THAN (TO_DATE(' 2011-06-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201106"  VALUES LESS THAN (TO_DATE(' 2011-07-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201107"  VALUES LESS THAN (TO_DATE(' 2011-08-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201108"  VALUES LESS THAN (TO_DATE(' 2011-09-01 00:00:00', 'SYYYY-MM-DDHH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201109"  VALUES LESS THAN (TO_DATE(' 2011-10-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201110"  VALUES LESS THAN (TO_DATE(' 2011-11-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS ,
 PARTITION "IM_WL_CZOPR201111"  VALUES LESS THAN (TO_DATE(' 2011-12-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) NOCOMPRESS )  
 ENABLE ROW MOVEMENT;
 
 
  CREATE INDEX "GZZWHIS"."IDX_IM_WL_CZOPR1" ON "GZZWHIS"."IM_WL_CZOPR" ("LOGID")
   GLOBAL PARTITION BY HASH ("LOGID")
 (PARTITION "IDX_IM_WL_CZOPR1_1" ,
 PARTITION "IDX_IM_WL_CZOPR1_2" ,
 PARTITION "IDX_IM_WL_CZOPR1_3" ,
 PARTITION "IDX_IM_WL_CZOPR1_4" ,
 PARTITION "IDX_IM_WL_CZOPR1_5" ,
 PARTITION "IDX_IM_WL_CZOPR1_6" ,
 PARTITION "IDX_IM_WL_CZOPR1_7" ,
 PARTITION "IDX_IM_WL_CZOPR1_8" ,
 PARTITION "IDX_IM_WL_CZOPR1_9" ,
 PARTITION "IDX_IM_WL_CZOPR1_10" ,
 PARTITION "IDX_IM_WL_CZOPR1_11" ,
 PARTITION "IDX_IM_WL_CZOPR1_12" ,
 PARTITION "IDX_IM_WL_CZOPR1_13" ,
 PARTITION "IDX_IM_WL_CZOPR1_14" ,
 PARTITION "IDX_IM_WL_CZOPR1_15" ,
 PARTITION "IDX_IM_WL_CZOPR1_16" ) ;
   
--创建主键(未命名) ,disable


 SELEct bytes/1048576 size_m from dba_free_space where tablespace_NAME='DG_ZWO_IND' and bytes>=1048576;
 
 
 set serveroutput on
declare
v_sql varchar2(1000);
begin
  for v_cursor in (
    select a.owner,a.TABLE_NAME,b.username from
      (select OWNER,TABLE_NAME from dba_tables where (owner like '__YY' and TABLE_NAME in('SMNOTIFY','SMNOTIFY_LOGON')) or (owner='COMMON' and table_name='SA_SO_OPERATOR')) a,
      (select username from dba_users where username in ('HW_SJQL_RW','HW_LYW_RW','HW_HJY_COM_RW','HW_LJL_COM_RW')) b
  ) loop
    begin
    v_sql := 'revoke insert,delete,update on '||v_cursor.owner||'.'||v_cursor.TABLE_NAME||' from '||v_cursor.username;
      execute immediate v_sql;
      dbms_output.put_line('Sucess: '||v_sql);
    exception
      when others then
      dbms_output.put_line('Fail: '||v_sql);
    end;
  end loop;
  for v_cursor in (
    select username from dba_users where username in ('HW_ZCY_COM_RW','HW_LHB_DBA','HW_LZL_RW')
  ) loop
    begin
    v_sql := 'alter user '||v_cursor.username||' account lock';
      execute immediate v_sql;
      dbms_output.put_line('Sucess: '||v_sql);
    exception
      when others then
      dbms_output.put_line('Fail: '||v_sql);
    end;
  end loop;  
  
end;
/
set serveroutput off


select USED_UBLK,SES_ADDR,XIDUSN
from V$TRANSACTION;


--查询db_link用户密码，适合8i 9i 10GR1
select USERID,PASSWORD,HOST from link$;

--更改当前current_schema
 alter session set current_schema=xj_exp_data;
 
 
 --
YEAR=`date +%EY`
tail -2000 /oracle/products/admin/szdb/bdump/alert_szdb1.log|awk '{if(index($0,"Errors in file")>0) {printf"%s ",""} else {print $0}}'|awk -v year=" ${YEAR}" '{if(index($0,year)>0) {printf"%s ",$0} else {print $0}}'|grep ORA-|tail -10


--sqlldr报下述错误(纯粹拷贝,没有安装)
Message 2100 not found; No message file for product=RDBMS, facility=ULMessage 2100 not found; No message file for product=RDBMS, facility=ULora11
同步下述文件夹后解决
/oracle/products/10.2/client_1/mesg
/oracle/products/10.2/client_1/rdbms/mesg

－－十六进制转十进制
select to_number('A1','xxxx') from dual;

--设置会话级别并行
ALTER SESSION FORCE PARALLEL QUERY PARALLEL 2;
ALTER SESSION FORCE PARALLEL DML PARALLEL 2;

alter session enable parallel dml;


--重置密码
 create profile temp123 limit
password_life_time unlimited
password_grace_time unlimited
password_reuse_time unlimited
password_reuse_max unlimited
failed_login_attempts unlimited;

set lin 200 pagesize 500
select 'alter user '||username||' profile temp123;' from dba_users where  profile='SOX_PROFILE';
select 'alter user '||username||' identified by values'''||password||''';' from dba_users where profile='TEMP123';
select 'alter user '||username||' profile SOX_PROFILE;' from dba_users where profile='TEMP123';
select username,profile,EXPIRY_DATE,account_status from dba_users order by account_status,EXPIRY_DATE;

--改文件名
ls -ltr 1*.dbf|awk '{{split ($9,A,"_")}{print A[2],$9}'}|sort|awk '{print "mv "$2" log1_"$1"_657510055.arc"}'|sh


--发邮件
登陆　ams.gmcc.net
账号密码  yuxiang/xjshsnc2013
点击"综合查询2"-"查询文档"
打开 C_20101014_9459/xjshsnc2013
点击《goldengate报错信息.doc 》并下载
将邮件发送给ran@shsnc.com,junyuan.li@shsnc.com
万分感谢

--恢复归档文件
export ORACLE_SID=fsdb
rman catalog rcat_fs1/rcat_fs1@beifen  <<EOF
connect target / 
run{
   set archivelog destination to '/oracle/products/gz_data/fs'; 
   allocate channel ch00 type 'SBT_TAPE';
   allocate channel ch01 type 'SBT_TAPE';
   send 'nb_ora_serv=S1_C_YZ_BEIFEN';
   send 'nb_ora_client=S7_C_YZ_YZSJK_BEIFEN';
   restore archivelog  sequence between 63868  and 63870 thread 1;
   release channel ch00;      
   release channel ch01;
  }
EOF

--prompt用法
prompt 文字

--comment用法
comment on table gzyy.ESOP_ALERT_CONFIG
  is '预警配置表';
comment on column gzyy.ESOP_ALERT_CONFIG.ALERTTYPE
  is '预警类型编号';

--创建普通索引
CREATE INDEX gzyy.ESOP_INDEX_MONTH ON gzyy.ESOP_PERFORM_DETAIL(MONTH) tablespace GZ_YYO_IND;

--创建唯一索引
create unique index gzyy.UNIDX_ESOP_INDEXID on gzyy.ESOP_ALERT_CONFIG (INDEXID, REGION) tablespace GZ_MCM_IND;

--创建位图索引
create bitmap index gzyy.IDX_ESOP_INFOINDEXID on gzyy.ESOP_ALERT_INFO (INDEXID)  tablespace GZ_MLM_IND LOCAL;

--表增加字段
alter table gzyy.ESOP_TASK_MAIN add  resourceid varchar2(2048);

--表更改字段
alter table gzyy.MM_DET_VALIDATE_SSOTOKEN modify TOKEN VARCHAR2(64);

--创建表
create table xj_exp_data.ESOP_PERFORM_DETAIL
(
  performid   varchar2(32) primary key using index tablespace users,
  MONTH       VARCHAR2(8) not null,
  operid      varchar2(32) not null,
  ATTRIBUTE1  VARCHAR2(32),
  ATTRIBUTE2  VARCHAR2(32),
  ATTRIBUTE3  VARCHAR2(32),
  OPERATETIME         date default sysdate not null
) tablespace users;

--创建分区表
CREATE TABLE  gzyy.ESOP_BI_GROUPCUST
(
     GROUPID                  VARCHAR2(32)
    ,GROUPNAME                VARCHAR2(128)
    ,OPMONTH                  VARCHAR2(8)				not null
    ,REGION                   NUMBER(8)
)
STORAGE (INITIAL 1M)
INITRANS 10
tablespace GZ_YYO_data
PARTITION BY RANGE (OPMONTH)
(
 PARTITION ESOP_BI_GROUPCUST_201008 VALUES LESS THAN ('201009') STORAGE(INITIAL 1M),
 PARTITION ESOP_BI_GROUPCUST_201009 VALUES LESS THAN ('201010') STORAGE(INITIAL 1M),
 PARTITION ESOP_BI_GROUPCUST_201010 VALUES LESS THAN ('201011') STORAGE(INITIAL 1M),
 PARTITION ESOP_BI_GROUPCUST_201011 VALUES LESS THAN ('201012') STORAGE(INITIAL 1M),
 PARTITION ESOP_BI_GROUPCUST_201012 VALUES LESS THAN ('201101') STORAGE(INITIAL 1M),
 PARTITION ESOP_BI_GROUPCUST_201101 VALUES LESS THAN ('201102') STORAGE(INITIAL 1M),
 PARTITION PART_MAX VALUES LESS THAN ('999912')
);

--创建分区表本地索引
CREATE INDEX gzyy.IDX_BI_GROUPCUST_REGION ON gzyy.ESOP_BI_GROUPCUST (REGION)
tablespace GZ_YYO_IND
LOCAL;

--删除索引
drop INDEX gzyy.IDX_ESOP_RESOURCETYPE;

--创建同义词
create synonym gzyy.ESOP_CUST_CUSTINFO for COMMON.ESOP_CUST_CUSTINFO;


--杀所有LOCAL=NO进程
ps -ef|grep LOCAL=NO |awk '{print $2}' |xargs kill -9


--
lsnrctl service listener_s1

srvctl stop service -d stdb -s shz

srvctl status service -d stdb

--查询recover信息
select * from V$FAST_START_TRANSACTIONS;

--crontab无法正常调度执行程序
[S9_C_YZ_CICS@/home/ibmperf] $ps -ef|grep cron
    root  270338       1   0   Jul 28      - 24:07 /usr/sbin/cron 
 ibmperf 3297378 5046384   0 16:17:12  pts/7  0:00 grep cron 
[S9_C_YZ_CICS@/home/ibmperf] $kill -9 270338
--这样之后会自动重启


--没有配置tnsname的情况下登陆
conn xj_exp_data@(DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = 10.244.148.8)(PORT = 1521)) (CONNECT_DATA = (SERVER = DEDICATED) (SID = gzdb1)))


--导数的时候alertlog会看到类似信息的
Mon Oct 25 01:38:54 2010
ALTER SYSTEM SET service_names='SYS$SYS.KUPC$S_1_20101025010438.ZSDB','syf','sqy','szs' SCOPE=MEMORY SID='zsdb1';
Mon Oct 25 01:38:55 2010
ALTER SYSTEM SET service_names='syf','sqy','szs' SCOPE=MEMORY SID='zsdb1';
Mon Oct 25 01:38:56 2010
The value (30) of MAXTRANS parameter ignored.
Mon Oct 25 01:39:00 2010
ALTER SYSTEM SET service_names='syf','sqy','szs','SYS$SYS.KUPC$C_1_20101025013857.ZSDB' SCOPE=MEMORY SID='zsdb1';
Mon Oct 25 01:39:00 2010
ALTER SYSTEM SET service_names='SYS$SYS.KUPC$C_1_20101025013857.ZSDB','syf','sqy','szs','SYS$SYS.KUPC$S_1_20101025013857.ZSDB' SCOPE=MEMORY SID='zsdb1';
kupprdp: master process DM00 started with pid=286, OS id=15376438
         to execute - SYS.KUPM$MCP.MAIN('SYS_EXPORT_TABLE_03', 'XJ_EXP_DATA', 'KUPC$C_1_20101025013857', 'KUPC$S_1_20101025013857', 0);
kupprdp: worker process DW01 started with worker id=1, pid=451, OS id=16519386
         to execute - SYS.KUPW$WORKER.MAIN('SYS_EXPORT_TABLE_03', 'XJ_EXP_DATA');
kupprdp: worker process DW02 started with worker id=2, pid=847, OS id=11751650
         to execute - SYS.KUPW$WORKER.MAIN('SYS_EXPORT_TABLE_03', 'XJ_EXP_DATA');
kupprdp: worker process DW03 started with worker id=3, pid=854, OS id=16953380
         to execute - SYS.KUPW$WORKER.MAIN('SYS_EXPORT_TABLE_03', 'XJ_EXP_DATA');
kupprdp: worker process DW04 started with worker id=4, pid=944, OS id=13398090
         to execute - SYS.KUPW$WORKER.MAIN('SYS_EXPORT_TABLE_03', 'XJ_EXP_DATA');
         
--目录赋权
 GRANT write ON DIRECTORY TTT to public;
 
--查看临时段情况
select segment_name, extents,  bytes/1048576 size_m from dba_segments where tablespace_name='ST_HIS_DATA' and segment_type='TEMPORARY';

--awk里查找字符串
awk '/'"$KEY_DAY1"'/ {print $0}' ~/alert_temp.log KEY_DAY1="`date|cut -c1-10`"

--awk里查找字符串
awk '/'"Mon Oct 18"'/ {print $0}' ~/alert_temp.log

--awk里输出行数
awk '/'"Mon Oct 18"'/ {print $0}' ~/alert_temp.log


--清空回收站
purge dba_RECYCLEBIN;
purge RECYCLEBIN;

--删除分区
alter table ZWSZ.IB_CC_CREDITACTION drop PARTITION SP_SMS_FINREQ201008;


--datadump排除导出
userid=xj_exp_data/fred_2010
directory=AUG_DUMP
schemas=gzyy
dumpfile=exp_gzyy_20101022_%U.dmp
logfile=exp_gzyy_20101022.log
parallel=32
FLASHBACK_SCN=8255449807147
exclude=statistics,table:"in ('SP_WORKF_COMM_HIS_K'
,'SP_WORKF_COMM_HIS_K'
,'SP_WORKF_DEAL_HIS'
,'SP_WORKF_INDETAIL_HIS'
,'SP_WORKF_MONITOR_HIS'
,'SP_WORKF_OCSIF_COMM_HIS'
,'CM_SUBS_SERVICE'
,'CM_SUBS_PRODUCT'
)"


--重启ha
smit clstart


-- shell普通计算及截取某几行
num1=`cat /tmp/txt|wc -l`
num2=`expr $num1 - 2`
awk -v N1="$num2" -v N2="$num1" 'NR==N1,NR==N2 {print $0}' /tmp/txt
head -3 /tmp/txt|uniq



expr date - 2


alter database add logfile THREAD 1 group 1  ('/oracle/products/oradata/pboss/redo11.log','/oracle/products/oradata/pboss/redo12.log') size 2044M;
alter database clear logfile '/oracle/products/oradata/pboss/xxx3.log';
alter database drop logfile group 13;



--触发器
 CREATE OR REPLACE TRIGGER "SYS"."TR_AUDIT_OPERATOR"
 BEFORE UPDATE OR INSERT OR DELETE ON COMMON.SA_SO_OPERATOR FOR EACH ROW
 DECLARE
 V_OS_USER      VARCHAR2(80);
 V_IP_ADDRESS   VARCHAR2(80);
 V_TERMINAL     VARCHAR2(80);
 V_HOST         VARCHAR2(80);
 V_USER_NAME    VARCHAR2(80);
 V_MODULE       VARCHAR2(80);
 BEGIN
 SELECT SYS_CONTEXT('USERENV','OS_USER'),
        SYS_CONTEXT('USERENV','IP_ADDRESS'),
        SYS_CONTEXT('USERENV','TERMINAL'),
        SYS_CONTEXT('USERENV','HOST'),
        SYS_CONTEXT('USERENV','SESSION_USER'),
        SYS_CONTEXT('USERENV','MODULE')
 INTO
        V_OS_USER       ,
        V_IP_ADDRESS    ,
        V_TERMINAL      ,
        V_HOST          ,
        V_USER_NAME     ,
        V_MODULE
 from dual;
IF inserting THEN
  insert into  SYSTEM.AUDIT_OPERATOR(
  AUDIT_TIME           ,
  OS_USER               ,
  IP_ADDRESS            ,
  TERMINAL              ,
  HOST                  ,
  USER_NAME             ,
  MODULE                ,
  ACTION                ,
  NEW_OPERID            ,
  NEW_REGION            ,
  NEW_OPERNAME          ,
  NEW_PASSWORD          ,
  NEW_PASSCHGDATE      ,
  NEW_OPERGROUP        ,
  NEW_OPERTYPE         ,
  NEW_OPERLEVEL        ,
  NEW_ISMANAGER        ,
  NEW_CONTACTPHONE     ,
  NEW_ORGID            ,
  NEW_ISRESTRICT       ,
  NEW_STARTTIME        ,
  NEW_ENDTIME          ,
  NEW_ENABLEGPRS       ,
  NEW_GPRSSTARTTIME    ,
  NEW_GPRSENDTIME      ,
  NEW_ISCHKMAC         ,
  NEW_MAC              ,
  NEW_NOTES            ,
  NEW_CREATEDATE       ,
  NEW_STATUS           ,
  NEW_STATUSDATE       ,
  NEW_RELE_STAFF_ID    ,
  NEW_START_USING_TIME ,
  NEW_END_USING_TIME   ,
  NEW_LOGINTYPE        ,
  NEW_SMNOTITYFLAG     ,
  NEW_CSP_STAFF_NO     )
  VALUES
 (sysdate              ,
  V_OS_USER             ,
  V_IP_ADDRESS          ,
  V_TERMINAL            ,
  V_HOST                        ,
  V_USER_NAME           ,
  V_MODULE              ,
  'INSERT'              ,
  :NEW.OPERID                   ,
  :NEW.REGION                   ,
  :NEW.OPERNAME                 ,
  :NEW.PASSWORD                 ,
  :NEW.PASSCHGDATE      ,
  :NEW.OPERGROUP        ,
  :NEW.OPERTYPE         ,
  :NEW.OPERLEVEL        ,
  :NEW.ISMANAGER        ,
  :NEW.CONTACTPHONE     ,
  :NEW.ORGID            ,
  :NEW.ISRESTRICT       ,
  :NEW.STARTTIME        ,
  :NEW.ENDTIME          ,
  :NEW.ENABLEGPRS       ,
  :NEW.GPRSSTARTTIME    ,
  :NEW.GPRSENDTIME      ,
  :NEW.ISCHKMAC         ,
  :NEW.MAC              ,
  :NEW.NOTES            ,
  :NEW.CREATEDATE       ,
  :NEW.STATUS           ,
  :NEW.STATUSDATE       ,
  :NEW.RELE_STAFF_ID    ,
  :NEW.START_USING_TIME ,
  :NEW.END_USING_TIME   ,
  :NEW.LOGINTYPE        ,
  :NEW.SMNOTITYFLAG     ,
  :NEW.CSP_STAFF_NO     );
END IF;

IF updating THEN
  insert into  SYSTEM.AUDIT_OPERATOR(
  AUDIT_TIME           ,
  OS_USER               ,
  IP_ADDRESS            ,
  TERMINAL              ,
  HOST                  ,
  USER_NAME             ,
  MODULE                ,
  ACTION                ,
  NEW_OPERID            ,
  NEW_REGION            ,
  NEW_OPERNAME          ,
  NEW_PASSWORD          ,
  NEW_PASSCHGDATE      ,
  NEW_OPERGROUP        ,
  NEW_OPERTYPE         ,
  NEW_OPERLEVEL        ,
  NEW_ISMANAGER        ,
  NEW_CONTACTPHONE     ,
  NEW_ORGID            ,
  NEW_ISRESTRICT       ,
  NEW_STARTTIME        ,
  NEW_ENDTIME          ,
  NEW_ENABLEGPRS       ,
  NEW_GPRSSTARTTIME    ,
  NEW_GPRSENDTIME      ,
  NEW_ISCHKMAC         ,
  NEW_MAC              ,
  NEW_NOTES            ,
  NEW_CREATEDATE       ,
  NEW_STATUS           ,
  NEW_STATUSDATE       ,
  NEW_RELE_STAFF_ID    ,
  NEW_START_USING_TIME ,
  NEW_END_USING_TIME   ,
  NEW_LOGINTYPE        ,
  NEW_SMNOTITYFLAG     ,
  NEW_CSP_STAFF_NO     ,
  OLD_OPERID           ,
  OLD_REGION           ,
  OLD_OPERNAME         ,
  OLD_PASSWORD         ,
  OLD_PASSCHGDATE      ,
  OLD_OPERGROUP        ,
  OLD_OPERTYPE         ,
  OLD_OPERLEVEL        ,
  OLD_ISMANAGER        ,
  OLD_CONTACTPHONE     ,
  OLD_ORGID            ,
  OLD_ISRESTRICT       ,
  OLD_STARTTIME        ,
  OLD_ENDTIME          ,
  OLD_ENABLEGPRS       ,
  OLD_GPRSSTARTTIME    ,
  OLD_GPRSENDTIME      ,
  OLD_ISCHKMAC         ,
  OLD_MAC              ,
  OLD_NOTES            ,
  OLD_CREATEDATE       ,
  OLD_STATUS           ,
  OLD_STATUSDATE       ,
  OLD_RELE_STAFF_ID    ,
  OLD_START_USING_TIME ,
  OLD_END_USING_TIME   ,
  OLD_LOGINTYPE        ,
  OLD_SMNOTITYFLAG     ,
  OLD_CSP_STAFF_NO
)
  VALUES
 (sysdate              ,
  V_OS_USER             ,
  V_IP_ADDRESS          ,
  V_TERMINAL            ,
  V_HOST                        ,
  V_USER_NAME           ,
  V_MODULE              ,
  'UPDATE'              ,
  :NEW.OPERID                   ,
  :NEW.REGION                   ,
  :NEW.OPERNAME                 ,
  :NEW.PASSWORD                 ,
  :NEW.PASSCHGDATE      ,
  :NEW.OPERGROUP        ,
  :NEW.OPERTYPE         ,
  :NEW.OPERLEVEL        ,
  :NEW.ISMANAGER        ,
  :NEW.CONTACTPHONE     ,
  :NEW.ORGID            ,
  :NEW.ISRESTRICT       ,
  :NEW.STARTTIME        ,
  :NEW.ENDTIME          ,
  :NEW.ENABLEGPRS       ,
  :NEW.GPRSSTARTTIME    ,
  :NEW.GPRSENDTIME      ,
  :NEW.ISCHKMAC         ,
  :NEW.MAC              ,
  :NEW.NOTES            ,
  :NEW.CREATEDATE       ,
  :NEW.STATUS           ,
  :NEW.STATUSDATE       ,
  :NEW.RELE_STAFF_ID    ,
  :NEW.START_USING_TIME ,
  :NEW.END_USING_TIME   ,
  :NEW.LOGINTYPE        ,
  :NEW.SMNOTITYFLAG     ,
  :NEW.CSP_STAFF_NO     ,
  :OLD.OPERID           ,
  :OLD.REGION           ,
  :OLD.OPERNAME         ,
  :OLD.PASSWORD         ,
  :OLD.PASSCHGDATE      ,
  :OLD.OPERGROUP        ,
  :OLD.OPERTYPE         ,
  :OLD.OPERLEVEL        ,
  :OLD.ISMANAGER        ,
  :OLD.CONTACTPHONE     ,
  :OLD.ORGID            ,
  :OLD.ISRESTRICT       ,
  :OLD.STARTTIME        ,
  :OLD.ENDTIME          ,
  :OLD.ENABLEGPRS       ,
  :OLD.GPRSSTARTTIME    ,
  :OLD.GPRSENDTIME      ,
  :OLD.ISCHKMAC         ,
  :OLD.MAC              ,
  :OLD.NOTES            ,
  :OLD.CREATEDATE       ,
  :OLD.STATUS           ,
  :OLD.STATUSDATE       ,
  :OLD.RELE_STAFF_ID    ,
  :OLD.START_USING_TIME ,
  :OLD.END_USING_TIME   ,
  :OLD.LOGINTYPE        ,
  :OLD.SMNOTITYFLAG     ,
  :OLD.CSP_STAFF_NO     );
END IF;


IF deleting THEN
  insert into  SYSTEM.AUDIT_OPERATOR(
  AUDIT_TIME           ,
  OS_USER               ,
  IP_ADDRESS            ,
  TERMINAL              ,
  HOST                  ,
  USER_NAME             ,
  MODULE                ,
  ACTION                ,
  OLD_OPERID            ,
  OLD_REGION            ,
  OLD_OPERNAME          ,
  OLD_PASSWORD          ,
  OLD_PASSCHGDATE      ,
  OLD_OPERGROUP        ,
  OLD_OPERTYPE         ,
  OLD_OPERLEVEL        ,
  OLD_ISMANAGER        ,
  OLD_CONTACTPHONE     ,
  OLD_ORGID            ,
  OLD_ISRESTRICT       ,
  OLD_STARTTIME        ,
  OLD_ENDTIME          ,
  OLD_ENABLEGPRS       ,
  OLD_GPRSSTARTTIME    ,
  OLD_GPRSENDTIME      ,
  OLD_ISCHKMAC         ,
  OLD_MAC              ,
  OLD_NOTES            ,
  OLD_CREATEDATE       ,
  OLD_STATUS           ,
  OLD_STATUSDATE       ,
  OLD_RELE_STAFF_ID    ,
  OLD_START_USING_TIME ,
  OLD_END_USING_TIME   ,
  OLD_LOGINTYPE        ,
  OLD_SMNOTITYFLAG     ,
  OLD_CSP_STAFF_NO     )
  VALUES
 (sysdate              ,
  V_OS_USER             ,
  V_IP_ADDRESS          ,
  V_TERMINAL            ,
  V_HOST                        ,
  V_USER_NAME           ,
  V_MODULE              ,
  'DELETE'              ,
  :OLD.OPERID                   ,
  :OLD.REGION                   ,
  :OLD.OPERNAME                 ,
  :OLD.PASSWORD                 ,
  :OLD.PASSCHGDATE      ,
  :OLD.OPERGROUP        ,
  :OLD.OPERTYPE         ,
  :OLD.OPERLEVEL        ,
  :OLD.ISMANAGER        ,
  :OLD.CONTACTPHONE     ,
  :OLD.ORGID            ,
  :OLD.ISRESTRICT       ,
  :OLD.STARTTIME        ,
  :OLD.ENDTIME          ,
  :OLD.ENABLEGPRS       ,
  :OLD.GPRSSTARTTIME    ,
  :OLD.GPRSENDTIME      ,
  :OLD.ISCHKMAC         ,
  :OLD.MAC              ,
  :OLD.NOTES            ,
  :OLD.CREATEDATE       ,
  :OLD.STATUS           ,
  :OLD.STATUSDATE       ,
  :OLD.RELE_STAFF_ID    ,
  :OLD.START_USING_TIME ,
  :OLD.END_USING_TIME   ,
  :OLD.LOGINTYPE        ,
  :OLD.SMNOTITYFLAG     ,
  :OLD.CSP_STAFF_NO     );
END IF;
end;


--rank使用
create view v_arc_tbs_info as 
select * from(
 select rank() over(partition by TBS_NAME order by COLLECT_TIME desc) rk,a.* from arc_tbs_info a) t;
 
 
 --gg 使用数据库用户登录
 dblogin 
 
 --新历史数据中心原来密码
 
 
 
 --查询是否高水位
Select owner,table_name,blocks*8/1024 size_m, (avg_row_len*num_rows+24*INI_TRANS)/8096/blocks*100 pct 
from dba_tables 
where table_name='CM_SUBS_STATUSCHG';


--自动配置ssh
mkdir ~/.ssh
chmod 700 .ssh(这两步两台机器都得做)
/usr/bin/ssh-keygen -t dsa(全部为空)
cd ~/.ssh
cat id_dsa.pub >> authorized_keys
scp authorized_keys 10.248.80.130:/home/xjxhy/.ssh/


--改变表的cache模式
Alter table szyy.cs_rec_change cache;
Alter table szyy.cs_rec_change nocache;

--配置自动ssh(输一次后当前会话可用)
exec /usr/bin/ssh-agent $SHELL
ssh-add /home/oracle/.ssh/id_rsa
xjshsnc2013

ssh-keygen -t rsa


--生成创建索引的脚本的方法

先用 exp rows=n TRIGGERS=n GRANTS=n owner=(属主列表) direct=y compress=n
的方法导出数据字典信息

然后，
imp show=y indexfile=/tmp/imp_index.sql file=/tmp/test_index.dmp buffer=3072000 full=y
来生成其创建索引的语句。

使用 vi 或 ultra edit 打开相应的文件，来进行所需的修改。如修改表空间名，拆分成多个脚本等。

执行时，
alter session force parallel ddl parallel 并行度;
然后，执行创建索引的脚本。
则其可并行创建索引

使用 expdp, impdp 生成创建索引的脚本的方法
imp.par 中：
directory=目录名
dumpfile=文件名
logfile=文件名
INCLUDE=INDEX
SQLFILE=脚本文件名
remap_tablespace=旧表空间:新表空间
注意不能使用parallel参数。对生成的文件，使用 vi 或 ultra edit 打开相应的文件, 将 PARALLEL 1 改为 parallel 相应的并行度。

示例：
exp.par:
userid='/ as sysdba'
directory=GEN_INDEX_DIR
dumpfile=exp_GZYY_TEST%u.dmp
content=METADATA_ONLY
logfile=exp_GZYY_TEST.log
parallel=4
tables=(
SZYY.BI_IMPCORP_DAY_DETAIL
)

imp.par
userid='/ as sysdba'
directory=GEN_INDEX_DIR
dumpfile=exp_GZYY_TEST01.dmp
logfile=imp_gzyy_test01.txt
INCLUDE=INDEX
SQLFILE=test_index.sql 
remap_tablespace=SZ_MLM_IND:TEST_SZ_MLM_IND

由于有 include=INDEX, 因而，生成的脚本中仅有创建索引的语句，若不写 include=INDEX, 则生成的脚本中包括建表，授权的语句等。


--改数据文件名字
alter database rename file '/oracle/products/gz_data/gz_comm_d10.dbf' to '/oracle/products/gz_data/gz_comm_d10new.dbf';

--shrink操作
ALTER TABLE XXZW.IB_CC_CREDITCHGREQ_TMP   SHRINK SPACE CASCADE;

--排除导出
userid=xj_exp_data/fred_2010
directory=MOVE_TEMP
schemas=COMMON
dumpfile=expcommon_cqdb_%U.dmp
logfile=expcommon_cqdb_.log
parallel=4
EXCLUDE=statistics,table:"in (
'CB_SP_MULTI_DETAIL',
'CB_SP_STATCHGNTFYREQ_HIS',
'SA_ADM_LOGDETAIL',
'PC_PROD_PRIVILEGE_HIS',
'SA_OPR_SESSION',
'CB_SP_BIZPROCREQITEM',
'CB_SP_BDREQ',
'CB_SP_STATCHGNTFYREQERR',
'CB_MUSIC_MUSICCLUB_OPR_BATCH',
'STATCHGNTFYREQ_ERRLOG',
'CB_SP_MULTI',
'PC_PROD_TELPATTERN_HIS',
'PC_PROD_SELECTTYPE_HIS',
'PC_PRIV_TELPATTERN',
'PC_PRIV_TELPATTERN_HIS',
'SA_DB_RIGHT_OPER_LOG_DETAIL',
'SA_ADM_LOG',
'PC_PRIV_RIGHT_HIS',
'PC_PROD_ORG_HIS',
'PC_PROD_RESOURCE_HIS',
'PC_PROD_RECEPTION_HIS',
'SA_SR_ROLERIGHT_HIS',
'SA_SR_ROLEFUNCTION_HIS',
'PC_PROD_PRIV_MEMBERCONFINE_HIS',
'PC_PRIV_RELATION_HIS',
'PC_PROD_CUSTTYPE_HIS',
'PC_PROD_CHANNEL_HIS',
'PC_PP_PRODUCT_HIS',
'PC_PROD_INCRMENT_HIS',
)"

--REMAP_TABLESPACE脚本生成
select distinct case when tablespace_name not like '%IND%' then 'REMAP_TABLESPACE '||tablespace_name||':YJ_DATA1' else 'REMAP_TABLESPACE '||tablespace_name||':YJ_INDX1' end from(
  select tablespace_name from dba_tab_partitions where TABLE_OWNER='${gg_user}' union 
  select tablespace_name from dba_tab_subpartitions where TABLE_OWNER='${gg_user}' union 
  select tablespace_name from dba_ind_partitions where INDEX_OWNER='${gg_user}' union 
  select tablespace_name from dba_ind_subpartitions where INDEX_OWNER='${gg_user}' union 
  select tablespace_name from dba_tables where OWNER='${gg_user}' union 
  select tablespace_name from dba_indexes where OWNER='${gg_user}' union 
  select tablespace_name from dba_segments where OWNER='${gg_user}'
)where tablespace_name is not null;

部分可以加上
 select name from sys.ts$;
 
 
 
 select distinct tablespace_name||':TBS_DATA1' from(
  select tablespace_name from dba_tab_partitions where TABLE_OWNER='STYY' union 
  select tablespace_name from dba_tab_subpartitions where TABLE_OWNER='STYY' union 
  select tablespace_name from dba_ind_partitions where INDEX_OWNER='STYY' union 
  select tablespace_name from dba_ind_subpartitions where INDEX_OWNER='STYY' union 
  select tablespace_name from dba_tables where OWNER='STYY' union 
  select tablespace_name from dba_indexes where OWNER='STYY' union 
  select tablespace_name from dba_segments where OWNER='STYY'  union 
  select name from sys.ts$ where name like '%ST%'
)where tablespace_name is not null;

 

--导出表结构
userid=xj_exp_data/fred_2010
directory=MOVE_TEMP
schemas=ZHYYHIS
dumpfile=exp_sb_zhyyhis.dmp
logfile=exp_sb_zhyy.log
EXCLUDE=statistics,grant
CONTENT=METADATA_ONLY

--传文件
10.243.42.25 shsnc2010 yzgmcc

--释放临时表空间
ALTER SESSION SET EVENTS 'IMMEDIATE TRACE NAME DROP_SEGMENTS LEVEL 104';

--值班时间 
select trunc(sysdate)-to_date('20100625','yyyymmdd') 值班时间,to_date('20110202','yyyymmdd')-trunc(sysdate) 春节 from dual;

--查找closed的lv
lsvg -o|awk '{print "lsvg -l "$1}'|sh|grep closed

--awk输出单引号
date|awk '{print " '\'' "}' 


define SOUERC="GZYYHIS"
define TARGET="ZHYYHIS"

--没有的表
select TABLE_NAME from dba_tables where owner='&SOUERC'
minus
select TABLE_NAME from dba_tables where owner='&TARGET';

--需要劈的分区
select '&TARGET'||'.'||a.TABLE_NAME,a.PARTITION_NAME,d.HIGH_VALUE from
  (select * from(
    select TABLE_NAME,PARTITION_NAME from dba_tab_partitions where TABLE_OWNER='&SOUERC'
    minus                                                                               
    select TABLE_NAME,PARTITION_NAME from dba_tab_partitions where TABLE_OWNER='&TARGET'
  )where TABLE_NAME not in
  (
    select TABLE_NAME from dba_tables where owner='&SOUERC'
    minus
    select TABLE_NAME from dba_tables where owner='&TARGET'
  )) a,
  dba_tab_partitions d
  where a.TABLE_NAME=d.TABLE_NAME and a.PARTITION_NAME=d.PARTITION_NAME and d.TABLE_OWNER='&SOUERC';
  

--后台脚本  
. ~/.profile
export ORACLE_SID=cqdb1
sqlplus / as sysdba <<EOF
set lin 200 pagesize 500
set long 99999 longc 99999
set echo on
set verify on
set serveroutput on
set trimspool OFF
set termout ON
set timing OFF
set trimout ON
set showmode OFF
set sqlblanklines OFF
set embedded on
set escape on

alter session set CURRENT_SCHEMA = $1;
ALTER SESSION FORCE PARALLEL QUERY PARALLEL 8;
ALTER SESSION FORCE PARALLEL DML PARALLEL 8;
spool zw_tuomin.log
----添加开发商脚本----



------开发商脚本结束------
spool off
exit
EOF


--分批导数
userid=xj_exp_data/fred_2010
directory=AUG_DUMP
schemas=szyy
dumpfile=exp_szyy_20101221_cqdb_3_%U.dmp
logfile=exp_szyy_20101221_cqdb_3.log
parallel=8
INCLUDE=TABLE:"IN (SELECT TABLE_NAME FROM xj_exp_data.CQ_TS where row_id between 801 and 2209)"

-- 输出换行
select 'aaaa'||chr(13)||chr(10)||'bbb' from dual;

--查询使用的undo条数
select t.USED_UBLK, t.USED_UREC from v$session s, v$transaction t where s.saddr=t.SES_ADDR and s.sid=6498;

--自动生成分区表
select '    PARTITION T_LJY_PART_'||to_char(rownum)||' VALUES LESS THAN ('||to_char(rownum)||'),' SQL  from dual connect by level <100;


--第二波答案
create bitmap index TEST.T_PART_BIT on TEST.T_PART (nvl(to_char(CDATE,'mmdd'),'NULL')) parallel 32;
create index TEST.T_PART_CDATE on TEST.T_PART (CDATE)  parallel 32;

select * 
from test.t_part
where (cdate >=to_date('2010-12-30','yyyy-mm-dd') and cdate<to_date('2010-12-31','yyyy-mm-dd'))
union 
select * from TEST.T_PART where nvl(to_char(CDATE,'mmdd'),'NULL')='NULL';


--快速统计表大小   
create bitmap index i on t_part(nvl2(type,1,2))nologging parallel 16;

--预估某空间剩余天数
sqlplus sys/gmcc368@lsdm as sysdba


set lin 200 pagesize 1000
set echo off
set verify off
set term off verify off feedback off
set trimout on
col 数据库名 for a10                                                                          
col 表空间名 for a16                                                                          
col 可用空间MB for 9999999                                                                    
col 使用率 for 99.99                                                                          
col 预计支持天数 for 9999999.99                                                               
col 日增量MB for 999999.99                                                                    
                                                                                              
select a.DB_NAME 数据库名,                                                                    
  a.TBS_NAME 表空间名,                                                                        
  a.SUM_MB 空间容量MB,
  a.FREE_MB 可用空间MB,                                                                       
  a.RATE 使用率,                                                                              
  b.AVG_INC 日增量MB,                                                                         
  a.FREE_MB/b.AVG_INC 预计支持天数                                                            
from cur_tbs_info a ,v_arc_tbs_inc_info b                                                     
where a.DB_NAME=b.DB_NAME(+) and a.TBS_NAME=b.TBS_NAME(+) and a.TBS_NAME in ('YJ_MIM_IND')
order by decode(a.DB_NAME,'GZDB',1,'SZDB',2,'DGDB',3,'FSDB',4,'STDB',5,'ZSDB',6,'REPORT',7,'CDR',8,9),7,5;



--杀LOCAL=NO进程
ps -ef|grep LOCAL=NO|awk '{print $2}'|xargs kill -9


 
 
 
     root 4583620       1   0   Aug 10      - 142:27 sh /home/oracle/watchauth.sh 
     
 /home/oracle/listener_check.sh     
oracle 4239422       1   0   Aug 10      - 151:34 sh /home/oracle/monitor_kksfbc.sh 

--数据量
select d.name 数据库名,a.GB 总容量,b.GB 数据量 ,c.GB 可用空间 from
  (select sum(GB) GB from
  (
    select sum(bytes)/1024/1024/1024 GB from dba_data_files union all
    select sum(BYTES*MEMBERS)/1024/1024/1024 GB from v$log union all         
    select sum(BYTES)/1024/1024/1024 GB from dba_temp_files
  )) a,
  (select sum(bytes)/1024/1024/1024 GB from dba_segments) b,
  (select sum(bytes)/1024/1024/1024 GB from dba_free_space where tablespace_name not in ('USERS','SYSTEM','TOOLS','TIVOLIORTS','SYSAUX') and tablespace_name not like '%HW_WH%' and  tablespace_name not like 'UNDO%' and  tablespace_name not like '%AUD%' and tablespace_name not like '%HIS%') c,
  v$database d;
  
--查锁
column event format a30  
column sess format a20
set linesize 150
break on id1 skip 1
select decode(request,0,'Holder:',' Waiter:') || s.inst_id || ':' || s.sid||','|| s.serial# sess,
      id1, id2, lmode, request, l.type, ctime, s.sql_id, s.event,s.last_call_et
  from gv$lock l, gv$session s
  where (id1, id2, l.type) in
    (select id1, id2, type from gv$lock where request>0
    )
   and l.sid=s.sid
   and l.inst_id=s.inst_id
  order by id1, ctime desc, request;
  
 SELECT      s1.inst_id ||':' || w.sid ||'.' || s1.serial#  wait_sid,
                 s1.SQL_ID    w_sql_id,              
                 s1.event,
                 s1.last_call_et last_et,
             s2.inst_id ||':' || h.sid ||'.' || s2.serial#  holder_sid,
                 s2.sql_id    ,
                 s2.event,
                 s2.last_call_et last_et
          FROM   gv$session S1,    gv$session S2,
                 gv$lock w,        gv$lock h
          WHERE
            (((h.LMODE != 0) and (h.LMODE != 1)
            and ((h.REQUEST = 0) or (h.REQUEST = 1)))
            and  (((w.LMODE= 1) or (w.LMODE = 0))
            and ((w.REQUEST != 1) and (w.REQUEST != 0))))
            and  w.type =  h.type
            and  w.id1  =  h.id1
            and  w.id2  =  h.id2
            and  w.sid     !=  h.sid
            and  w.sid       = S1.sid
            and  h.sid       = S2.sid
            and  S1.EVENT  ='enq: DX - contention'
            order by h.CTIME;

select decode(request,0,'Holder:',' Waiter:') || inst_id || ':' || sid sess,
      id1, id2, lmode, request, type, ctime
  from gv$lock
  where (id1, id2, type) in
    (select id1, id2, type from gv$lock where request>0
    )
  order by id1, ctime desc, request;
  
--修改profile
col PROFILE for a10
col LIMIT for a20
select PROFILE,RESOURCE_NAME,LIMIT from dba_profiles where RESOURCE_NAME='PASSWORD_LIFE_TIME' and PROFILE='DEFAULT';

alter profile DEFAULT LIMIT PASSWORD_LIFE_TIME 120;

--检查vg对应的硬盘？
lsvg -p rootvg

--aix取字符串某些段
echo $CITY_NAME|cut -c1-4




--sqlplus后一直没反应（实际上是已经登录成功，只不过没有输出而已！！）

$ sqlplus /nolog

SQL*Plus: Release 10.2.0.3.0 - Production on Fri Feb 11 18:04:38 2011

Copyright (c) 1982, 2006, Oracle.  All Rights Reserved.
经查为login.sql的问题
原文件为：
set pages 50000
set timing on
set trimout on 
set trimspool on
set space 0 
set colsep | 
set lines 100
set numwidth 20
set termout off
alter session set nls_date_format = 'yyyy-mm-dd hh24:mi:ss';
        column old_name new_value pname
        select '['||lower(user) || '@' ||instance_name||']'||'SQL>' old_name from v$INSTANCE;
        set sqlprompt '&pname '
store set mydefaultsetting
set termout on
预计在column old_name new_value pname前面加上下述项后就没问题了
define pname=[idle]SQL>


##if语法参考
CITY_NAME=SZYYHIS
XXYZ=`echo $CITY_NAME|cut -c1-4`
HIS=`echo $CITY_NAME|cut -c5-7`


if [ "$HIS" = "HIS" ];
then
 echo "#remap_schema="
else
 echo "remap_schema="$XXYZ":"$XXYZ"HIS"
fi












==============================================
统计历史EVENT等待事件直方图；
select * from v$event_histogram where event='latch free'

查看哪些SID锁表
select b.owner,b.object_name,a.SESSION_ID,a.ORACLE_USERNAME,a.LOCKED_MODE from v$locked_object a,dba_objects b where  a.object_id=b.object_id and a.object_id in
('436846','1072540','436846','1072535','436846','436846','1436520','443021','436846');

历史SESSION信息
DBA_HIST_ACTIVE_SESS_HISTORY

交换数据
alter table XXXX exchange partition XXXXX with table XXXXXX;


VG未划分存储用量 
lsvg -o |grep "_data"|xargs lsvg |grep "FREE PPs"|awk -F\( '{print $2}'|awk '{print $1}'|xargs|tr ' ' '+'|bc




增加子分区


alter table ipms.STS_HW_CELL_AGG_TEST add  PARTITION p20110803 
VALUES LESS THAN (TO_DATE(' 2011-08-04 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')) 
(
  SUBPARTITION "H2_R0"  VALUES (-2089824983)                                   
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R1"  VALUES (-1599349917)                                    
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R2"  VALUES (-1125282617)                                    
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R3"  VALUES (-594453696)                                     
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R4"  VALUES (-506001368)                                     
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R5"  VALUES (-435321011)                                     
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R6"  VALUES (-178654600)                                     
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R7"  VALUES (-169307475)                                     
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R8"  VALUES (349252210)                                      
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R9"  VALUES (362836539)                                      
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R10"  VALUES (609737586)                                     
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R11"  VALUES (617791944)                                     
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R12"  VALUES (792359234)                                     
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R13"  VALUES (879804769)                                     
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R14"  VALUES (1131194941)                                    
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R15"  VALUES (1264590310)                                    
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R16"  VALUES (1510006446)                                    
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R17"  VALUES (1819935571)                                    
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R18"  VALUES (1901071257)                                    
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R19"  VALUES (1954403854)                                    
  TABLESPACE "IPMS_TBS" NOCOMPRESS ,                                            
  SUBPARTITION "H2_R20"  VALUES (2141108882)                                    
  TABLESPACE "IPMS_TBS" NOCOMPRESS  );    
  

装机---  字符集
  NLS_LANG=AMERICAN_AMERICA.ZHS16GBK
  LANG="zh_CN.GBK"
  
  
--------latch : 热块分析  
  
查看哪些块可能存在频繁访问


select *
  from (select addr, child#, gets, sleeps
          from v$latch_children
         where name = 'cache buffers chains'
         order by sleeps desc)
 where rownum < 20;


ADDR	CHILD#	GETS	SLEEPS
000000006FEFE090	400	6474828	119
000000006FF79A08	1111	6471785	119
000000006FFE4B48	1727	6471477	114
000000006FFB6D08	1463	6171032	104
000000006FEF7F38	365	5342829	102
000000006FF06E68	451	6453376	102
000000006FFC48C0	1542	6472040	100
00000000703688A8	1981	6473876	99
000000006FEFAE80	382	6472450	97
000000006FED3198	153	6453933	95
000000006FF00FD8	417	6472250	94
0000000070365960	1964	6471178	94
000000007036EA00	2016	6455793	93
000000006FF02618	425	6456949	92
0000000070370308	2025	6471577	92
000000006FF4BE90	848	6471775	91
000000006FFEACA0	1762	6471337	91
000000006FF7CC18	1129	5229468	91
000000006FF78100	1102	6453081	91

当上表中sleeps 的值倾斜较大的时候（本文属于测试，所以不明显）。

根据TOP CSLEEPS 的addr 确定哪些块是热块


select hladdr,
       obj,
       (select object_name
          from dba_objects
         where (data_object_id is null and object_id = x.obj)
            or data_object_id = x.obj
           and rownum = 1) as object_name,
       dbarfil,
       dbablk,
       tch
  from x$bh x
 where hladdr in ('000000006FEFE090',
                  '000000006FF79A08',
                  '000000006FFE4B48',
                  '000000006FFB6D08',
                  '000000006FEF7F38',
                  '000000006FF06E68',
                  '000000006FFC48C0')
 order by hladdr, obj;

